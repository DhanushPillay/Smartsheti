<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Crop Suggestion - SmartSheti</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/plant-logo.svg" />
    <link rel="shortcut icon" type="image/svg+xml" href="../assets/images/plant-logo.svg" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="../js/maharashtra-locations.js"></script>
    <script src="../js/crop_images.js"></script>
    <script src="../js/crop_recommendation_engine.js"></script>
    <link rel="stylesheet" href="../css/crop-suggestion.css" />
    <link rel="stylesheet" href="../css/mobile-improvements.css" />
    <link rel="manifest" href="/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js');
            });
        }
    </script>
    <script src="../js/translations.js"></script>
    <script src="../js/install-app.js" defer></script>
</head>

<body class="font-sans page-loading" style="background-color: #EBE4DB !important;" data-page-name="crop-suggestion">
    <!-- Page Transition Overlay -->
    <div class="page-transition" id="pageTransition">
        <div class="loader">
            <span class="material-icons">agriculture</span>
            <div class="text">Loading SmartSheti...</div>
        </div>
    </div>

    <header class="shadow-sm" style="position: relative;">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../../index.html" class="brand-section" style="text-decoration: none;">
                <img src="../assets/images/plant-logo.svg" alt="SmartSheti Logo" class="w-12 h-12 mr-1.5" />
                <span class="text-2xl font-bold brand-text" data-no-translate="true">SmartSheti</span>
            </a>
            <nav class="hidden md:flex items-center space-x-4">
                <a class="nav-link text-gray-600 hover:text-green-600" href="../../index.html" data-page="home"
                    data-translate="home">Home</a>
                <a class="nav-link text-green-600 font-bold" href="crop-suggestion.html" data-page="crop-suggestion"
                    data-translate="cropSuggestion">Crop Suggestion</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="weather.html" data-page="weather"
                    data-translate="weather">Weather</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="marketplace.html" data-page="marketplace"
                    data-translate="marketplace">Marketplace</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="market-demand.html"
                    data-page="market-demand" data-translate="marketDemand">Market Demand</a>
            </nav>
            <div class="hidden md:flex items-center space-x-2 action-buttons">
                <!-- Download App Button -->
                <button id="installAppBtn"
                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-full text-sm font-medium transition-colors flex items-center shadow-sm">
                    <span class="material-icons text-sm mr-1">download</span>
                    <span data-translate="downloadApp">Download App</span>
                </button>
                <div class="relative">
                    <button id="translateBtn" class="flex items-center text-gray-600 hover:text-green-600"
                        title="Translate">
                        <span class="material-icons mr-1">translate</span>
                        <span id="currentLang" data-no-translate="true">EN</span>
                    </button>
                    <div id="languageDropdown"
                        class="hidden absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="en">English</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="hi">हिंदी</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="mr">मराठी</a>
                    </div>
                </div>
                <button class="text-gray-600 hover:text-green-600">
                    <span class="material-icons">notifications</span>
                </button>
                <div class="relative">
                    <button id="profileBtn" class="text-gray-600 hover:text-green-600">
                        <img alt="User avatar" class="h-8 w-8 rounded-full profile-img"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7" />
                    </button>
                    <div id="profileDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="profile">Profile</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="settings">Settings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="dashboard">Dashboard</a>
                        <hr class="my-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="logout">Logout</a>
                    </div>
                </div>
            </div>
            <button id="mobileMenuBtn" class="md:hidden text-gray-600 hover:text-green-600">
                <span class="material-icons">menu</span>
            </button>
        </div>
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t shadow-lg absolute w-full left-0 z-50"
            style="top: 100%;">
            <nav class="container mx-auto px-6 py-4 flex flex-col">
                <a class="mobile-nav-link" href="../../index.html" data-page="home">
                    <span class="material-icons text-gray-400 mr-3">home</span>
                    <span data-translate="home">Home</span>
                </a>
                <a class="mobile-nav-link active" href="crop-suggestion.html" data-page="crop-suggestion">
                    <span class="material-icons text-green-600 mr-3">grass</span>
                    <span data-translate="cropSuggestion">Crop Suggestion</span>
                </a>
                <a class="mobile-nav-link" href="weather.html" data-page="weather">
                    <span class="material-icons text-gray-400 mr-3">wb_sunny</span>
                    <span data-translate="weather">Weather</span>
                </a>
                <a class="mobile-nav-link" href="marketplace.html" data-page="marketplace">
                    <span class="material-icons text-gray-400 mr-3">storefront</span>
                    <span data-translate="marketplace">Marketplace</span>
                </a>
                <a class="mobile-nav-link" href="market-demand.html" data-page="market-demand">
                    <span class="material-icons text-gray-400 mr-3">trending_up</span>
                    <span data-translate="marketDemand">Market Demand</span>
                </a>
                <!-- Download App Button (Mobile) -->
                <div class="px-2 pb-2">
                    <button id="installAppBtnMobile"
                        class="w-full bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-lg font-medium hover:bg-green-200 transition-colors flex items-center justify-center">
                        <span class="material-icons mr-2">download</span>
                        <span data-translate="downloadApp">Download App</span>
                    </button>
                </div>
                <div class="border-t border-gray-100 my-2 pt-2"></div>
                <div class="flex items-center justify-between px-2 py-2">
                    <button id="translateBtnMobile"
                        class="flex items-center text-gray-600 hover:text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors"
                        title="Translate">
                        <span class="material-icons mr-2">translate</span>
                        <span id="currentLangMobile" data-no-translate="true" class="font-medium">EN</span>
                    </button>
                    <button
                        class="text-gray-600 hover:text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors">
                        <span class="material-icons">notifications</span>
                    </button>
                    <button id="profileBtnMobile"
                        class="text-gray-600 hover:text-green-600 p-1 rounded-full hover:bg-green-50 transition-colors border border-transparent hover:border-green-200">
                        <img alt="User avatar" class="h-8 w-8 rounded-full"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7" />
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <main class="page-content">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-4xl font-bold mb-8" data-translate="getCropSuggestions">Get Crop Suggestions</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <form>
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2" for="location"
                                data-translate="location">Location</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input
                                        class="w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-green-500"
                                        id="location"
                                        placeholder="Enter any location - city, village, street, lane, etc." type="text"
                                        data-translate-placeholder="enterLocation" />
                                    <span
                                        class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">location_on</span>
                                    <!-- Autocomplete dropdown -->
                                    <div id="locationSuggestions"
                                        class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto z-10">
                                    </div>
                                </div>
                                <button type="button" id="currentLocationBtn"
                                    class="px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center"
                                    title="Get My Exact Location">
                                    <span class="material-icons">my_location</span>
                                </button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2" for="soil-type" data-translate="soilType">Soil
                                Type</label>
                            <div class="relative">
                                <select
                                    class="w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg bg-white appearance-none focus:outline-none focus:ring-2 focus:ring-green-500"
                                    id="soil-type">
                                    <option value="" data-translate="selectSoilType">Select soil type</option>
                                    <option value="black-cotton" data-translate="blackCotton">Black Cotton Soil</option>
                                    <option value="red-lateritic" data-translate="redLateritic">Red Lateritic Soil
                                    </option>
                                    <option value="alluvial" data-translate="alluvial">Alluvial Soil</option>
                                    <option value="sandy-loam" data-translate="sandyLoam">Sandy Loam Soil</option>
                                    <option value="clay-loam" data-translate="clayLoam">Clay Loam Soil</option>
                                    <option value="well-drained-loamy" data-translate="wellDrainedLoamy">Well-drained
                                        Loamy Soil</option>
                                    <option value="deep-loamy" data-translate="deepLoamy">Deep Loamy Soil</option>
                                    <option value="forest-loam" data-translate="forestLoam">Forest Loam Soil</option>
                                    <option value="coastal-sandy" data-translate="coastalSandy">Coastal Sandy Soil
                                    </option>
                                </select>
                                <span
                                    class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">arrow_drop_down</span>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2" for="land-size" data-translate="landSize">Land Size
                                (in acres)</label>
                            <div class="relative">
                                <input
                                    class="w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-green-500"
                                    id="land-size" placeholder="Enter land size" type="number" step="0.1" min="0.1"
                                    max="1000" data-translate-placeholder="enterLandSize" />
                                <span
                                    class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">landscape</span>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 mb-2" for="irrigation-type"
                                data-translate="irrigationType">Irrigation Type</label>
                            <div class="relative">
                                <select
                                    class="w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg bg-white appearance-none focus:outline-none focus:ring-2 focus:ring-green-500"
                                    id="irrigation-type">
                                    <option value="" data-translate="selectIrrigationType">Select irrigation type
                                    </option>
                                    <option value="drip" data-translate="drip">Drip Irrigation</option>
                                    <option value="sprinkler" data-translate="sprinkler">Sprinkler Irrigation</option>
                                    <option value="flood" data-translate="flood">Flood Irrigation</option>
                                    <option value="furrow" data-translate="furrow">Furrow Irrigation</option>
                                    <option value="rain-fed" data-translate="rainFed">Rain-fed/No Irrigation</option>
                                    <option value="canal" data-translate="canal">Canal Irrigation</option>
                                    <option value="well" data-translate="well">Well/Borewell Irrigation</option>
                                </select>
                                <span
                                    class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">arrow_drop_down</span>
                            </div>
                        </div>
                        <button
                            class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors"
                            type="submit" data-translate="getSuggestions">Get Suggestions</button>
                        <div class="mt-3">
                            <button
                                class="w-full bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors"
                                type="button" onclick="clearForm()" data-translate="clear">Clear Form</button>
                        </div>
                    </form>
                </div>
                <div class="rounded-lg overflow-hidden">
                    <div id="map" class="w-full h-96"></div>
                </div>
            </div>
            <div class="mt-12">
                <h2 class="text-3xl font-bold mb-8" data-translate="suggestedCrops">Suggested Crops</h2>
                <div id="crop-suggestions-container" class="space-y-8">
                    <div class="text-center text-gray-500 py-8">
                        <span class="material-icons text-6xl mb-4">agriculture</span>
                        <p data-translate="fillFormMessage">Please fill out the form above to get personalized crop
                            suggestions based on your location, soil type, land size, and irrigation method.</p>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <script>
        // Header functionality
        document.addEventListener('DOMContentLoaded', function () {
            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mobileMenu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            }

            // Profile dropdown
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }

            // Mobile profile dropdown
            const profileBtnMobile = document.getElementById('profileBtnMobile');
            if (profileBtnMobile && profileDropdown) {
                profileBtnMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
            }
        });
    </script>
    <script>
        // Page Transition Functions - Sliding Effect
        function showPageTransition() {
            const transition = document.getElementById('pageTransition');
            document.body.classList.add('page-loading');

            // Start exit animation for current page
            document.body.classList.add('page-exiting');

            // Show transition overlay after a brief delay
            setTimeout(() => {
                transition.classList.add('active');
            }, 100);
        }

        function hidePageTransition() {
            const transition = document.getElementById('pageTransition');
            const header = document.querySelector('header');
            const content = document.querySelector('.page-content');

            // Remove loading and exiting classes
            document.body.classList.remove('page-loading', 'page-exiting');

            // Start slide-in animations
            setTimeout(() => {
                if (header) header.classList.add('loaded');
                if (content) content.classList.add('loaded');

                // Hide transition overlay after content starts sliding in
                setTimeout(() => {
                    if (transition) transition.classList.remove('active');
                }, 300);
            }, 100);
        }

        // Enhanced navigation with smooth slide transitions
        function navigateToPage(url, pageName) {
            showPageTransition();

            // Update loader text
            const loaderText = document.querySelector('.page-transition .text');
            loaderText.textContent = `Loading ${pageName}...`;

            // Navigate after transition animation starts
            setTimeout(() => {
                window.location.href = url;
            }, 600); // Wait for slide animation to complete
        }

        // Add smooth transition to navigation links
        function setupSmoothNavigation() {
            const navLinks = document.querySelectorAll('nav a, .page-nav-link');

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    const pageName = this.textContent.trim();

                    // Don't transition for hash links or external links
                    if (href.startsWith('#') || href.startsWith('http') || href === window.location.pathname) {
                        return;
                    }

                    navigateToPage(href, pageName);
                });
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Setup smooth navigation
            setupSmoothNavigation();

            // Hide page transition and show content
            hidePageTransition();

            // Initialize map with Maharashtra center
            var map = L.map('map').setView([19.7515, 75.7139], 7);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add a simple draggable marker
            const marker = L.marker([19.7515, 75.7139], {
                draggable: true
            }).addTo(map);

            // Update location input when marker is dragged
            marker.on('dragend', function () {
                const position = marker.getLatLng();
                const lat = position.lat;
                const lng = position.lng;

                // Use detailed reverse geocoding for dragged location
                reverseGeocodeDetailed(lat, lng);
            });

            // Add map click functionality to set location
            map.on('click', function (e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                // Move marker to clicked position
                marker.setLatLng([lat, lng]);

                // Use detailed reverse geocoding for clicked location
                reverseGeocodeDetailed(lat, lng);

                // Optional: Add visual feedback
                const clickMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: '#10B981',
                    color: '#059669',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map);

                // Remove the click marker after 2 seconds
                setTimeout(() => {
                    map.removeLayer(clickMarker);
                }, 2000);
            });

            // Update marker position when location is entered
            document.getElementById('location').addEventListener('change', function () {
                const input = this.value.trim();

                // Check if input is coordinates (lat, lng format)
                const coords = input.split(',').map(Number);
                if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                    marker.setLatLng(coords);
                    map.setView(coords, 12);
                } else if (input) {
                    // Search for location name using geocoding
                    searchLocation(input);
                }

                // Hide suggestions when selection is made
                hideSuggestions();
            });

            // Add autocomplete functionality for location input
            document.getElementById('location').addEventListener('input', function () {
                const input = this.value.trim();
                if (input.length >= 2) {
                    showLocationSuggestions(input);
                } else {
                    hideSuggestions();
                }
            });

            // Handle keyboard navigation for suggestions
            document.getElementById('location').addEventListener('keydown', function (e) {
                const suggestions = document.getElementById('locationSuggestions');
                const items = suggestions.querySelectorAll('.suggestion-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateSuggestions(items, 1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateSuggestions(items, -1);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    const activeItem = suggestions.querySelector('.suggestion-item.active');
                    if (activeItem) {
                        selectSuggestion(activeItem);
                    } else {
                        this.blur(); // Trigger change event
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function (e) {
                if (!e.target.closest('#location') && !e.target.closest('#locationSuggestions')) {
                    hideSuggestions();
                }
            });

            // Function to show location suggestions
            function showLocationSuggestions(input) {
                if (!window.MaharashtraLocationSearch) {
                    return;
                }

                const suggestions = window.MaharashtraLocationSearch.getSuggestions(input, 8);
                const suggestionsDiv = document.getElementById('locationSuggestions');

                if (suggestions.length === 0) {
                    hideSuggestions();
                    return;
                }

                let html = '';
                suggestions.forEach((suggestion, index) => {
                    html += `
                <div class="suggestion-item px-4 py-2 hover:bg-gray-100 cursor-pointer border-b last:border-b-0 ${index === 0 ? 'active' : ''}" 
                     data-name="${suggestion.name}" 
                     data-lat="${suggestion.lat}" 
                     data-lng="${suggestion.lng}"
                     data-district="${suggestion.district}"
                     data-type="${suggestion.type}">
                    <div class="font-medium">${suggestion.name}</div>
                    <div class="text-sm text-gray-600">${suggestion.district} District • ${suggestion.type}</div>
                </div>
            `;
                });

                suggestionsDiv.innerHTML = html;
                suggestionsDiv.classList.remove('hidden');

                // Add click handlers to suggestion items
                suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => selectSuggestion(item));
                    item.addEventListener('mouseenter', () => {
                        suggestionsDiv.querySelectorAll('.suggestion-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                    });
                });
            }

            // Function to hide suggestions
            function hideSuggestions() {
                document.getElementById('locationSuggestions').classList.add('hidden');
            }

            // Function to navigate suggestions with keyboard
            function navigateSuggestions(items, direction) {
                if (items.length === 0) return;

                const currentActive = document.querySelector('.suggestion-item.active');
                let newIndex = 0;

                if (currentActive) {
                    const currentIndex = Array.from(items).indexOf(currentActive);
                    newIndex = currentIndex + direction;
                }

                // Wrap around
                if (newIndex < 0) newIndex = items.length - 1;
                if (newIndex >= items.length) newIndex = 0;

                // Remove active class from all items
                items.forEach(item => item.classList.remove('active'));

                // Add active class to new item
                items[newIndex].classList.add('active');

                // Scroll into view
                items[newIndex].scrollIntoView({ block: 'nearest' });
            }

            // Function to select a suggestion
            function selectSuggestion(item) {
                const name = item.dataset.name;
                const lat = parseFloat(item.dataset.lat);
                const lng = parseFloat(item.dataset.lng);
                const district = item.dataset.district;
                const type = item.dataset.type;

                updateMapWithLocation(lat, lng, `${name} (${district} District, ${type})`);
                hideSuggestions();
            }

            // Also listen for Enter key press for immediate search
            document.getElementById('location').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur(); // Trigger change event
                }
            });

            // Enhanced search function using external Maharashtra database
            function searchMaharashtraLocation(locationName) {
                if (!window.MaharashtraLocationSearch || !window.maharashtraLocations) {
                    console.error('Maharashtra locations database not loaded');
                    return false;
                }

                const searchTerm = locationName.toLowerCase().trim();

                // Try exact match first
                let result = window.MaharashtraLocationSearch.findExact(searchTerm);
                if (result) {
                    updateMapWithLocation(result.lat, result.lng, `${locationName} (${result.district} District, ${result.type})`);
                    return true;
                }

                // Try partial matches
                const partialMatches = window.MaharashtraLocationSearch.findPartial(searchTerm);
                if (partialMatches.length > 0) {
                    const bestMatch = partialMatches[0];
                    updateMapWithLocation(bestMatch.lat, bestMatch.lng, `${bestMatch.name} (${bestMatch.district} District, ${bestMatch.type})`);
                    return true;
                }

                // Try district search
                const districtMatches = window.MaharashtraLocationSearch.findByDistrict(searchTerm);
                if (districtMatches.length > 0) {
                    const match = districtMatches[0];
                    updateMapWithLocation(match.lat, match.lng, `${match.name} (${match.district} District, ${match.type})`);
                    return true;
                }

                return false; // No match found
            }

            // Function to update map with precise location
            function updateMapWithLocation(lat, lng, description) {
                marker.setLatLng([lat, lng]);

                // Set zoom level based on location type
                let zoomLevel = 14; // Default for most locations
                if (description.includes('street') || description.includes('road')) {
                    zoomLevel = 16; // Closer zoom for streets
                } else if (description.includes('locality')) {
                    zoomLevel = 15; // Medium zoom for localities
                } else if (description.includes('city')) {
                    zoomLevel = 12; // Wider zoom for cities
                }

                map.setView([lat, lng], zoomLevel);

                // Add a precision indicator for Maharashtra database locations
                if (window.accuracyCircle) {
                    map.removeLayer(window.accuracyCircle);
                }
                window.accuracyCircle = L.circle([lat, lng], {
                    color: 'orange',
                    fillColor: '#orange',
                    fillOpacity: 0.1,
                    radius: 100 // 100m accuracy for database locations
                }).addTo(map);

                document.getElementById('location').value = `${lat.toFixed(7)}, ${lng.toFixed(7)} (${description})`;

                // Add weather information to the location
                const locationName = description.split(' (')[0]; // Extract location name without district info
                addWeatherToMarker(lat, lng, locationName);
            }

            // Function to search Maharashtra locations database
            function searchLocation(locationName) {
                // First, try to find in Maharashtra locations database for precise agricultural areas
                if (searchMaharashtraLocation(locationName)) {
                    return; // Found in Maharashtra database, no need for online search
                }

                // If not found in Maharashtra database, use online geocoding
                // Enhanced geocoding URL for more detailed search including villages, streets, lanes etc.
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&limit=3&addressdetails=1&extratags=1`;

                fetch(geocodeUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            // Use the first result with the highest importance/relevance
                            const bestResult = data[0];
                            const lat = parseFloat(bestResult.lat);
                            const lng = parseFloat(bestResult.lon);
                            const displayName = bestResult.display_name;
                            const address = bestResult.address || {};

                            // Create a more detailed location description
                            let locationDescription = '';
                            if (address.road || address.street) {
                                locationDescription = address.road || address.street;
                            } else if (address.village) {
                                locationDescription = address.village;
                            } else if (address.suburb || address.neighbourhood) {
                                locationDescription = address.suburb || address.neighbourhood;
                            } else if (address.city || address.town) {
                                locationDescription = address.city || address.town;
                            } else {
                                locationDescription = displayName.split(',')[0];
                            }

                            // Update marker position
                            marker.setLatLng([lat, lng]);

                            // Set appropriate zoom level based on location type
                            let zoomLevel = 15; // Default for streets/specific locations
                            if (address.village) zoomLevel = 14;
                            else if (address.city || address.town) zoomLevel = 12;
                            else if (address.state) zoomLevel = 10;

                            map.setView([lat, lng], zoomLevel);

                            // Update input with formatted coordinates and location name
                            document.getElementById('location').value = `${lat.toFixed(6)}, ${lng.toFixed(6)} (${locationDescription})`;

                            // Add weather information to the searched location
                            addWeatherToMarker(lat, lng, locationDescription);
                        } else {
                            alert('Location not found. Please try a different search term or enter coordinates manually.');
                        }
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        alert('Error searching for location. Please try again or enter coordinates manually.');
                    });
            }

            // Function to get current location using GPS with high accuracy
            function getCurrentLocation() {
                const btn = document.getElementById('currentLocationBtn');
                const locationInput = document.getElementById('location');

                // Show loading state
                btn.disabled = true;
                // btn.innerHTML = '<span class="material-icons animate-spin">gps_searching</span>';
                btn.title = 'Getting your exact location...';

                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by this browser.');
                    resetLocationButton();
                    return;
                }

                console.log('Starting high-accuracy geolocation...');

                // First, try a quick location to show something immediately
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        console.log('Quick location found:', position.coords);
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;

                        // Update map immediately with quick result
                        marker.setLatLng([lat, lng]);
                        map.setView([lat, lng], 15);

                        // Add accuracy circle
                        if (window.accuracyCircle) {
                            map.removeLayer(window.accuracyCircle);
                        }
                        window.accuracyCircle = L.circle([lat, lng], {
                            color: accuracy <= 50 ? 'green' : 'orange',
                            fillColor: accuracy <= 50 ? '#green' : '#orange',
                            fillOpacity: 0.15,
                            radius: accuracy
                        }).addTo(map);

                        // Get detailed address
                        reverseGeocodeDetailed(lat, lng, accuracy);

                        // If quick location is already very good, don't need high accuracy attempts
                        if (accuracy <= 15) {
                            resetLocationButton();
                            console.log('Quick location is already very accurate:', accuracy + 'm');
                        } else {
                            // Now try for better accuracy
                            attemptHighAccuracyLocation(lat, lng, accuracy);
                        }
                    },
                    function (error) {
                        console.log('Quick location failed, trying high accuracy directly');
                        attemptHighAccuracyLocation();
                    },
                    {
                        enableHighAccuracy: false, // Quick result first
                        timeout: 8000, // Increased timeout for quick location
                        maximumAge: 60000 // 1 minute cache OK for quick result
                    }
                );

                function attemptHighAccuracyLocation(fallbackLat = null, fallbackLng = null, fallbackAccuracy = null) {
                    let bestAccuracy = fallbackAccuracy || Infinity;
                    let attempts = 0;
                    const maxAttempts = 3;

                    function tryPreciseLocation() {
                        attempts++;
                        console.log(`High-accuracy attempt ${attempts}/${maxAttempts}`);

                        navigator.geolocation.getCurrentPosition(
                            function (position) {
                                console.log(`Attempt ${attempts} - Accuracy: ${position.coords.accuracy}m`);
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                const accuracy = position.coords.accuracy;

                                // Only update if significantly better accuracy
                                if (accuracy < bestAccuracy * 0.8) {
                                    bestAccuracy = accuracy;

                                    // Update marker and map
                                    marker.setLatLng([lat, lng]);

                                    // Set zoom level for precise location
                                    let zoomLevel = 18; // Default high zoom for exact location
                                    if (accuracy <= 5) zoomLevel = 19; // Street number level
                                    else if (accuracy <= 10) zoomLevel = 18; // Building level
                                    else if (accuracy <= 20) zoomLevel = 17; // Street level
                                    else if (accuracy <= 50) zoomLevel = 16; // Block level
                                    else zoomLevel = 15; // Area level

                                    map.setView([lat, lng], zoomLevel);

                                    // Update accuracy circle
                                    if (window.accuracyCircle) {
                                        map.removeLayer(window.accuracyCircle);
                                    }
                                    window.accuracyCircle = L.circle([lat, lng], {
                                        color: 'green',
                                        fillColor: '#green',
                                        fillOpacity: 0.15,
                                        radius: accuracy
                                    }).addTo(map);

                                    // Get detailed address
                                    reverseGeocodeDetailed(lat, lng, accuracy);
                                }

                                // Continue trying for better accuracy if not very precise yet
                                if (accuracy > 10 && attempts < maxAttempts) {
                                    setTimeout(tryPreciseLocation, 2000); // Wait 2 seconds between attempts
                                } else {
                                    // Finished getting location
                                    resetLocationButton();

                                    // Show success message based on accuracy
                                    if (accuracy <= 10) {
                                        console.log('High accuracy GPS location obtained:', accuracy + 'm');
                                    } else if (accuracy <= 50) {
                                        console.log('Good GPS location obtained:', accuracy + 'm');
                                    }
                                }
                            },
                            function (error) {
                                console.error(`High-accuracy attempt ${attempts} failed:`, error);

                                // If this attempt failed, try again or show error
                                if (attempts < maxAttempts && error.code !== error.PERMISSION_DENIED) {
                                    setTimeout(tryPreciseLocation, 1500); // Shorter wait for retries
                                } else {
                                    // All attempts failed or permission denied
                                    if (fallbackLat && fallbackLng) {
                                        // We have a fallback location, use that
                                        resetLocationButton();
                                        console.log('Using fallback location from quick GPS');
                                    } else {
                                        // No fallback, handle error
                                        handleLocationError(error);
                                    }
                                }
                            },
                            {
                                enableHighAccuracy: true, // Use GPS for best accuracy
                                timeout: 10000, // 10 second timeout per attempt (reduced from 15)
                                maximumAge: 0 // Always get fresh location
                            }
                        );
                    }

                    // Start high accuracy attempts
                    tryPreciseLocation();
                }
            }

            // Function to handle location errors with fallbacks
            function handleLocationError(error) {
                console.error('Geolocation error:', error);
                let errorMessage = 'Unable to get your exact location. ';

                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Please allow location access in your browser and try again. Click the location icon in your address bar if needed.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'GPS is not available. Please check if location services are enabled on your device.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out. Please try again or check your GPS signal.';
                        break;
                    default:
                        errorMessage += 'Please try entering your location manually.';
                        break;
                }

                // Try IP-based location as final fallback
                console.log('Trying IP-based location as fallback...');
                tryIPLocation()
                    .then(() => {
                        resetLocationButton();
                        // Only show alert for actual GPS permission issues, not timeouts
                        if (error.code === error.PERMISSION_DENIED) {
                            alert('Used approximate location based on your internet connection. For exact location, please allow GPS access and try again.');
                        }
                    })
                    .catch(() => {
                        alert(errorMessage);
                        resetLocationButton();
                    });
            }

            // Function to try IP-based location as fallback
            async function tryIPLocation() {
                try {
                    console.log('Attempting IP-based location...');
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();

                    if (data.latitude && data.longitude) {
                        console.log('IP location found:', data);
                        const lat = data.latitude;
                        const lng = data.longitude;

                        // Update marker and map
                        marker.setLatLng([lat, lng]);
                        map.setView([lat, lng], 12);

                        // Create location description from IP data
                        let locationDescription = 'Approximate Location';
                        if (data.city) {
                            locationDescription = data.city;
                            if (data.region) {
                                locationDescription += ', ' + data.region;
                            }
                        }

                        // Update input field
                        document.getElementById('location').value = `${lat.toFixed(6)}, ${lng.toFixed(6)} (${locationDescription})`;

                        return Promise.resolve();
                    } else {
                        throw new Error('No location data from IP service');
                    }
                } catch (error) {
                    console.error('IP location failed:', error);
                    return Promise.reject(error);
                }
            }

            // Enhanced function to reverse geocode coordinates to get detailed address
            function reverseGeocodeDetailed(lat, lng, accuracy = null) {
                console.log('Getting detailed address for:', lat, lng);

                // Use multiple zoom levels to get the most detailed address possible
                const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&zoom=18&extratags=1`;

                fetch(reverseUrl)
                    .then(response => response.json())
                    .then(data => {
                        let locationDescription = 'Current Location';
                        let addressParts = [];

                        if (data && data.address) {
                            const address = data.address;
                            console.log('Detailed address data:', address);

                            // Build detailed address hierarchy from most specific to general
                            if (address.house_number && address.road) {
                                // Street address with house number
                                addressParts.push(`${address.house_number} ${address.road}`);
                            } else if (address.road || address.street) {
                                // Street name only
                                addressParts.push(address.road || address.street);
                            } else if (address.footway || address.path || address.pedestrian) {
                                // Footways, paths
                                addressParts.push(address.footway || address.path || address.pedestrian);
                            }

                            // Add locality information
                            if (address.suburb || address.neighbourhood || address.residential) {
                                addressParts.push(address.suburb || address.neighbourhood || address.residential);
                            } else if (address.hamlet || address.locality) {
                                addressParts.push(address.hamlet || address.locality);
                            }

                            // Add village/town/city
                            if (address.village) {
                                addressParts.push(address.village);
                            } else if (address.town) {
                                addressParts.push(address.town);
                            } else if (address.city) {
                                addressParts.push(address.city);
                            } else if (address.municipality) {
                                addressParts.push(address.municipality);
                            }

                            // Add district/county if available
                            if (address.county || address.district) {
                                addressParts.push(address.county || address.district);
                            }

                            // Add state
                            if (address.state) {
                                addressParts.push(address.state);
                            }

                            // Create final description from the most specific available parts
                            if (addressParts.length > 0) {
                                // Use up to 3 most specific parts for display
                                locationDescription = addressParts.slice(0, 3).join(', ');
                            } else if (data.display_name) {
                                // Fallback to display name if address parsing fails
                                const parts = data.display_name.split(',').slice(0, 3);
                                locationDescription = parts.join(', ').trim();
                            }
                        }

                        // Add accuracy information if GPS was used
                        let accuracyText = '';
                        if (accuracy !== null) {
                            if (accuracy <= 3) accuracyText = ' (Exact ±3m)';
                            else if (accuracy <= 5) accuracyText = ' (Very precise ±5m)';
                            else if (accuracy <= 10) accuracyText = ` (Precise ±${Math.round(accuracy)}m)`;
                            else if (accuracy <= 20) accuracyText = ` (Good ±${Math.round(accuracy)}m)`;
                            else if (accuracy <= 50) accuracyText = ` (±${Math.round(accuracy)}m)`;
                            else if (accuracy <= 100) accuracyText = ` (±${Math.round(accuracy)}m)`;
                            else accuracyText = ` (±${Math.round(accuracy / 100) / 10}km)`;
                        }

                        // Update input field with detailed location
                        const finalLocation = `${lat.toFixed(7)}, ${lng.toFixed(7)} (${locationDescription}${accuracyText})`;
                        document.getElementById('location').value = finalLocation;

                        // Add weather information to marker
                        addWeatherToMarker(lat, lng, locationDescription);

                        console.log('Final location description:', finalLocation);
                    })
                    .catch(error => {
                        console.error('Detailed reverse geocoding error:', error);

                        // Fallback to basic coordinates with accuracy
                        let accuracyText = accuracy ? ` (±${Math.round(accuracy)}m)` : '';
                        const fallbackLocation = `${lat.toFixed(7)}, ${lng.toFixed(7)} (Exact Location${accuracyText})`;
                        document.getElementById('location').value = fallbackLocation;

                        // Still try to add weather even with basic location
                        addWeatherToMarker(lat, lng, 'Current Location');
                    });
            }

            // Function to fetch weather data and add to marker
            async function addWeatherToMarker(lat, lng, locationName) {
                try {
                    console.log('Fetching weather for:', lat, lng, locationName);

                    // Extract city name from location for weather fetching
                    const cityName = extractCityFromLocation(locationName);
                    console.log('Using city for weather:', cityName);

                    // Show loading popup first with location info
                    const loadingContent = `
                <div class="weather-popup loading">
                    <div class="location-header">
                        <span class="material-icons">location_on</span>
                        ${locationName}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <span class="material-icons animate-spin">refresh</span>
                    </div>
                    <div style="font-size: 16px;">Fetching weather for ${cityName}...</div>
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Please wait</div>
                </div>
            `;
                    marker.bindPopup(loadingContent).openPopup();

                    // Try to fetch weather data using wttr.in (free service, no API key needed)
                    let weatherData = null;

                    // First try: Use wttr.in weather service (no API key required)
                    try {
                        const wttrUrl = `https://wttr.in/${encodeURIComponent(cityName)}?format=j1`;
                        console.log('Trying wttr.in weather API:', wttrUrl);

                        const response = await fetch(wttrUrl);
                        if (response.ok) {
                            const data = await response.json();
                            console.log('wttr.in weather data:', data);

                            if (data.current_condition && data.current_condition[0]) {
                                const current = data.current_condition[0];
                                weatherData = {
                                    name: cityName,
                                    main: {
                                        temp: parseFloat(current.temp_C),
                                        feels_like: parseFloat(current.FeelsLikeC),
                                        temp_min: parseFloat(current.temp_C) - 3, // Approximate
                                        temp_max: parseFloat(current.temp_C) + 3, // Approximate
                                        humidity: parseFloat(current.humidity),
                                        pressure: parseFloat(current.pressure) || 1013
                                    },
                                    weather: [{
                                        main: current.weatherCode === '113' ? 'Clear' :
                                            current.weatherCode === '116' ? 'Clouds' :
                                                current.weatherCode === '119' || current.weatherCode === '122' ? 'Clouds' :
                                                    current.weatherDesc[0].value.toLowerCase().includes('rain') ? 'Rain' :
                                                        current.weatherDesc[0].value.toLowerCase().includes('thunder') ? 'Thunderstorm' : 'Clear',
                                        description: current.weatherDesc[0].value,
                                        icon: current.weatherCode
                                    }],
                                    wind: {
                                        speed: parseFloat(current.windspeedKmph) / 3.6 // Convert to m/s
                                    },
                                    visibility: parseFloat(current.visibility) * 1000, // Convert to meters
                                    sys: { country: 'IN' }
                                };
                                console.log('Weather data processed successfully');
                            }
                        }
                    } catch (error) {
                        console.log('wttr.in weather fetch failed:', error);
                    }

                    // Fallback: Generate mock weather data based on location and season
                    if (!weatherData) {
                        console.log('Using mock weather data for', locationName);
                        weatherData = generateMockWeatherData(lat, lng, cityName);
                    }

                    if (weatherData) {
                        console.log('Weather data received for', locationName, ':', weatherData);

                        // Store weather data globally for crop recommendations
                        window.currentWeatherData = {
                            temperature: Math.round(weatherData.main.temp),
                            location: locationName,
                            timestamp: new Date()
                        };
                        console.log('Stored weather data for recommendations:', window.currentWeatherData);

                        // Use the weather API's location name as primary, fallback to our city name
                        const weatherLocationName = weatherData.name || cityName || locationName;
                        const countryCode = weatherData.sys?.country || 'IN';
                        const fullLocationName = `${weatherLocationName}, ${countryCode}`;

                        const temperature = Math.round(weatherData.main.temp);
                        const description = weatherData.weather[0].description;
                        const humidity = weatherData.main.humidity;
                        const pressure = weatherData.main.pressure;
                        const windSpeed = weatherData.wind ? Math.round(weatherData.wind.speed * 3.6) : 10; // Convert m/s to km/h
                        const feelsLike = Math.round(weatherData.main.feels_like);
                        const weatherIcon = getWeatherIcon(weatherData.weather[0].main, weatherData.weather[0].icon);
                        const minTemp = Math.round(weatherData.main.temp_min);
                        const maxTemp = Math.round(weatherData.main.temp_max);

                        // Determine weather-based theme
                        const weatherMain = weatherData.weather[0].main.toLowerCase();
                        const themeClass = ['clear', 'clouds', 'rain', 'thunderstorm'].includes(weatherMain) ? weatherMain : '';

                        const weatherContent = `
                    <div class="weather-popup ${themeClass}">
                        <div class="location-header">
                            <span class="material-icons">location_on</span>
                            Weather in ${fullLocationName}
                        </div>
                        <div class="weather-main">
                            <div>
                                <div class="temp">${temperature}°C</div>
                                <div class="feels-like">Feels like ${feelsLike}°C</div>
                                <div class="temp-range">H: ${maxTemp}° L: ${minTemp}°</div>
                            </div>
                            <div class="weather-icon">${weatherIcon}</div>
                        </div>
                        <div class="description">${description}</div>
                        <div class="details">
                            <div class="detail-item">
                                <span class="material-icons" style="font-size: 18px;">water_drop</span>
                                <span>Humidity<br>${humidity}%</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-icons" style="font-size: 18px;">air</span>
                                <span>Wind<br>${windSpeed} km/h</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-icons" style="font-size: 18px;">compress</span>
                                <span>Pressure<br>${pressure} hPa</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-icons" style="font-size: 18px;">visibility</span>
                                <span>Visibility<br>${weatherData.visibility ? (weatherData.visibility / 1000).toFixed(1) + ' km' : 'N/A'}</span>
                            </div>
                        </div>
                        <div class="footer">
                            <span class="material-icons" style="font-size: 12px; vertical-align: middle;">schedule</span>
                            Last updated: ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                `;

                        marker.bindPopup(weatherContent).openPopup();

                    } else {
                        throw new Error(`Weather data not available for ${locationName}`);
                    }

                } catch (error) {
                    console.error('Weather fetch error for', locationName, ':', error);

                    // Show error popup with specific location
                    const errorContent = `
                <div class="weather-popup error">
                    <div class="location-header" style="color: #2d3436;">
                        <span class="material-icons">location_on</span>
                        ${locationName}
                    </div>
                    <div style="margin: 20px 0 15px 0;">
                        <span class="material-icons" style="font-size: 48px; color: #e17055;">cloud_off</span>
                    </div>
                    <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">Weather Unavailable</div>
                    <div style="font-size: 14px; opacity: 0.8; line-height: 1.4;">
                        Unable to fetch weather data for this location. This might be due to network issues or the location being too remote.
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 12px;">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
                        Try selecting a nearby major city or check your internet connection
                    </div>
                </div>
            `;
                    marker.bindPopup(errorContent).openPopup();
                }
            }

            // Function to extract city name from location string
            function extractCityFromLocation(locationName) {
                console.log('Extracting city from location:', locationName);

                // Common Maharashtra cities for weather lookup
                const maharashtraCities = [
                    'Mumbai', 'Pune', 'Nagpur', 'Nashik', 'Aurangabad', 'Solapur', 'Amravati', 'Kolhapur',
                    'Sangli', 'Malegaon', 'Jalgaon', 'Akola', 'Latur', 'Dhule', 'Ahmednagar', 'Chandrapur',
                    'Parbhani', 'Ichalkaranji', 'Jalna', 'Ambajogai', 'Bhusawal', 'Panvel', 'Badlapur',
                    'Beed', 'Gondia', 'Satara', 'Barshi', 'Yavatmal', 'Achalpur', 'Osmanabad', 'Nandurbar',
                    'Wardha', 'Udgir', 'Hinganghat', 'Karad', 'Lonavala', 'Talegaon Dabhade', 'Malkapur',
                    'Washim', 'Hingoli', 'Uran', 'Pen', 'Khopoli', 'Wai', 'Alibag', 'Chiplun', 'Ratnagiri',
                    'Miraj', 'Khardi', 'Shrirampur', 'Thane', 'Kalyan', 'Vasai', 'Virar', 'Mira Bhayandar',
                    'Ulhasnagar', 'Ambernath', 'Raigad', 'Shirdi'
                ];

                const location = locationName.toLowerCase().trim();

                // First, try to extract city from comma-separated location string
                const locationParts = location.split(',').map(part => part.trim());
                console.log('Location parts:', locationParts);

                // Check each part of the location for city names
                for (const part of locationParts) {
                    for (const city of maharashtraCities) {
                        if (part === city.toLowerCase() || part.includes(city.toLowerCase())) {
                            console.log('Found city match:', city);
                            return city;
                        }
                    }
                }

                // Check if the full location directly contains a major city name
                for (const city of maharashtraCities) {
                    if (location.includes(city.toLowerCase())) {
                        console.log('Found city in full location:', city);
                        return city;
                    }
                }

                // Check for specific patterns and aliases
                if (location.includes('mumbai') || location.includes('bombay')) {
                    console.log('Found Mumbai pattern');
                    return 'Mumbai';
                }
                if (location.includes('pune') || location.includes('poona')) {
                    console.log('Found Pune pattern');
                    return 'Pune';
                }
                if (location.includes('nagpur')) {
                    console.log('Found Nagpur pattern');
                    return 'Nagpur';
                }
                if (location.includes('nashik')) {
                    console.log('Found Nashik pattern');
                    return 'Nashik';
                }
                if (location.includes('aurangabad')) {
                    console.log('Found Aurangabad pattern');
                    return 'Aurangabad';
                }
                if (location.includes('thane')) {
                    console.log('Found Thane pattern');
                    return 'Thane';
                }
                if (location.includes('kalyan')) {
                    console.log('Found Kalyan pattern');
                    return 'Kalyan';
                }

                // Check for specific area patterns that belong to major cities
                const puneAreas = ['pimpri', 'chinchwad', 'kharadi', 'hadapsar', 'baner', 'wakad',
                    'hinjewadi', 'magarpatta', 'koregaon', 'viman nagar', 'camp',
                    'kothrud', 'warje', 'karve nagar', 'shivaji nagar', 'deccan'];

                const mumbaiAreas = ['andheri', 'bandra', 'borivali', 'malad', 'goregaon', 'powai',
                    'worli', 'colaba', 'kurla', 'ghatkopar', 'mulund', 'vikhroli',
                    'chembur', 'dadar', 'mahim', 'santacruz'];

                // Check for Pune areas
                for (const area of puneAreas) {
                    if (location.includes(area)) {
                        console.log('Found Pune area:', area);
                        return 'Pune';
                    }
                }

                // Check for Mumbai areas
                for (const area of mumbaiAreas) {
                    if (location.includes(area)) {
                        console.log('Found Mumbai area:', area);
                        return 'Mumbai';
                    }
                }

                // If Maharashtra is mentioned but no specific city found, default to Pune
                if (location.includes('maharashtra')) {
                    console.log('Maharashtra found, defaulting to Pune');
                    return 'Pune';
                }

                console.log('No city found, returning original location');
                return locationName;
            }

            // Function to generate realistic mock weather data
            function generateMockWeatherData(lat, lng, cityName) {
                console.log('Generating mock weather data for', cityName);

                // Current date and season
                const now = new Date();
                const month = now.getMonth(); // 0-11
                const hour = now.getHours();

                // Seasonal temperature ranges for Maharashtra (in Celsius)
                let baseTemp, tempVariation, humidity, weatherCondition;

                if (month >= 2 && month <= 5) { // March-June (Summer)
                    baseTemp = 35;
                    tempVariation = 8;
                    humidity = 45;
                    weatherCondition = Math.random() > 0.7 ? 'Clouds' : 'Clear';
                } else if (month >= 6 && month <= 9) { // July-October (Monsoon/Post-Monsoon)
                    baseTemp = 28;
                    tempVariation = 5;
                    humidity = 75;
                    weatherCondition = Math.random() > 0.5 ? 'Rain' : 'Clouds';
                } else { // November-February (Winter)
                    baseTemp = 25;
                    tempVariation = 6;
                    humidity = 55;
                    weatherCondition = Math.random() > 0.6 ? 'Clear' : 'Clouds';
                }

                // Adjust temperature based on time of day
                let timeAdjustment = 0;
                if (hour >= 6 && hour <= 10) timeAdjustment = -3; // Morning
                else if (hour >= 11 && hour <= 15) timeAdjustment = 2; // Afternoon
                else if (hour >= 16 && hour <= 19) timeAdjustment = 0; // Evening
                else timeAdjustment = -5; // Night

                const currentTemp = baseTemp + timeAdjustment + (Math.random() - 0.5) * tempVariation;
                const feelsLike = currentTemp + (Math.random() - 0.5) * 3;

                // Generate weather description
                let description;
                switch (weatherCondition) {
                    case 'Clear':
                        description = hour >= 6 && hour <= 18 ? 'clear sky' : 'clear night';
                        break;
                    case 'Clouds':
                        description = Math.random() > 0.5 ? 'partly cloudy' : 'scattered clouds';
                        break;
                    case 'Rain':
                        description = Math.random() > 0.7 ? 'heavy rain' : Math.random() > 0.5 ? 'light rain' : 'moderate rain';
                        break;
                    default:
                        description = 'clear sky';
                }

                return {
                    name: cityName,
                    main: {
                        temp: currentTemp,
                        feels_like: feelsLike,
                        temp_min: currentTemp - 4,
                        temp_max: currentTemp + 6,
                        humidity: humidity + (Math.random() - 0.5) * 20,
                        pressure: 1013 + (Math.random() - 0.5) * 20
                    },
                    weather: [{
                        main: weatherCondition,
                        description: description,
                        icon: '01d'
                    }],
                    wind: {
                        speed: 2 + Math.random() * 8 // 2-10 m/s
                    },
                    visibility: 8000 + Math.random() * 7000, // 8-15 km
                    sys: { country: 'IN' }
                };
            }

            // Function to get weather icon based on weather condition
            function getWeatherIcon(weatherMain, iconCode) {
                const iconMap = {
                    'Clear': '☀️',
                    'Clouds': '☁️',
                    'Rain': '🌧️',
                    'Drizzle': '🌦️',
                    'Thunderstorm': '⛈️',
                    'Snow': '🌨️',
                    'Mist': '🌫️',
                    'Fog': '🌫️',
                    'Haze': '🌫️',
                    'Dust': '🌪️',
                    'Sand': '🌪️',
                    'Ash': '🌋',
                    'Squall': '💨',
                    'Tornado': '🌪️'
                };

                return iconMap[weatherMain] || '🌤️';
            }

            // Function to reset location button to normal state
            function resetLocationButton() {
                const btn = document.getElementById('currentLocationBtn');
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons">my_location</span>';
                btn.title = 'Get My Exact Location';
            }

            // Add event listener for current location button
            document.getElementById('currentLocationBtn').addEventListener('click', getCurrentLocation);

            // Add soil type options
            const soilTypes = ['Red', 'Black', 'Alluvial', 'Laterite', 'Saline'];
            const soilSelect = document.getElementById('soil-type');
            soilTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                soilSelect.appendChild(option);
            });

            // Add irrigation type options
            const irrigationTypes = ['Drip', 'Sprinkler', 'Surface', 'Subsurface'];
            const irrigationSelect = document.getElementById('irrigation-type');
            irrigationTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                irrigationSelect.appendChild(option);
            });

            // Handle form submission
            document.querySelector('form').addEventListener('submit', function (e) {
                e.preventDefault();
                const location = document.getElementById('location').value;
                const soilType = document.getElementById('soil-type').value;
                const landSize = document.getElementById('land-size').value;
                const irrigationType = document.getElementById('irrigation-type').value;

                // Validate inputs
                if (!location || !soilType || !landSize || !irrigationType) {
                    const missingFields = [];
                    if (!location) missingFields.push('Location');
                    if (!soilType) missingFields.push('Soil Type');
                    if (!landSize) missingFields.push('Land Size');
                    if (!irrigationType) missingFields.push('Irrigation Type');

                    alert(`Please fill in the following fields: ${missingFields.join(', ')}`);
                    return;
                }

                // Validate land size
                const landSizeNum = parseFloat(landSize);
                if (isNaN(landSizeNum) || landSizeNum <= 0) {
                    alert('Please enter a valid land size greater than 0');
                    return;
                }

                if (landSizeNum > 1000) {
                    if (!confirm('Land size over 1000 acres detected. Continue with this large farm size?')) {
                        return;
                    }
                }

                // Get crop recommendations
                generateCropRecommendations(location, soilType, landSize, irrigationType);
            });

            // Function to generate and display crop recommendations
            function generateCropRecommendations(location, soilType, landSize, irrigationType) {
                const container = document.getElementById('crop-suggestions-container');

                // Show loading state
                container.innerHTML = `
            <div class="text-center py-12">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-green-500 border-r-transparent rounded-full mb-4"></div>
                <p class="text-gray-600">Analyzing your inputs and generating personalized crop recommendations...</p>
            </div>
        `;

                console.log('Generating recommendations for:', { location, soilType, landSize, irrigationType });
                console.log('Crop engine available:', !!window.cropRecommendationEngine);
                console.log('Crop data loaded:', !!window.cropRecommendationEngine?.cropsData);

                // Simulate processing time and get recommendations
                setTimeout(async () => {
                    if (!window.cropRecommendationEngine) {
                        console.error('Crop recommendation engine not found');
                        container.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <span class="material-icons text-6xl mb-4">error</span>
                        <p>Crop recommendation engine not loaded. Please refresh the page and try again.</p>
                    </div>
                `;
                        return;
                    }

                    if (!window.cropRecommendationEngine.cropsData) {
                        console.error('Crop data not loaded');
                        container.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <span class="material-icons text-6xl mb-4">error</span>
                        <p>Unable to load crop data. Please try again later.</p>
                    </div>
                `;
                        return;
                    }

                    console.log('Getting recommendations from engine...');

                    // Get current temperature from weather data if available
                    const currentTemp = window.currentWeatherData?.temperature || null;
                    console.log('Using temperature for recommendations:', currentTemp);

                    const recommendations = window.cropRecommendationEngine.getRecommendations(
                        location, soilType, landSize, irrigationType, currentTemp
                    );

                    console.log('Recommendations received:', recommendations);

                    if (recommendations.length === 0) {
                        container.innerHTML = `
                    <div class="text-center py-8">
                        <span class="material-icons text-6xl mb-4 text-gray-400">search_off</span>
                        <p class="text-gray-600">No suitable crops found for your criteria. Please try adjusting your inputs.</p>
                    </div>
                `;
                        return;
                    }

                    // Display recommendations
                    await displayCropRecommendations(recommendations, landSize, container);
                }, 1500);
            }

            // Function to display crop recommendations
            async function displayCropRecommendations(recommendations, landSize, container) {
                // Use the comprehensive HD crop image database
                const cropImages = window.CROP_IMAGE_DATABASE || {
                    'Rice': 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=800&h=600&fit=crop&q=90',
                    'Wheat': 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=800&h=600&fit=crop&q=90',
                    'Cotton': 'https://images.unsplash.com/photo-1602514943048-4b9e52c8cfc6?w=800&h=600&fit=crop&q=90',
                    'default': 'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=800&h=600&fit=crop&q=90'
                };

                const htmlPromises = recommendations.map(async (crop, index) => {
                    const profitability = await window.cropRecommendationEngine.getProfitabilityEstimate(crop, landSize);
                    const suitabilityColor = getSuitabilityColor(crop.suitabilityRating);
                    const defaultImage = cropImages.default || 'https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=800&h=600&fit=crop&q=90';

                    return `
                <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-2xl font-bold text-gray-800">${crop.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${suitabilityColor}">${crop.suitabilityRating}</span>
                                    <span class="text-2xl">${index < 3 ? '🏆' : index < 6 ? '🥈' : '🥉'}</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600"><strong>Season:</strong> ${crop.season}</p>
                                    <p class="text-sm text-gray-600"><strong>Temperature:</strong> ${crop.ideal_temperature_c.min}°C - ${crop.ideal_temperature_c.max}°C</p>
                                    <p class="text-sm text-gray-600"><strong>Rainfall:</strong> ${crop.rainfall_requirement_mm[0]}-${crop.rainfall_requirement_mm[1]}mm</p>
                                    <p class="text-sm text-gray-600"><strong>Varieties:</strong> ${crop.varieties.slice(0, 3).join(', ')}</p>
                                </div>
                                
                                <div class="space-y-2">
                                    <p class="text-sm text-gray-600"><strong>Expected Yield:</strong> ${profitability.estimatedYield}</p>
                                    <p class="text-sm text-gray-600"><strong>Estimated Revenue:</strong> ${profitability.estimatedRevenue}</p>
                                    <p class="text-sm text-gray-600"><strong>Estimated Cost:</strong> ${profitability.estimatedCost}</p>
                                    <p class="text-sm font-semibold ${profitability.profitability === 'High' ? 'text-green-600' : profitability.profitability === 'Medium' ? 'text-yellow-600' : 'text-red-600'}">
                                        <strong>Profitability:</strong> ${profitability.profitability} (${profitability.profitMargin})
                                    </p>
                                    <div class="flex items-center gap-2 text-xs">
                                        <span class="text-gray-600"><strong>Price:</strong> ${profitability.pricePerKg}</span>
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${profitability.priceSource === 'Local API' ? 'bg-green-100 text-green-700' :
                            profitability.priceSource === 'Cached Data' ? 'bg-blue-100 text-blue-700' :
                                profitability.priceSource === 'Government API' ? 'bg-purple-100 text-purple-700' :
                                    'bg-gray-100 text-gray-700'
                        }">
                                            ${profitability.priceSource === 'Local API' ? '🟢 Live' :
                            profitability.priceSource === 'Cached Data' ? '🔵 Recent' :
                                profitability.priceSource === 'Government API' ? '🟣 Official' :
                                    '⚪ MSP'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-700 mb-2">Why this crop is recommended:</h4>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    ${crop.reasons.map(reason => `<li class="flex items-center"><span class="material-icons text-green-500 text-sm mr-2">check_circle</span>${reason}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                                <p><strong>Cultivation Tip:</strong> ${crop.cultivation_tips}</p>
                            </div>
                        </div>
                        
                        <div class="lg:w-48 flex-shrink-0">
                            <img src="${getCropImage(crop.name, cropImages, defaultImage)}" 
                                 alt="${crop.name} cultivation" 
                                 class="w-full h-48 lg:h-full rounded-lg object-cover hd-crop-image"
                                 loading="lazy"
                                 onerror="this.src='${defaultImage}'"
                                 onload="this.classList.add('loaded')">
                        </div>
                    </div>
                </div>
            `;
                });

                const htmlResults = await Promise.all(htmlPromises);
                container.innerHTML = htmlResults.join('');
            }

            // Function to clear the form
            function clearForm() {
                document.getElementById('location').value = '';
                document.getElementById('soil-type').value = '';
                document.getElementById('land-size').value = '';
                document.getElementById('irrigation-type').value = '';

                // Reset suggestions container
                const container = document.getElementById('crop-suggestions-container');
                container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <span class="material-icons text-6xl mb-4">agriculture</span>
                <p data-translate="fillFormMessage">Please fill out the form above to get personalized crop suggestions based on your location, soil type, land size, and irrigation method.</p>
            </div>
        `;
            }

            // Make clearForm globally available
            window.clearForm = clearForm;

            // Helper function to get crop image with fallback logic
            function getCropImage(cropName, cropImages, defaultImage) {
                // First try exact match
                if (cropImages[cropName]) {
                    return cropImages[cropName];
                }

                // Try to find partial matches for crop names with variations
                const normalizedName = cropName.toLowerCase();

                // Common crop name mappings and variations
                const nameMapping = {
                    'jowar': 'Jowar (Sorghum)',
                    'sorghum': 'Jowar (Sorghum)',
                    'tur': 'Tur (Pigeon Pea)',
                    'pigeon pea': 'Tur (Pigeon Pea)',
                    'arhar': 'Tur (Pigeon Pea)',
                    'brinjal': 'Brinjal (Eggplant)',
                    'eggplant': 'Brinjal (Eggplant)',
                    'baingan': 'Brinjal (Eggplant)',
                    'okra': 'Okra (Lady Finger)',
                    'lady finger': 'Okra (Lady Finger)',
                    'bhindi': 'Okra (Lady Finger)',
                    'corn': 'Maize',
                    'makka': 'Maize',
                    'groundnut': 'Groundnut',
                    'peanut': 'Groundnut',
                    'moongphali': 'Groundnut',
                    'chili': 'Chilli',
                    'mirchi': 'Chilli',
                    'pepper': 'Chilli'
                };

                // Check if there's a mapping for the normalized name
                for (const [key, value] of Object.entries(nameMapping)) {
                    if (normalizedName.includes(key)) {
                        if (cropImages[value]) {
                            return cropImages[value];
                        }
                    }
                }

                // Try to find a crop that contains the search term or vice versa
                for (const [imageCropName, imageUrl] of Object.entries(cropImages)) {
                    if (imageCropName === 'default') continue;

                    const imageNameLower = imageCropName.toLowerCase();

                    // Check for partial matches (at least 3 characters)
                    if (normalizedName.length >= 3 && imageNameLower.includes(normalizedName)) {
                        return imageUrl;
                    }
                    if (imageCropName.length >= 3 && normalizedName.includes(imageNameLower)) {
                        return imageUrl;
                    }

                    // Check for word matches
                    const cropWords = normalizedName.split(/\s+/);
                    const imageWords = imageNameLower.split(/\s+/);

                    for (const cropWord of cropWords) {
                        if (cropWord.length >= 3) {
                            for (const imageWord of imageWords) {
                                if (imageWord.includes(cropWord) || cropWord.includes(imageWord)) {
                                    return imageUrl;
                                }
                            }
                        }
                    }
                }

                return defaultImage;
            }

            // Helper function to get suitability color
            function getSuitabilityColor(rating) {
                switch (rating) {
                    case 'Excellent': return 'bg-green-100 text-green-800';
                    case 'Very Good': return 'bg-green-50 text-green-700';
                    case 'Good': return 'bg-yellow-50 text-yellow-700';
                    case 'Fair': return 'bg-orange-50 text-orange-700';
                    default: return 'bg-red-50 text-red-700';
                }
            }

            // Initialize crop recommendation engine
            if (typeof CropRecommendationEngine !== 'undefined') {
                window.cropRecommendationEngine = new CropRecommendationEngine();
                console.log('Crop recommendation engine initialized');
            } else {
                console.error('CropRecommendationEngine class not found');
            }
        });
    </script>
</body>

</html>