<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSheti - Market Demand & Price Insights</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/plant-logo.svg" />
    <link rel="shortcut icon" type="image/svg+xml" href="../assets/images/plant-logo.svg" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="../css/Home page.css" />
    <link rel="stylesheet" href="../css/market_demand_fixed.css" />
    <link rel="stylesheet" href="../css/mobile-improvements.css" />
    <link rel="manifest" href="/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js');
            });
        }
    </script>
    <script src="../js/translations.js"></script>
    <script src="../js/install-app.js" defer></script>
</head>

<body class="font-sans page-loading" style="background-color: #EBE4DB !important;" data-page-name="market-demand">
    <!-- Page Transition Overlay -->
    <div class="page-transition" id="pageTransition">
        <div class="loader">
            <span class="material-icons">trending_up</span>
            <div class="text">Loading Market Demand...</div>
        </div>
    </div>

    <header class="shadow-sm" style="position: relative;">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../../index.html" class="brand-section" style="text-decoration: none;">
                <img src="../assets/images/plant-logo.svg" alt="SmartSheti Logo" class="w-12 h-12 mr-1.5" />
                <span class="text-2xl font-bold brand-text" data-no-translate="true">SmartSheti</span>
            </a>
            <nav class="hidden md:flex items-center space-x-4">
                <a class="nav-link text-gray-600 hover:text-green-600" href="../../index.html" data-page="home"
                    data-translate="home">Home</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="crop-suggestion.html"
                    data-page="crop-suggestion" data-translate="cropSuggestion">Crop Suggestion</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="weather.html" data-page="weather"
                    data-translate="weather">Weather</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="marketplace.html" data-page="marketplace"
                    data-translate="marketplace">Marketplace</a>
                <a class="nav-link text-green-600 font-bold" href="market-demand.html" data-page="market-demand"
                    data-translate="marketDemand">Market Demand</a>
            </nav>
            <div class="hidden md:flex items-center space-x-2 action-buttons">
                <!-- Install App Button (Hidden by default) -->
                <button id="installAppBtn"
                    class="hidden bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-full text-sm font-medium transition-colors flex items-center shadow-sm">
                    <span class="material-icons text-sm mr-1">download</span>
                    <span data-translate="installApp">Install App</span>
                </button>
                <div class="relative">
                    <button id="translateBtn" class="flex items-center text-gray-600 hover:text-green-600"
                        title="Translate">
                        <span class="material-icons mr-1">translate</span>
                        <span id="currentLang" data-no-translate="true">EN</span>
                    </button>
                    <div id="languageDropdown"
                        class="hidden absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="en">English</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</a>
                    </div>
                </div>
                <button class="text-gray-600 hover:text-green-600">
                    <span class="material-icons">notifications</span>
                </button>
                <div class="relative">
                    <button id="profileBtn" class="text-gray-600 hover:text-green-600">
                        <img alt="User avatar" class="h-8 w-8 rounded-full profile-img"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7" />
                    </button>
                    <div id="profileDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="profile">Profile</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="settings">Settings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="dashboard">Dashboard</a>
                        <hr class="my-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="logout">Logout</a>
                    </div>
                </div>
            </div>
            <button id="mobileMenuBtn" class="md:hidden text-gray-600 hover:text-green-600">
                <span class="material-icons">menu</span>
            </button>
        </div>
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t shadow-lg absolute w-full left-0 z-50"
            style="top: 100%;">
            <nav class="container mx-auto px-6 py-4 flex flex-col">
                <a class="mobile-nav-link" href="../../index.html" data-page="home">
                    <span class="material-icons text-gray-400 mr-3">home</span>
                    <span data-translate="home">Home</span>
                </a>
                <a class="mobile-nav-link" href="crop-suggestion.html" data-page="crop-suggestion">
                    <span class="material-icons text-gray-400 mr-3">grass</span>
                    <span data-translate="cropSuggestion">Crop Suggestion</span>
                </a>
                <a class="mobile-nav-link" href="weather.html" data-page="weather">
                    <span class="material-icons text-gray-400 mr-3">wb_sunny</span>
                    <span data-translate="weather">Weather</span>
                </a>
                <a class="mobile-nav-link" href="marketplace.html" data-page="marketplace">
                    <span class="material-icons text-gray-400 mr-3">storefront</span>
                    <span data-translate="marketplace">Marketplace</span>
                </a>
                <a class="mobile-nav-link active" href="market-demand.html" data-page="market-demand">
                    <span class="material-icons text-green-600 mr-3">trending_up</span>
                    <span data-translate="marketDemand">Market Demand</span>
                </a>
                <!-- Mobile Install Button -->
                <div class="px-2 pb-2">
                    <button id="installAppBtnMobile"
                        class="hidden w-full bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-lg font-medium hover:bg-green-200 transition-colors flex items-center justify-center">
                        <span class="material-icons mr-2">download</span>
                        <span data-translate="installApp">Install App</span>
                    </button>
                </div>
                <div class="border-t border-gray-100 my-2 pt-2"></div>
                <div class="flex items-center justify-between px-2 py-2">
                    <button id="translateBtnMobile"
                        class="flex items-center text-gray-600 hover:text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors"
                        title="Translate">
                        <span class="material-icons mr-2">translate</span>
                        <span id="currentLangMobile" data-no-translate="true" class="font-medium">EN</span>
                    </button>
                    <button
                        class="text-gray-600 hover:text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors">
                        <span class="material-icons">notifications</span>
                    </button>
                    <button id="profileBtnMobile"
                        class="text-gray-600 hover:text-green-600 p-1 rounded-full hover:bg-green-50 transition-colors border border-transparent hover:border-green-200">
                        <img alt="User avatar" class="h-8 w-8 rounded-full"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7" />
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6" data-translate="marketDemandTitle">Market Demand & Price
            Insights</h1>

        <!-- Filter Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="searchCrop">Search
                    Crop</label>
                <div class="relative">
                    <input type="text" id="cropInput"
                        class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4 pr-10"
                        placeholder="Type crop name (e.g., wheat, rice, tomato...)"
                        data-translate-placeholder="searchCropPlaceholder" autocomplete="off" />
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <span class="material-icons text-gray-400">search</span>
                    </div>
                    <!-- Suggestions dropdown -->
                    <div id="cropSuggestions"
                        class="hidden absolute w-full bg-white border-2 border-green-300 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-2xl"
                        style="z-index: 9999; user-select: none;">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
                <input type="hidden" id="cropSelect" value="" />
            </div>
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="state">State</label>
                <select id="stateSelect" class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4">
                    <option value="Maharashtra" selected>Maharashtra</option>
                    <option value="Gujarat">Gujarat</option>
                    <option value="Punjab">Punjab</option>
                </select>
            </div>
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="market">Market</label>
                <select id="marketSelect" class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4">
                    <option value="Mumbai APMC">Mumbai APMC</option>
                    <option value="Pune APMC" selected>Pune APMC</option>
                    <option value="Nashik APMC">Nashik APMC</option>
                </select>
            </div>
        </div>

        <!-- Price Trend Card -->
        <div class="market-card price-chart border border-green-200 p-6 mb-8">
            <div class="text-center mb-6">
                <p class="text-gray-600 mb-1" data-translate="priceTrendFor">Price Trend for</p>
                <span id="cropName" class="text-gray-800 font-semibold text-lg">Wheat</span>
            </div>
            <div class="text-center mb-6">
                <div class="flex items-baseline justify-center space-x-2 mb-2">
                    <span id="currentPrice" class="text-4xl font-bold text-gray-800">‚Çπ25/kg</span>
                    <span id="priceChange" class="text-sm text-green-600 font-semibold">+5%</span>
                </div>
                <p class="text-sm text-gray-500" data-translate="last60Days">Last 60 Days</p>
            </div>

            <!-- Line Graph Container -->
            <div id="priceChart" class="relative h-40 mb-4">
                <!-- Y-axis labels -->
                <div class="absolute left-0 top-0 h-full flex flex-col justify-between text-xs text-gray-500 pr-2">
                    <span id="maxPrice">‚Çπ2,700</span>
                    <span id="highPrice">‚Çπ2,600</span>
                    <span id="midPrice">‚Çπ2,500</span>
                    <span id="lowPrice">‚Çπ2,400</span>
                    <span id="minPrice">‚Çπ2,300</span>
                </div>

                <!-- Graph area -->
                <div class="ml-12 relative h-full">
                    <!-- Grid lines -->
                    <div class="absolute inset-0">
                        <div class="h-full flex flex-col justify-between">
                            <div class="border-t border-gray-200"></div>
                            <div class="border-t border-gray-200"></div>
                            <div class="border-t border-gray-200"></div>
                            <div class="border-t border-gray-200"></div>
                            <div class="border-t border-gray-200"></div>
                        </div>
                    </div>

                    <!-- SVG Line Graph -->
                    <svg id="chartSvg" class="w-full h-full" viewBox="0 0 400 160">
                        <polyline id="priceLine" fill="none" stroke="#10B981" stroke-width="3" points="" />
                        <g id="dataPoints"></g>
                    </svg>

                    <!-- Tooltips -->
                    <div id="lowestTooltip" class="absolute hidden">
                        <div class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded shadow-lg">
                            <div class="font-semibold" id="lowestPrice">‚Çπ2,320</div>
                            <div class="text-xs" data-translate="lowest">Lowest</div>
                        </div>
                    </div>

                    <div id="highestTooltip" class="absolute hidden">
                        <div class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded shadow-lg">
                            <div class="font-semibold" id="highestPrice">‚Çπ2,680</div>
                            <div class="text-xs" data-translate="highest">Highest</div>
                        </div>
                    </div>

                    <div id="currentTooltip" class="absolute hidden">
                        <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded shadow-lg">
                            <div class="font-semibold" id="currentPriceTooltip">‚Çπ2,500</div>
                            <div class="text-xs" data-translate="current">Current</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading indicator -->
            <div id="chartLoading" class="hidden text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                <p class="mt-2 text-sm text-gray-500" data-translate="updatingPriceData">Updating price data...</p>
            </div>

            <!-- X-axis labels -->
            <div class="flex justify-between text-xs text-gray-500 ml-12">
                <span>7W ago</span>
                <span>6W ago</span>
                <span>5W ago</span>
                <span>4W ago</span>
                <span>3W ago</span>
                <span>2W ago</span>
                <span>1W ago</span>
                <span class="font-semibold text-blue-600">Now</span>
            </div>

            <!-- Legend -->
            <div class="flex justify-center items-center space-x-6 mt-4 text-xs">
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                    <span class="text-gray-600" data-translate="lowestPrice">Lowest Price</span>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                    <span class="text-gray-600" data-translate="highestPrice">Highest Price</span>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    <span class="text-gray-600" data-translate="currentPrice">Current Price</span>
                </div>
            </div>
        </div>

        <!-- Mandi Comparison -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="mandiComparison">Mandi Comparison</h2>
        <div class="market-card p-6 mb-8">
            <div class="grid grid-cols-3 text-sm font-semibold text-gray-500 mb-4 px-4">
                <span data-translate="market">Market</span>
                <span class="text-center" data-translate="currentPrice">Current Price</span>
                <span class="text-right" data-translate="changeLastWeek">Change (Last Week)</span>
            </div>
            <div id="marketComparison" class="space-y-2">
                <!-- Market rows will be populated by JavaScript -->
            </div>
        </div>

    </div>

    <script>
        // Safely initialize header interactions after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mobileMenu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            }

            // Profile dropdown
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }

            // Mobile profile dropdown
            const profileBtnMobile = document.getElementById('profileBtnMobile');
            if (profileBtnMobile && profileDropdown) {
                profileBtnMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
            }
        });
    </script>

    <script>
        // Page Transition Functions
        function showPageTransition() {
            const transition = document.getElementById('pageTransition');
            document.body.classList.add('page-loading');

            document.body.classList.add('page-exiting');

            setTimeout(() => {
                transition.classList.add('active');
            }, 100);
        }

        function hidePageTransition() {
            const transition = document.getElementById('pageTransition');
            const header = document.querySelector('header');

            document.body.classList.remove('page-loading', 'page-exiting');

            setTimeout(() => {
                if (header) {
                    header.classList.add('loaded');
                }

                setTimeout(() => {
                    if (transition) {
                        transition.classList.remove('active');
                    }
                }, 300);
            }, 100);
        }

        function navigateToPage(url, pageName) {
            showPageTransition();

            const loaderText = document.querySelector('.page-transition .text');
            if (loaderText) {
                loaderText.textContent = `Loading ${pageName}...`;
            }

            setTimeout(() => {
                window.location.href = url;
            }, 600);
        }

        function setupSmoothNavigation() {
            const navLinks = document.querySelectorAll('nav a');

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    const pageName = this.textContent.trim();

                    if (href.startsWith('#') || href.startsWith('http') || href === window.location.pathname) {
                        return;
                    }

                    navigateToPage(href, pageName);
                });
            });
        }

        // Debug logging function (console only)
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            console.log(`[${timestamp}] ${prefix} ${message}`);
        }

        // Real-Time Price API Integration
        class RealTimePriceAPI {
            constructor() {
                this.apiUrl = '/api/prices';
                this.livePriceUrl = '/api/live-price'; // NEW: Real scraper endpoint
                this.dataGovApiKey = '579b464db66ec23bdd000001cdd3946e44ce4aad7209ff7b23ac571b';
                this.dataGovUrl = 'https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070';
                this.apiAvailable = false;
                this.realScraperAvailable = false;
                this.priceCache = {};
                // Distinguish fruits (need fruit market price, not seed/MSP)
                this.fruitCrops = new Set([
                    'mango', 'banana', 'apple', 'orange', 'grapes', 'pomegranate', 'papaya', 'watermelon', 'guava', 'chiku', 'sapota', 'pear', 'plum'
                ]);

                // Fallback base prices (per kg)
                this.fallbackPrices = {
                    // Cereals (MSP rates per quintal / 100)
                    'wheat': 24.25, 'rice': 23.20, 'maize': 21.75, 'bajra': 23.50,
                    // Cash crops
                    'cotton': 75.21, 'sugarcane': 3.15, 'soybean': 48.41,
                    // Vegetables (market rates per kg)
                    'tomato': 35, 'onion': 22, 'potato': 18, 'cabbage': 15,
                    // Fruits (base reference ‚Äì mango will be seasonal adjusted below)
                    'mango': 80, 'banana': 40, 'apple': 120, 'pomegranate': 90,
                    // Pulses (MSP per quintal / 100)
                    'tur': 72.00, 'moong': 84.45, 'urad': 69.50, 'chana': 54.41,
                    // Oilseeds
                    'groundnut': 63.13, 'sunflower': 65.00, 'mustard': 56.00
                };

                this.checkAPIAvailability();
                debugLog('Real-time price API initialized with data.gov.in', 'success');
            }

            // Check if Price API is available
            async checkAPIAvailability() {
                try {
                    const response = await fetch('/api/health', {
                        method: 'GET',
                        signal: AbortSignal.timeout(2000)
                    });
                    if (response.ok) {
                        const data = await response.json();
                        this.apiAvailable = true;
                        this.realScraperAvailable = data.realScraperAvailable || false;

                        if (this.realScraperAvailable) {
                            debugLog('‚úÖ Real AGMARKNET Scraper is available - fetching LIVE data!', 'success');
                            this.showLiveIndicator();
                        } else {
                            debugLog('‚úÖ Price API is online - using cached/proxy data', 'success');
                        }
                    }
                } catch (error) {
                    this.apiAvailable = false;
                    debugLog('‚ÑπÔ∏è Price API offline - using fallback MSP data', 'warning');
                }
            }

            // Show live data indicator
            showLiveIndicator() {
                const existingIndicator = document.getElementById('liveDataIndicator');
                if (existingIndicator) return;

                const indicator = document.createElement('div');
                indicator.id = 'liveDataIndicator';
                indicator.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-full shadow-lg flex items-center space-x-2 z-50 animate-pulse';
                indicator.innerHTML = `
                    <span class="inline-block w-2 h-2 bg-white rounded-full animate-ping"></span>
                    <span class="text-sm font-medium">üî¥ LIVE</span>
                    <span class="text-xs opacity-80">Real Market Data</span>
                `;
                document.body.appendChild(indicator);

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    indicator.classList.remove('animate-pulse');
                    indicator.classList.add('opacity-75');
                }, 5000);
            }

            // Get real-time price data
            async generatePriceData(crop, state, market) {
                debugLog(`Fetching price data for ${crop} in ${state}, ${market}`, 'info');

                try {
                    // Always try to fetch from API first
                    const apiData = await this.fetchFromAPI(crop, state);
                    if (apiData) {
                        debugLog(`‚úÖ Using real data: ‚Çπ${apiData.current_price}/kg from ${apiData.source}`, 'success');
                        return apiData;
                    }

                    // Fallback to MSP data
                    debugLog('‚ö†Ô∏è No API data found, using fallback MSP data', 'warning');
                    return this.generateFallbackData(crop, state, market);

                } catch (error) {
                    debugLog(`‚ùå Error fetching price data: ${error.message}`, 'error');
                    return this.generateFallbackData(crop, state, market);
                }
            }

            // Fetch from Price API - Now tries the new live-price endpoint first!
            async fetchFromAPI(crop, state = 'Maharashtra') {
                // STEP 1: Try the NEW /api/live-price endpoint (uses RealAGMARKNETScraper)
                if (this.realScraperAvailable) {
                    try {
                        const livePriceUrl = `${this.livePriceUrl}/${crop.toLowerCase()}?state=${state}`;
                        debugLog(`üî¥ LIVE: Fetching real-time price from scraper for: ${crop}`, 'info');

                        const liveResp = await fetch(livePriceUrl, {
                            method: 'GET',
                            signal: AbortSignal.timeout(10000)
                        });

                        if (liveResp.ok) {
                            const liveData = await liveResp.json();
                            if (liveData.success && liveData.data) {
                                const priceInfo = liveData.data;
                                const isRealData = liveData.isRealData;

                                debugLog(`${isRealData ? '‚úÖ REAL' : 'üì¶ CACHED'}: ‚Çπ${priceInfo.current_price}`, 'success');

                                // Convert price if needed (API returns per quintal, we need per kg)
                                let currentPrice = priceInfo.current_price;
                                const unit = priceInfo.unit?.toLowerCase() || '';
                                if (unit.includes('quintal') && currentPrice > 1000) {
                                    currentPrice = Math.round(currentPrice / 100);
                                }

                                // Generate historical prices if not provided
                                const historicalPrices = this.generateHistoricalPrices(currentPrice, 0.08, 0.03, 8);
                                const previousPrice = historicalPrices[historicalPrices.length - 2];
                                const changePercent = ((currentPrice - previousPrice) / previousPrice) * 100;

                                // Get market comparison from API or generate
                                const marketData = priceInfo.markets?.map(m => ({
                                    market: m.name,
                                    price: m.price > 1000 ? Math.round(m.price / 100) : m.price,
                                    change: `${Math.random() > 0.5 ? '+' : '-'}${(Math.random() * 5).toFixed(1)}%`
                                })) || this.generateMarketComparison(crop, state, currentPrice);

                                return {
                                    success: true,
                                    crop: crop,
                                    current_price: currentPrice,
                                    change_percentage: `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%`,
                                    historical_prices: historicalPrices,
                                    market_comparison: marketData,
                                    timestamp: liveData.timestamp,
                                    source: isRealData ? 'REAL_AGMARKNET' : 'SCRAPER_CACHE',
                                    source_badge: isRealData ? 'üü¢ LIVE' : 'üîµ Recent',
                                    state: priceInfo.state,
                                    markets_count: priceInfo.markets_count
                                };
                            }
                        }
                    } catch (error) {
                        debugLog(`Live price endpoint failed: ${error.message}`, 'warning');
                    }
                }

                // STEP 2: Try realprice proxy (existing endpoint)
                try {
                    // Use local proxy to avoid CORS
                    const proxyUrl = `/api/realprice/${crop.toLowerCase()}?state=${state}`;
                    debugLog(`üåê Calling realprice proxy for: ${crop}`, 'info');

                    const proxyResp = await fetch(proxyUrl, {
                        method: 'GET',
                        signal: AbortSignal.timeout(8000)
                    });

                    if (proxyResp.ok) {
                        const proxyData = await proxyResp.json();
                        if (proxyData.success) {
                            debugLog(`‚úÖ Real price from proxy: ‚Çπ${proxyData.current_price}/kg`, 'success');
                            const historicalPrices = proxyData.historical_prices && proxyData.historical_prices.length
                                ? proxyData.historical_prices
                                : this.generateHistoricalPrices(proxyData.current_price, 0.05, 0.02, 8);
                            const previousPrice = historicalPrices[historicalPrices.length - 2] || proxyData.current_price;
                            const changePercent = ((proxyData.current_price - previousPrice) / previousPrice) * 100;
                            return {
                                success: true,
                                crop: crop,
                                current_price: Math.round(proxyData.current_price),
                                change_percentage: `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%`,
                                historical_prices: historicalPrices,
                                market_comparison: proxyData.market_comparison || this.generateMarketComparison(crop, 'Maharashtra', proxyData.current_price),
                                timestamp: proxyData.timestamp,
                                source: 'DATA_GOV_IN',
                                source_badge: 'üü¢ REAL'
                            };
                        } else {
                            debugLog(`‚ö†Ô∏è Proxy returned no real data: ${proxyData.message || 'no records'}`, 'warning');
                        }
                    } else {
                        debugLog(`‚ùå Proxy HTTP error: ${proxyResp.status}`, 'error');
                    }

                    // Direct call as fallback (may hit CORS)
                    const url = `${this.dataGovUrl}?api-key=${this.dataGovApiKey}&format=json&filters[commodity]=${crop}&limit=20`;
                    debugLog(`üåê Direct data.gov.in API for: ${crop}`, 'info');
                    debugLog(`üîó Direct URL: ${url.substring(0, 100)}...`, 'info');

                    const response = await fetch(url, {
                        method: 'GET',
                        signal: AbortSignal.timeout(8000)
                    });

                    debugLog(`üì° Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                    if (response.ok) {
                        const data = await response.json();
                        debugLog(`üì¶ Received data with ${data.records?.length || 0} records`, 'info');

                        if (data.records && data.records.length > 0) {
                            debugLog(`‚úÖ Found ${data.records.length} REAL price records from government!`, 'success');

                            // Log first record for debugging
                            const firstRecord = data.records[0];
                            debugLog(`üìä Sample: ${firstRecord.commodity} - ‚Çπ${firstRecord.modal_price}/${firstRecord.unit} at ${firstRecord.market}`, 'info');

                            // Extract prices from records
                            const prices = data.records.map(r => {
                                const modalPrice = parseFloat(r.modal_price);
                                const unit = r.unit?.toLowerCase() || '';

                                // Convert to per kg
                                if (unit.includes('quintal')) {
                                    return Math.round(modalPrice / 100);
                                } else if (unit.includes('ton')) {
                                    return Math.round(modalPrice / 1000);
                                }
                                return Math.round(modalPrice);
                            }).filter(p => p > 0 && p < 10000); // Filter valid prices only

                            if (prices.length > 0) {
                                // Use latest price
                                const currentPrice = prices[0];
                                debugLog(`üí∞ Current price: ‚Çπ${currentPrice}/kg`, 'success');

                                // Create historical data from recent records
                                const historicalPrices = prices.length >= 8 ?
                                    prices.slice(0, 8).reverse() :
                                    this.generateHistoricalPrices(currentPrice, 0.05, 0.02, 8);

                                // Calculate change
                                const previousPrice = historicalPrices[historicalPrices.length - 2] || currentPrice;
                                const changePercent = ((currentPrice - previousPrice) / previousPrice) * 100;

                                // Get market details
                                const latestRecord = data.records[0];
                                const marketData = this.generateRealMarketComparison(data.records, crop, currentPrice);

                                const result = {
                                    success: true,
                                    crop: crop,
                                    current_price: currentPrice,
                                    change_percentage: `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%`,
                                    historical_prices: historicalPrices,
                                    market_comparison: marketData,
                                    timestamp: latestRecord.arrival_date || new Date().toISOString(),
                                    source: 'DATA_GOV_IN',
                                    source_badge: 'üü¢ REAL',
                                    market: latestRecord.market,
                                    state: latestRecord.state,
                                    district: latestRecord.district
                                };

                                debugLog(`‚úÖ Returning REAL government data!`, 'success');
                                return result;
                            }
                        } else {
                            debugLog(`‚ö†Ô∏è No records found in API response for ${crop}`, 'warning');
                        }
                    } else {
                        const errorText = await response.text();
                        debugLog(`‚ùå API returned error: ${errorText.substring(0, 200)}`, 'error');
                    }
                } catch (error) {
                    debugLog(`‚ùå data.gov.in API error: ${error.message}`, 'error');
                    console.error('Full error:', error);
                }

                // Try local cached prices API as backup
                try {
                    debugLog(`üì¶ Fetching cached prices for: ${crop}`, 'info');
                    const response = await fetch(`${this.apiUrl}/${crop.toLowerCase()}`, {
                        method: 'GET',
                        signal: AbortSignal.timeout(3000)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        debugLog(`‚úÖ Cached price found: ‚Çπ${data.perKg || data.current_price}/kg`, 'success');

                        // Use perKg if available (new format), otherwise calculate
                        let currentPrice = data.perKg || data.current_price;
                        let historicalPrices = data.historical_prices;

                        // If no per-kg history, convert from quintal
                        if (!historicalPrices && data.priceHistory) {
                            historicalPrices = data.priceHistory.map(p => Math.round(p / 100));
                            currentPrice = historicalPrices[historicalPrices.length - 1];
                        }

                        if (!historicalPrices) {
                            historicalPrices = this.generateHistoricalPrices(currentPrice, 0.08, 0.04, 8);
                        }

                        // Calculate change
                        const previousPrice = historicalPrices[historicalPrices.length - 2] || currentPrice;
                        const changePercent = ((currentPrice - previousPrice) / previousPrice) * 100;

                        // Use real market data from API if available
                        let marketData = data.markets;
                        if (!marketData || marketData.length === 0) {
                            marketData = this.generateMarketComparison(crop, 'Maharashtra', currentPrice);
                        }

                        return {
                            success: true,
                            crop: crop,
                            current_price: Math.round(currentPrice),
                            change_percentage: `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%`,
                            historical_prices: historicalPrices.map(p => Math.round(p)),
                            market_comparison: marketData,  // Use real market data!
                            timestamp: data.lastUpdated || new Date().toISOString(),
                            source: data.source || 'AGMARKNET_CACHE',
                            source_badge: 'üü¢ REAL'  // This is real data from prices.json
                        };
                    }
                } catch (error) {
                    debugLog(`Local API fetch failed: ${error.message}`, 'error');
                }
                return null;
            }

            // Generate market comparison from real data
            generateRealMarketComparison(records, crop, basePrice) {
                const marketMap = {};

                // Group by market/district
                records.forEach(record => {
                    const marketName = record.market || record.district || 'Unknown';
                    const modalPrice = parseFloat(record.modal_price);
                    const unit = record.unit?.toLowerCase() || '';

                    // Convert to per kg
                    let price = modalPrice;
                    if (unit.includes('quintal')) {
                        price = Math.round(modalPrice / 100);
                    } else if (unit.includes('ton')) {
                        price = Math.round(modalPrice / 1000);
                    }

                    if (!marketMap[marketName] || price > 0) {
                        marketMap[marketName] = price;
                    }
                });

                // Convert to array and take top 5
                const markets = Object.entries(marketMap)
                    .map(([name, price]) => ({ name, price }))
                    .slice(0, 5);

                // If less than 5 markets, fill with variations of base price
                while (markets.length < 5) {
                    const variation = 0.9 + (Math.random() * 0.2); // 90% to 110%
                    markets.push({
                        name: `Market ${markets.length + 1}`,
                        price: Math.round(basePrice * variation)
                    });
                }

                return markets;
            }

            // Generate fallback data using MSP rates
            generateFallbackData(crop, state, market) {
                const seasonal = this.getSeasonalFallbackPrice(crop.toLowerCase());
                const basePrice = seasonal !== null ? seasonal : (this.fallbackPrices[crop.toLowerCase()] || 25);
                const historicalPrices = this.generateHistoricalPrices(basePrice, 0.08, 0.04, 8);
                const previousPrice = historicalPrices[historicalPrices.length - 2];
                const changePercent = ((basePrice - previousPrice) / previousPrice) * 100;

                // Badge and source differentiation: Fruit vs MSP/Crop
                let source = 'MSP_FALLBACK';
                let source_badge = '‚ö™ MSP Rate';
                if (this.fruitCrops.has(crop.toLowerCase())) {
                    source = 'FRUIT_FALLBACK';
                    source_badge = 'üçâ Fruit Market';
                }

                return {
                    success: true,
                    crop: crop,
                    state: state,
                    market: market,
                    current_price: Math.round(basePrice),
                    change_percentage: `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%`,
                    historical_prices: historicalPrices,
                    market_comparison: this.generateMarketComparison(crop, state, basePrice),
                    timestamp: new Date().toISOString(),
                    source,
                    source_badge
                };
            }

            // Seasonal adjustment for certain fruits
            getSeasonalFallbackPrice(crop) {
                const month = new Date().getMonth() + 1; // 1-12
                // Mango season (bulk arrivals) roughly March‚ÄìJuly (3‚Äì7)
                if (crop === 'mango') {
                    if (month >= 3 && month <= 7) {
                        // Peak season wholesale (mixed varieties) ~‚Çπ45‚Äì65/kg => choose midpoint
                        return 55;
                    } else {
                        // Off-season limited supply, higher price ~‚Çπ85‚Äì110/kg => choose midpoint
                        return 95;
                    }
                }
                return null; // No seasonal override
            }

            // Get source badge
            getSourceBadge(source) {
                const badges = {
                    'live': 'üü¢ Live',
                    'cached': 'üîµ Recent',
                    'government': 'üü£ Official',
                    'msp': '‚ö™ MSP'
                };
                return badges[source?.toLowerCase()] || 'üîµ Data';
            }

            // Generate historical prices using Python-style algorithm
            generateHistoricalPrices(currentPrice, volatility, trend, weeks) {
                const prices = [];

                for (let i = weeks - 1; i >= 0; i--) {
                    if (i === 0) {
                        prices.push(currentPrice);
                    } else {
                        // Apply reverse trend
                        const trendEffect = trend * i * currentPrice;

                        // Use deterministic variation based on week index
                        const randomNormal = Math.sin(i * 0.7) * Math.cos(i * 0.3); // Deterministic "random"
                        const volatilityEffect = randomNormal * volatility * currentPrice * 0.5;

                        // Seasonal patterns
                        const seasonalEffect = Math.sin(i * 0.5) * (volatility * 0.3 * currentPrice);

                        let historicalPrice = currentPrice - trendEffect + volatilityEffect + seasonalEffect;

                        // Ensure reasonable bounds
                        const minBound = currentPrice * 0.6;
                        const maxBound = currentPrice * 1.4;
                        historicalPrice = Math.max(minBound, Math.min(maxBound, historicalPrice));

                        prices.push(Math.round(historicalPrice));
                    }
                }

                return prices;
            }

            // Generate market comparison data
            generateMarketComparison(crop, state, basePrice) {
                const marketMultipliers = {
                    'Mumbai APMC': 1.1, 'Pune APMC': 1.0, 'Nashik APMC': 0.95,
                    'Nagpur APMC': 1.05, 'Aurangabad APMC': 1.08
                };

                const markets = ['Mumbai APMC', 'Pune APMC', 'Nashik APMC', 'Nagpur APMC', 'Aurangabad APMC'];
                return markets.map((market, index) => {
                    const multiplier = marketMultipliers[market] || 1.0;
                    const variation = ((index * 0.05) % 0.1 - 0.05) * 0.1; // Deterministic variation
                    const price = Math.round(basePrice * multiplier * (1 + variation));

                    const changePercent = (index * 2 - 4); // Deterministic change: -4%, -2%, 0%, 2%, 4%
                    const changeStr = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(0)}%`;

                    return {
                        market: market,
                        price: price,
                        change: changeStr
                    };
                });
            }
        }

        // Chart renderer
        class ChartRenderer {
            constructor() {
                this.chartContainer = document.getElementById('priceChart');
                this.priceLine = document.getElementById('priceLine');
                this.dataPoints = document.getElementById('dataPoints');
                this.loading = document.getElementById('chartLoading');
                debugLog('Chart renderer initialized', 'success');
            }

            renderChart(priceData) {
                try {
                    debugLog('Rendering chart with new data', 'info');

                    const prices = priceData.historical_prices;
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const range = maxPrice - minPrice;
                    const padding = range * 0.1;

                    const chartMin = Math.floor(minPrice - padding);
                    const chartMax = Math.ceil(maxPrice + padding);
                    const chartRange = chartMax - chartMin;

                    // Update Y-axis labels
                    document.getElementById('maxPrice').textContent = `‚Çπ${chartMax.toLocaleString()}`;
                    document.getElementById('highPrice').textContent = `‚Çπ${Math.round(chartMax - chartRange * 0.25).toLocaleString()}`;
                    document.getElementById('midPrice').textContent = `‚Çπ${Math.round(chartMax - chartRange * 0.5).toLocaleString()}`;
                    document.getElementById('lowPrice').textContent = `‚Çπ${Math.round(chartMax - chartRange * 0.75).toLocaleString()}`;
                    document.getElementById('minPrice').textContent = `‚Çπ${chartMin.toLocaleString()}`;

                    // Generate SVG points
                    const svgPoints = prices.map((price, index) => {
                        const x = (index / (prices.length - 1)) * 400;
                        const y = 160 - ((price - chartMin) / chartRange) * 160;
                        return `${x},${y}`;
                    }).join(' ');

                    // Update price line
                    this.priceLine.setAttribute('points', svgPoints);

                    // Clear and regenerate data points
                    this.dataPoints.innerHTML = '';

                    prices.forEach((price, index) => {
                        const x = (index / (prices.length - 1)) * 400;
                        const y = 160 - ((price - chartMin) / chartRange) * 160;

                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', y);
                        circle.setAttribute('stroke', 'white');
                        circle.setAttribute('stroke-width', '2');

                        if (price === minPrice) {
                            circle.setAttribute('r', '4');
                            circle.setAttribute('fill', '#EF4444');
                        } else if (price === maxPrice) {
                            circle.setAttribute('r', '4');
                            circle.setAttribute('fill', '#F59E0B');
                        } else if (index === prices.length - 1) {
                            circle.setAttribute('r', '5');
                            circle.setAttribute('fill', '#3B82F6');
                            circle.setAttribute('stroke-width', '3');
                        } else {
                            circle.setAttribute('r', '3');
                            circle.setAttribute('fill', '#10B981');
                        }

                        this.dataPoints.appendChild(circle);
                    });

                    // Update tooltips
                    document.getElementById('lowestPrice').textContent = `‚Çπ${minPrice.toLocaleString()}`;
                    document.getElementById('highestPrice').textContent = `‚Çπ${maxPrice.toLocaleString()}`;
                    document.getElementById('currentPriceTooltip').textContent = `‚Çπ${prices[prices.length - 1].toLocaleString()}`;

                    // Show tooltips
                    document.getElementById('lowestTooltip').classList.remove('hidden');
                    document.getElementById('highestTooltip').classList.remove('hidden');
                    document.getElementById('currentTooltip').classList.remove('hidden');

                    debugLog('Chart rendered successfully', 'success');

                } catch (error) {
                    debugLog(`Error rendering chart: ${error.message}`, 'error');
                }
            }

            updateMainPriceDisplay(price, change, source_badge = '') {
                document.getElementById('currentPrice').textContent = `‚Çπ${price.toLocaleString()}/kg`;
                const changeElement = document.getElementById('priceChange');
                const isPositive = change.includes('+');
                changeElement.className = `text-sm font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}`;
                changeElement.textContent = change;

                // Add source badge if available
                if (source_badge) {
                    changeElement.textContent += ` ${source_badge}`;
                }
            }

            updateMarketComparison(marketData) {
                const container = document.getElementById('marketComparison');
                container.innerHTML = '';

                marketData.forEach(market => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-3 items-center bg-gray-50 rounded-lg p-4';

                    const isPositive = market.change.includes('+');
                    row.innerHTML = `
                        <span class="text-gray-800">${market.market}</span>
                        <span class="text-center text-gray-800">‚Çπ${market.price.toLocaleString()}/kg</span>
                        <span class="text-right font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}">${market.change}</span>
                    `;

                    container.appendChild(row);
                });
            }

            showLoading() {
                this.loading.classList.remove('hidden');
                this.chartContainer.style.opacity = '0.5';
            }

            hideLoading() {
                this.loading.classList.add('hidden');
                this.chartContainer.style.opacity = '1';
            }
        }

        // Initialize application
        let priceGenerator;
        let chartRenderer;

        async function updateChart() {
            const crop = document.getElementById('cropSelect').value;
            const state = document.getElementById('stateSelect').value;
            const market = document.getElementById('marketSelect').value;

            debugLog(`Updating chart for ${crop} in ${state}, ${market}`, 'info');

            try {
                chartRenderer.showLoading();

                // Update crop name
                document.getElementById('cropName').textContent = crop.charAt(0).toUpperCase() + crop.slice(1);

                // Generate price data (now async with API)
                const priceData = await priceGenerator.generatePriceData(crop, state, market);

                // Show real data source info
                if (priceData.source === 'DATA_GOV_IN') {
                    const sourceInfo = document.createElement('div');
                    sourceInfo.className = 'bg-green-50 border-l-4 border-green-500 p-4 mb-4 rounded';
                    sourceInfo.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">‚úÖ</span>
                            <div>
                                <p class="font-bold text-green-800">Real Government Data</p>
                                <p class="text-sm text-green-700">
                                    Source: ${priceData.market || 'Market'}, ${priceData.district || priceData.state || 'India'} 
                                    <span class="ml-2 text-xs">${priceData.timestamp || ''}</span>
                                </p>
                            </div>
                        </div>
                    `;
                    const container = document.querySelector('.demand-analysis-card');
                    container.insertBefore(sourceInfo, container.firstChild);
                }

                // Update displays
                chartRenderer.updateMainPriceDisplay(
                    priceData.current_price,
                    priceData.change_percentage,
                    priceData.source_badge || ''
                );
                chartRenderer.renderChart(priceData);
                chartRenderer.updateMarketComparison(priceData.market_comparison);

                setTimeout(() => chartRenderer.hideLoading(), 500);

            } catch (error) {
                debugLog(`Error updating chart: ${error.message}`, 'error');
                chartRenderer.hideLoading();
            }
        }

        // Initialize on page load
        // Crop Autocomplete Functionality
        class CropAutocomplete {
            constructor() {
                this.crops = [
                    { value: 'wheat', name: 'Wheat', category: 'Cereal' },
                    { value: 'rice', name: 'Rice', category: 'Cereal' },
                    { value: 'cotton', name: 'Cotton', category: 'Fiber' },
                    { value: 'tomato', name: 'Tomato', category: 'Vegetable' },
                    { value: 'onion', name: 'Onion', category: 'Vegetable' },
                    { value: 'potato', name: 'Potato', category: 'Vegetable' },
                    { value: 'sugarcane', name: 'Sugarcane', category: 'Cash Crop' },
                    { value: 'mango', name: 'Mango', category: 'Fruit' },
                    { value: 'banana', name: 'Banana', category: 'Fruit' },
                    { value: 'apple', name: 'Apple', category: 'Fruit' },
                    { value: 'maize', name: 'Maize (Corn)', category: 'Cereal' },
                    { value: 'soybean', name: 'Soybean', category: 'Legume' },
                    { value: 'groundnut', name: 'Groundnut (Peanut)', category: 'Oilseed' },
                    { value: 'sunflower', name: 'Sunflower', category: 'Oilseed' },
                    { value: 'mustard', name: 'Mustard', category: 'Oilseed' },
                    { value: 'chili', name: 'Chili Pepper', category: 'Spice' },
                    { value: 'turmeric', name: 'Turmeric', category: 'Spice' },
                    { value: 'garlic', name: 'Garlic', category: 'Vegetable' },
                    { value: 'ginger', name: 'Ginger', category: 'Spice' },
                    { value: 'cabbage', name: 'Cabbage', category: 'Vegetable' }
                ];

                this.input = null;
                this.hiddenInput = null;
                this.suggestions = null;
                this.selectedIndex = -1;

                this.init();
            }

            init() {
                this.input = document.getElementById('cropInput');
                this.hiddenInput = document.getElementById('cropSelect');
                this.suggestions = document.getElementById('cropSuggestions');

                if (this.input) {
                    this.input.addEventListener('input', (e) => this.handleInput(e));
                    this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
                    this.input.addEventListener('blur', (e) => this.handleBlur(e));
                    this.input.addEventListener('focus', (e) => this.handleFocus(e));
                }
            }

            handleInput(e) {
                const query = e.target.value.toLowerCase().trim();
                this.selectedIndex = -1;

                if (query.length === 0) {
                    this.hideSuggestions();
                    return;
                }

                const filtered = this.crops.filter(crop =>
                    crop.name.toLowerCase().includes(query) ||
                    crop.value.toLowerCase().includes(query) ||
                    crop.category.toLowerCase().includes(query)
                );

                this.showSuggestions(filtered, query);
            }

            handleKeydown(e) {
                const suggestionItems = this.suggestions.querySelectorAll('.crop-suggestion-item');

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.selectedIndex = Math.min(this.selectedIndex + 1, suggestionItems.length - 1);
                        this.updateSelection(suggestionItems);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                        this.updateSelection(suggestionItems);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.selectedIndex >= 0 && suggestionItems[this.selectedIndex]) {
                            this.selectCrop(suggestionItems[this.selectedIndex].dataset);
                        }
                        break;
                    case 'Escape':
                        this.hideSuggestions();
                        this.input.blur();
                        break;
                }
            }

            handleBlur(e) {
                // Delay hiding to allow for click events on suggestions
                setTimeout(() => {
                    this.hideSuggestions();
                }, 300);  // Increased delay to 300ms
            }

            handleFocus(e) {
                if (e.target.value.trim()) {
                    this.handleInput(e);
                }
            }

            showSuggestions(crops, query) {
                console.log(`Showing ${crops.length} crop suggestions`);  // Debug

                if (crops.length === 0) {
                    this.suggestions.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No crops found</div>';
                } else {
                    this.suggestions.innerHTML = crops.map((crop, index) => `
                        <div class="crop-suggestion-item px-4 py-3 cursor-pointer hover:bg-green-50 active:bg-green-100 flex justify-between items-center transition-colors border-b border-gray-100 last:border-0" 
                             data-value="${crop.value}" 
                             data-name="${crop.name}"
                             data-category="${crop.category}"
                             style="user-select: none; -webkit-tap-highlight-color: transparent;">
                            <div class="pointer-events-none">
                                <div class="font-medium text-gray-800">${this.highlightMatch(crop.name, query)}</div>
                                <div class="text-xs text-gray-500">${crop.category}</div>
                            </div>
                            <span class="material-icons text-gray-400 text-sm pointer-events-none">agriculture</span>
                        </div>
                    `).join('');

                    // Add click events with mousedown (fires before blur)
                    const suggestionItems = this.suggestions.querySelectorAll('.crop-suggestion-item');
                    console.log(`Added ${suggestionItems.length} suggestion items`);  // Debug

                    suggestionItems.forEach((item, index) => {
                        console.log(`Setting up item ${index}:`, item.dataset.name);  // Debug

                        // Use mousedown instead of click to fire before blur event
                        item.addEventListener('mousedown', (e) => {
                            console.log('Mousedown on:', item.dataset.name);  // Debug
                            e.preventDefault();  // Prevent blur from firing
                            e.stopPropagation();
                            this.selectCrop(item.dataset);
                        });

                        // Also keep click as backup
                        item.addEventListener('click', (e) => {
                            console.log('Click on:', item.dataset.name);  // Debug
                            e.preventDefault();
                            e.stopPropagation();
                            this.selectCrop(item.dataset);
                        });

                        // Add touch event for mobile
                        item.addEventListener('touchstart', (e) => {
                            console.log('Touch on:', item.dataset.name);  // Debug
                            e.preventDefault();
                            this.selectCrop(item.dataset);
                        });
                    });
                }

                this.suggestions.classList.remove('hidden');
                console.log('Dropdown is now visible');  // Debug
            }

            hideSuggestions() {
                this.suggestions.classList.add('hidden');
                this.selectedIndex = -1;
            }

            updateSelection(items) {
                items.forEach((item, index) => {
                    if (index === this.selectedIndex) {
                        item.classList.add('bg-green-100');
                    } else {
                        item.classList.remove('bg-green-100');
                    }
                });
            }

            selectCrop(data) {
                console.log('Selecting crop:', data);  // Debug log

                this.input.value = data.name;
                this.hiddenInput.value = data.value;
                this.hideSuggestions();

                // Visual feedback - briefly highlight input
                this.input.classList.add('ring-2', 'ring-green-500');
                setTimeout(() => {
                    this.input.classList.remove('ring-2', 'ring-green-500');
                }, 500);

                // Update the crop name display
                const cropNameElement = document.getElementById('cropName');
                if (cropNameElement) {
                    cropNameElement.textContent = data.name;
                }

                // Trigger change event for existing functionality
                const changeEvent = new Event('change', { bubbles: true });
                this.hiddenInput.dispatchEvent(changeEvent);

                debugLog(`‚úÖ Selected crop: ${data.name} (${data.value})`, 'success');

                // Trigger price update immediately
                if (window.updatePriceChart) {
                    window.updatePriceChart(data.value);
                }
            }

            highlightMatch(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<strong class="text-green-600">$1</strong>');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            debugLog('Initializing SmartSheti Market Demand page', 'info');

            // Setup smooth navigation
            setupSmoothNavigation();

            try {
                // Initialize components
                priceGenerator = new RealTimePriceAPI();
                chartRenderer = new ChartRenderer();

                // Initialize crop autocomplete
                const cropAutocomplete = new CropAutocomplete();
                debugLog('Crop autocomplete initialized', 'success');

                // Set up event listeners
                document.getElementById('cropSelect').addEventListener('change', updateChart);
                document.getElementById('stateSelect').addEventListener('change', updateChart);
                document.getElementById('marketSelect').addEventListener('change', updateChart);

                // Initial chart load
                updateChart();

                debugLog('Application initialized successfully', 'success');

                // Hide page transition and show content
                setTimeout(() => {
                    const transition = document.getElementById('pageTransition');
                    const header = document.querySelector('header');

                    document.body.classList.remove('page-loading');

                    if (header) {
                        header.classList.add('loaded');
                    }

                    if (transition) {
                        transition.classList.remove('active');
                    }
                }, 300);

            } catch (error) {
                debugLog(`Initialization error: ${error.message}`, 'error');
            }
        });
    </script>

    <!-- Translation initialized in head; removed duplicate script -->

</body>

</html>