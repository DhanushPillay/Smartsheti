<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSheti - Market Demand & Price Insights</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/plant-logo.svg" />
    <link rel="shortcut icon" type="image/svg+xml" href="../assets/images/plant-logo.svg" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="../css/Home page.css" />
    <link rel="stylesheet" href="../css/market_demand_fixed.css" />
    <link rel="stylesheet" href="../css/mobile-improvements.css" />
    <link rel="manifest" href="/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js');
            });
        }
    </script>
    <script src="../js/translations.js"></script>
    <script src="../js/install-app.js" defer></script>
</head>

<body class="font-sans page-loading" style="background-color: #EBE4DB !important;" data-page-name="market-demand">
    <!-- Page Transition Overlay -->
    <div class="page-transition" id="pageTransition">
        <div class="loader">
            <span class="material-icons">trending_up</span>
            <div class="text">Loading Market Demand...</div>
        </div>
    </div>

    <header class="shadow-sm" style="position: relative;">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../../index.html" class="brand-section" style="text-decoration: none;">
                <img src="../assets/images/plant-logo.svg" alt="SmartSheti Logo" class="w-12 h-12 mr-1.5" />
                <span class="text-2xl font-bold brand-text" data-no-translate="true">SmartSheti</span>
            </a>
            <nav class="hidden md:flex items-center space-x-4">
                <a class="nav-link text-gray-600 hover:text-green-600" href="../../index.html" data-page="home"
                    data-translate="home">Home</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="crop-suggestion.html"
                    data-page="crop-suggestion" data-translate="cropSuggestion">Crop Suggestion</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="weather.html" data-page="weather"
                    data-translate="weather">Weather</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="marketplace.html" data-page="marketplace"
                    data-translate="marketplace">Marketplace</a>
                <a class="nav-link text-green-600 font-bold" href="market-demand.html" data-page="market-demand"
                    data-translate="marketDemand">Market Demand</a>
            </nav>
            <div class="hidden md:flex items-center space-x-2 action-buttons">
                <!-- Download App Button -->
                <button id="installAppBtn"
                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-full text-sm font-medium transition-colors flex items-center shadow-sm">
                    <span class="material-icons text-sm mr-1">download</span>
                    <span data-translate="downloadApp">Download App</span>
                </button>
                <div class="relative">
                    <button id="translateBtn" class="flex items-center text-gray-600 hover:text-green-600"
                        title="Translate">
                        <span class="material-icons mr-1">translate</span>
                        <span id="currentLang" data-no-translate="true">EN</span>
                    </button>
                    <div id="languageDropdown"
                        class="hidden absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="en">English</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</a>
                    </div>
                </div>
                <button class="text-gray-600 hover:text-green-600">
                    <span class="material-icons">notifications</span>
                </button>
                <div class="relative">
                    <button id="profileBtn" class="text-gray-600 hover:text-green-600">
                        <img alt="User avatar" class="h-8 w-8 rounded-full profile-img"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7" />
                    </button>
                    <div id="profileDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="profile">Profile</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="settings">Settings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="dashboard">Dashboard</a>
                        <hr class="my-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="logout">Logout</a>
                    </div>
                </div>
            </div>
            <button id="mobileMenuBtn" class="md:hidden text-gray-600 hover:text-green-600">
                <span class="material-icons">menu</span>
            </button>
        </div>
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t shadow-lg absolute w-full left-0 z-50"
            style="top: 100%;">
            <nav class="container mx-auto px-6 py-4 flex flex-col">
                <a class="mobile-nav-link" href="../../index.html" data-page="home">
                    <span class="material-icons text-gray-400 mr-3">home</span>
                    <span data-translate="home">Home</span>
                </a>
                <a class="mobile-nav-link" href="crop-suggestion.html" data-page="crop-suggestion">
                    <span class="material-icons text-gray-400 mr-3">grass</span>
                    <span data-translate="cropSuggestion">Crop Suggestion</span>
                </a>
                <a class="mobile-nav-link" href="weather.html" data-page="weather">
                    <span class="material-icons text-gray-400 mr-3">wb_sunny</span>
                    <span data-translate="weather">Weather</span>
                </a>
                <a class="mobile-nav-link" href="marketplace.html" data-page="marketplace">
                    <span class="material-icons text-gray-400 mr-3">storefront</span>
                    <span data-translate="marketplace">Marketplace</span>
                </a>
                <a class="mobile-nav-link active" href="market-demand.html" data-page="market-demand">
                    <span class="material-icons text-green-600 mr-3">trending_up</span>
                    <span data-translate="marketDemand">Market Demand</span>
                </a>
                <!-- Download App Button (Mobile) -->
                <div class="px-2 pb-2">
                    <button id="installAppBtnMobile"
                        class="w-full bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-lg font-medium hover:bg-green-200 transition-colors flex items-center justify-center">
                        <span class="material-icons mr-2">download</span>
                        <span data-translate="downloadApp">Download App</span>
                    </button>
                </div>
                <div class="border-t border-gray-100 my-2 pt-2"></div>
                <div class="flex items-center justify-between px-2 py-2">
                    <button id="translateBtnMobile"
                        class="flex items-center text-gray-600 hover:text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors"
                        title="Translate">
                        <span class="material-icons mr-2">translate</span>
                        <span id="currentLangMobile" data-no-translate="true" class="font-medium">EN</span>
                    </button>
                    <button
                        class="text-gray-600 hover:text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors">
                        <span class="material-icons">notifications</span>
                    </button>
                    <button id="profileBtnMobile"
                        class="text-gray-600 hover:text-green-600 p-1 rounded-full hover:bg-green-50 transition-colors border border-transparent hover:border-green-200">
                        <img alt="User avatar" class="h-8 w-8 rounded-full"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7" />
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6" data-translate="marketDemandTitle">Market Demand & Price
            Insights</h1>

        <!-- Filter Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="searchCrop">Search
                    Crop</label>
                <div class="relative">
                    <input type="text" id="cropInput"
                        class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4 pr-10"
                        placeholder="Type crop name (e.g., wheat, rice, tomato...)"
                        data-translate-placeholder="searchCropPlaceholder" autocomplete="off" />
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <span class="material-icons text-gray-400">search</span>
                    </div>
                    <!-- Suggestions dropdown -->
                    <div id="cropSuggestions"
                        class="hidden absolute w-full bg-white border-2 border-green-300 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-2xl"
                        style="z-index: 9999; user-select: none;">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
                <input type="hidden" id="cropSelect" value="" />
            </div>
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="state">State</label>
                <select id="stateSelect" class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4">
                    <option value="Maharashtra" selected>Maharashtra</option>
                    <option value="Gujarat">Gujarat</option>
                    <option value="Punjab">Punjab</option>
                </select>
            </div>
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="market">Market</label>
                <select id="marketSelect" class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4">
                    <option value="Mumbai APMC">Mumbai APMC</option>
                    <option value="Pune APMC" selected>Pune APMC</option>
                    <option value="Nashik APMC">Nashik APMC</option>
                </select>
            </div>
        </div>

        <!-- Price Trend Card -->
        <div class="market-card price-chart border border-green-200 p-6 mb-8">
            <div class="text-center mb-6">
                <p class="text-gray-600 mb-1" data-translate="priceTrendFor">Price Trend for</p>
                <span id="cropName" class="text-gray-800 font-semibold text-lg">Wheat</span>
            </div>
            <div class="text-center mb-6">
                <div class="flex items-baseline justify-center space-x-2 mb-2">
                    <span id="currentPrice" class="text-4xl font-bold text-gray-800">‚Çπ25/kg</span>
                    <span id="priceChange" class="text-sm text-green-600 font-semibold">+5%</span>
                </div>
                <!-- Price type indicator -->
                <div class="text-xs text-gray-500 mb-1">
                    <span>üè™ Wholesale APMC Price</span>
                    <span class="mx-1">‚Ä¢</span>
                    <span id="priceUnit">per Kg</span>
                    <span class="mx-1">‚Ä¢</span>
                    <span id="priceQuintal" class="text-gray-400">(‚Çπ0/quintal)</span>
                </div>
                <!-- Source indicator badge -->
                <div class="flex justify-center items-center space-x-2 mb-2">
                    <span id="priceSourceBadge" class="text-xs px-3 py-1 rounded-full bg-gray-200 text-gray-600">
                        Loading...
                    </span>
                    <span id="priceMarket" class="text-xs text-gray-500">Maharashtra</span>
                </div>
                <p class="text-sm text-gray-500" data-translate="last60Days">Last 60 Days</p>
            </div>

            <!-- Line Graph Container -->
            <div id="priceChart" class="relative h-40 mb-4">
                <!-- Y-axis labels -->
                <div class="absolute left-0 top-0 h-full flex flex-col justify-between text-xs text-gray-500 pr-2">
                    <span id="maxPrice">‚Çπ2,700</span>
                    <span id="highPrice">‚Çπ2,600</span>
                    <span id="midPrice">‚Çπ2,500</span>
                    <span id="lowPrice">‚Çπ2,400</span>
                    <span id="minPrice">‚Çπ2,300</span>
                </div>

                <!-- Graph area -->
                <div class="ml-12 relative h-full">
                    <!-- Grid lines -->
                    <div class="absolute inset-0">
                        <div class="h-full flex flex-col justify-between">
                            <div class="border-t border-gray-200"></div>
                            <div class="border-t border-gray-200"></div>
                            <div class="border-t border-gray-200"></div>
                            <div class="border-t border-gray-200"></div>
                            <div class="border-t border-gray-200"></div>
                        </div>
                    </div>

                    <!-- SVG Line Graph -->
                    <svg id="chartSvg" class="w-full h-full" viewBox="0 0 400 160">
                        <polyline id="priceLine" fill="none" stroke="#10B981" stroke-width="3" points="" />
                        <g id="dataPoints"></g>
                    </svg>

                    <!-- Tooltips -->
                    <div id="lowestTooltip" class="absolute hidden">
                        <div class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded shadow-lg">
                            <div class="font-semibold" id="lowestPrice">‚Çπ2,320</div>
                            <div class="text-xs" data-translate="lowest">Lowest</div>
                        </div>
                    </div>

                    <div id="highestTooltip" class="absolute hidden">
                        <div class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded shadow-lg">
                            <div class="font-semibold" id="highestPrice">‚Çπ2,680</div>
                            <div class="text-xs" data-translate="highest">Highest</div>
                        </div>
                    </div>

                    <div id="currentTooltip" class="absolute hidden">
                        <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded shadow-lg">
                            <div class="font-semibold" id="currentPriceTooltip">‚Çπ2,500</div>
                            <div class="text-xs" data-translate="current">Current</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading indicator -->
            <div id="chartLoading" class="hidden text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                <p class="mt-2 text-sm text-gray-500" data-translate="updatingPriceData">Updating price data...</p>
            </div>

            <!-- X-axis labels -->
            <div class="flex justify-between text-xs text-gray-500 ml-12">
                <span>7W ago</span>
                <span>6W ago</span>
                <span>5W ago</span>
                <span>4W ago</span>
                <span>3W ago</span>
                <span>2W ago</span>
                <span>1W ago</span>
                <span class="font-semibold text-blue-600">Now</span>
            </div>

            <!-- Legend -->
            <div class="flex justify-center items-center space-x-6 mt-4 text-xs">
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                    <span class="text-gray-600" data-translate="lowestPrice">Lowest Price</span>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                    <span class="text-gray-600" data-translate="highestPrice">Highest Price</span>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    <span class="text-gray-600" data-translate="currentPrice">Current Price</span>
                </div>
            </div>
        </div>

        <!-- Mandi Comparison -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="mandiComparison">Mandi Comparison</h2>
        <div class="market-card p-6 mb-8">
            <div class="grid grid-cols-3 text-sm font-semibold text-gray-500 mb-4 px-4">
                <span data-translate="market">Market</span>
                <span class="text-center" data-translate="currentPrice">Current Price</span>
                <span class="text-right" data-translate="changeLastWeek">Change (Last Week)</span>
            </div>
            <div id="marketComparison" class="space-y-2">
                <!-- Market rows will be populated by JavaScript -->
            </div>
        </div>

    </div>

    <script>
        // Safely initialize header interactions after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mobileMenu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            }

            // Profile dropdown
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }

            // Mobile profile dropdown
            const profileBtnMobile = document.getElementById('profileBtnMobile');
            if (profileBtnMobile && profileDropdown) {
                profileBtnMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
            }
        });
    </script>

    <script>
        // Page Transition Functions
        function showPageTransition() {
            const transition = document.getElementById('pageTransition');
            document.body.classList.add('page-loading');

            document.body.classList.add('page-exiting');

            setTimeout(() => {
                transition.classList.add('active');
            }, 100);
        }

        function hidePageTransition() {
            const transition = document.getElementById('pageTransition');
            const header = document.querySelector('header');

            document.body.classList.remove('page-loading', 'page-exiting');

            setTimeout(() => {
                if (header) {
                    header.classList.add('loaded');
                }

                setTimeout(() => {
                    if (transition) {
                        transition.classList.remove('active');
                    }
                }, 300);
            }, 100);
        }

        function navigateToPage(url, pageName) {
            showPageTransition();

            const loaderText = document.querySelector('.page-transition .text');
            if (loaderText) {
                loaderText.textContent = `Loading ${pageName}...`;
            }

            setTimeout(() => {
                window.location.href = url;
            }, 600);
        }

        function setupSmoothNavigation() {
            const navLinks = document.querySelectorAll('nav a');

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    const pageName = this.textContent.trim();

                    if (href.startsWith('#') || href.startsWith('http') || href === window.location.pathname) {
                        return;
                    }

                    navigateToPage(href, pageName);
                });
            });
        }

        // Debug logging function (console only)
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            console.log(`[${timestamp}] ${prefix} ${message}`);
        }

        // Simplified Price Fetcher - Uses multi-source API backend
        class SimplePriceFetcher {
            constructor() {
                this.apiUrl = '/api/realprice'; // Multi-source endpoint
                debugLog('SimplePriceFetcher initialized with multi-source API','success');
            }

            // Fetch price data from multi-source API
            async generatePriceData(crop, state, market) {
                debugLog(`Fetching ${crop} price from /api/realprice`, 'info');

                try {
                    const url = `${this.apiUrl}/${crop}?state=${encodeURIComponent(state)}`;
                    const response = await fetch(url, {
                        method: 'GET',
                        signal: AbortSignal.timeout(10000)
                    });

                    if (!response.ok) {
                        throw new Error(`API returned ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.success || data.current_price) {
                        debugLog(`‚úÖ Got price: ‚Çπ${data.current_price}/kg from ${data.source}`, 'success');
                        return data;
                    } else {
                        throw new Error(data.message || 'No price data');
                    }

                } catch (error) {
                    debugLog(`‚ùå API fetch failed: ${error.message}`, 'error');
                    // Return basic fallback
                    return this.getFallbackData(crop, state);
                }
            }

            getFallbackData(crop, state) {
                const mspPrices = {
                    'wheat': 24, 'rice': 23, 'cotton': 75,
                    'tomato': 35, 'onion': 22, 'potato': 18,
                    'mango': 80, 'banana': 40, 'sugarcane': 3
                };
                const price = mspPrices[crop.toLowerCase()] || 25;
                
                return {
                    success: true,
                    crop: crop,
                    current_price: price,
                    change_percentage: '+0.0%',
                    historical_prices: Array(8).fill(price),
                    market_comparison: [
                        {market: 'Pune APMC', price: price, change: '+0%'},
                        {market: 'Mumbai APMC', price: Math.round(price*1.1), change: '+2%'}
                    ],
                    timestamp: new Date().toISOString(),
                    source: 'Fallback',
                    source_badge: '‚ö™ Estimate',
                    state: state
                };
            }
        }

        // Chart renderer
        class ChartRenderer {
            constructor() {
                this.chartContainer = document.getElementById('priceChart');
                this.priceLine = document.getElementById('priceLine');
                this.dataPoints = document.getElementById('dataPoints');
                this.loading = document.getElementById('chartLoading');
                debugLog('Chart renderer initialized', 'success');
            }

            renderChart(priceData) {
                try {
                    debugLog('Rendering chart with new data', 'info');

                    const prices = priceData.historical_prices;
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const range = maxPrice - minPrice;
                    const padding = range * 0.1;

                    const chartMin = Math.floor(minPrice - padding);
                    const chartMax = Math.ceil(maxPrice + padding);
                    const chartRange = chartMax - chartMin;

                    // Update Y-axis labels
                    document.getElementById('maxPrice').textContent = `‚Çπ${chartMax.toLocaleString()}`;
                    document.getElementById('highPrice').textContent = `‚Çπ${Math.round(chartMax - chartRange * 0.25).toLocaleString()}`;
                    document.getElementById('midPrice').textContent = `‚Çπ${Math.round(chartMax - chartRange * 0.5).toLocaleString()}`;
                    document.getElementById('lowPrice').textContent = `‚Çπ${Math.round(chartMax - chartRange * 0.75).toLocaleString()}`;
                    document.getElementById('minPrice').textContent = `‚Çπ${chartMin.toLocaleString()}`;

                    // Generate SVG points
                    const svgPoints = prices.map((price, index) => {
                        const x = (index / (prices.length - 1)) * 400;
                        const y = 160 - ((price - chartMin) / chartRange) * 160;
                        return `${x},${y}`;
                    }).join(' ');

                    // Update price line
                    this.priceLine.setAttribute('points', svgPoints);

                    // Clear and regenerate data points
                    this.dataPoints.innerHTML = '';

                    prices.forEach((price, index) => {
                        const x = (index / (prices.length - 1)) * 400;
                        const y = 160 - ((price - chartMin) / chartRange) * 160;

                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', y);
                        circle.setAttribute('stroke', 'white');
                        circle.setAttribute('stroke-width', '2');

                        if (price === minPrice) {
                            circle.setAttribute('r', '4');
                            circle.setAttribute('fill', '#EF4444');
                        } else if (price === maxPrice) {
                            circle.setAttribute('r', '4');
                            circle.setAttribute('fill', '#F59E0B');
                        } else if (index === prices.length - 1) {
                            circle.setAttribute('r', '5');
                            circle.setAttribute('fill', '#3B82F6');
                            circle.setAttribute('stroke-width', '3');
                        } else {
                            circle.setAttribute('r', '3');
                            circle.setAttribute('fill', '#10B981');
                        }

                        this.dataPoints.appendChild(circle);
                    });

                    // Update tooltips
                    document.getElementById('lowestPrice').textContent = `‚Çπ${minPrice.toLocaleString()}`;
                    document.getElementById('highestPrice').textContent = `‚Çπ${maxPrice.toLocaleString()}`;
                    document.getElementById('currentPriceTooltip').textContent = `‚Çπ${prices[prices.length - 1].toLocaleString()}`;

                    // Show tooltips
                    document.getElementById('lowestTooltip').classList.remove('hidden');
                    document.getElementById('highestTooltip').classList.remove('hidden');
                    document.getElementById('currentTooltip').classList.remove('hidden');

                    debugLog('Chart rendered successfully', 'success');

                } catch (error) {
                    debugLog(`Error rendering chart: ${error.message}`, 'error');
                }
            }

            updateMainPriceDisplay(price, change, source_badge = '', market = 'Maharashtra', isFallback = false) {
                document.getElementById('currentPrice').textContent = `‚Çπ${price.toLocaleString()}/kg`;
                
                // Update quintal price for verification
                const quintalPrice = Math.round(price * 100);
                const quintalElement = document.getElementById('priceQuintal');
                if (quintalElement) {
                    quintalElement.textContent = `‚Çπ${quintalPrice.toLocaleString()}/quintal`;
                    quintalElement.title = 'Quintal = 100 kg (for verification with Google prices)';
                }
                
                const changeElement = document.getElementById('priceChange');
                const isPositive = change.includes('+');
                changeElement.className = `text-sm font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}`;
                changeElement.textContent = change;

                // Update market display
                const marketElement = document.getElementById('priceMarket');
                if (marketElement) {
                    marketElement.textContent = market || 'Maharashtra';
                    marketElement.title = 'APMC Market Location';
                }

                // Update source badge
                const sourceBadge = document.getElementById('priceSourceBadge');
                if (sourceBadge) {
                    if (isFallback) {
                        sourceBadge.className = 'text-xs px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 border border-yellow-300 font-medium';
                        sourceBadge.innerHTML = '‚ö†Ô∏è MSP Estimate';
                        sourceBadge.title = 'Using government MSP rate - verify with local market';
                    } else if (source_badge.includes('LIVE') || source_badge.includes('REAL') || source_badge.includes('üü¢')) {
                        sourceBadge.className = 'text-xs px-3 py-1 rounded-full bg-green-100 text-green-700 border border-green-300 font-medium';
                        sourceBadge.innerHTML = 'üü¢ Live Data';
                        sourceBadge.title = 'Real-time data from government API';
                    } else if (source_badge.includes('CACHE') || source_badge.includes('üîµ')) {
                        sourceBadge.className = 'text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-700 border border-blue-300 font-medium';
                        sourceBadge.innerHTML = 'üîµ Recent Data';
                        sourceBadge.title = 'Cached data from last hour';
                    } else {
                        sourceBadge.className = 'text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-600 border border-gray-300';
                        sourceBadge.innerHTML = 'üìä Estimated';
                        sourceBadge.title = 'Estimated wholesale price';
                    }
                }
            }

            updateMarketComparison(marketData) {
                const container = document.getElementById('marketComparison');
                container.innerHTML = '';

                marketData.forEach(market => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-3 items-center bg-gray-50 rounded-lg p-4';

                    const isPositive = market.change.includes('+');
                    row.innerHTML = `
                        <span class="text-gray-800">${market.market}</span>
                        <span class="text-center text-gray-800">‚Çπ${market.price.toLocaleString()}/kg</span>
                        <span class="text-right font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}">${market.change}</span>
                    `;

                    container.appendChild(row);
                });
            }

            showLoading() {
                this.loading.classList.remove('hidden');
                this.chartContainer.style.opacity = '0.5';
            }

            hideLoading() {
                this.loading.classList.add('hidden');
                this.chartContainer.style.opacity = '1';
            }
        }

        // Initialize application
        let priceFetcher;
        let chartRenderer;

        async function updateChart() {
            const crop = document.getElementById('cropSelect').value;
            const state = document.getElementById('stateSelect').value;
            const market = document.getElementById('marketSelect').value;

            debugLog(`Updating chart for ${crop} in ${state}, ${market}`, 'info');

            try {
                chartRenderer.showLoading();

                // Update crop name
                document.getElementById('cropName').textContent = crop.charAt(0).toUpperCase() + crop.slice(1);

                // Fetch price data from multi-source API
                const priceData = await priceFetcher.generatePriceData(crop, state, market);

                // Show real data source indicator with enhanced info
                if (priceData.source && !priceData.is_fallback) {
                    const sourceInfo = document.createElement('div');
                    const bgClass = priceData.confidence >= 90 ? 'bg-green-50 border-green-500' : 'bg-blue-50 border-blue-500';
                    const textClass = priceData.confidence >= 90 ? 'text-green-800' : 'text-blue-800';
                    
                    sourceInfo.className = `${bgClass} border-l-4 p-4 mb-4 rounded`;
                    sourceInfo.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${priceData.confidence >= 90 ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                            <div>
                                <p class="font-bold ${textClass}">Real Market Data</p>
                                <p class="text-s,
                    priceData.market || 'Maharashtra',
                    priceData.is_fallback || falsem ${textClass}">
                                    Source: ${priceData.source} ‚Ä¢ ${priceData.market || 'Multiple Markets'} 
                                    <span class="ml-2 text-xs">Confidence: ${priceData.confidence}%</span>
                                </p>
                            </div>
                        </div>
                    `;
                    
                    // Remove old source info if exists
                    const oldInfo = document.querySelector('.source-info-banner');
                    if (oldInfo) oldInfo.remove();
                    
                    sourceInfo.classList.add('source-info-banner');
                    const container = document.querySelector('.market-card');
                    if (container) {
                        container.insertBefore(sourceInfo, container.firstChild);
                    }
                }

                // Update displays
                chartRenderer.updateMainPriceDisplay(
                    priceData.current_price,
                    priceData.change_percentage,
                    priceData.source_badge || ''
                );
                chartRenderer.renderChart(priceData);
                chartRenderer.updateMarketComparison(priceData.market_comparison);

                setTimeout(() => chartRenderer.hideLoading(), 500);

            } catch (error) {
                debugLog(`Error updating chart: ${error.message}`, 'error');
                chartRenderer.hideLoading();
            }
        }

        // Initialize on page load
        // Crop Autocomplete Functionality
        class CropAutocomplete {
            constructor() {
                this.crops = [
                    { value: 'wheat', name: 'Wheat', category: 'Cereal' },
                    { value: 'rice', name: 'Rice', category: 'Cereal' },
                    { value: 'cotton', name: 'Cotton', category: 'Fiber' },
                    { value: 'tomato', name: 'Tomato', category: 'Vegetable' },
                    { value: 'onion', name: 'Onion', category: 'Vegetable' },
                    { value: 'potato', name: 'Potato', category: 'Vegetable' },
                    { value: 'sugarcane', name: 'Sugarcane', category: 'Cash Crop' },
                    { value: 'mango', name: 'Mango', category: 'Fruit' },
                    { value: 'banana', name: 'Banana', category: 'Fruit' },
                    { value: 'apple', name: 'Apple', category: 'Fruit' },
                    { value: 'maize', name: 'Maize (Corn)', category: 'Cereal' },
                    { value: 'soybean', name: 'Soybean', category: 'Legume' },
                    { value: 'groundnut', name: 'Groundnut (Peanut)', category: 'Oilseed' },
                    { value: 'sunflower', name: 'Sunflower', category: 'Oilseed' },
                    { value: 'mustard', name: 'Mustard', category: 'Oilseed' },
                    { value: 'chili', name: 'Chili Pepper', category: 'Spice' },
                    { value: 'turmeric', name: 'Turmeric', category: 'Spice' },
                    { value: 'garlic', name: 'Garlic', category: 'Vegetable' },
                    { value: 'ginger', name: 'Ginger', category: 'Spice' },
                    { value: 'cabbage', name: 'Cabbage', category: 'Vegetable' }
                ];

                this.input = null;
                this.hiddenInput = null;
                this.suggestions = null;
                this.selectedIndex = -1;

                this.init();
            }

            init() {
                this.input = document.getElementById('cropInput');
                this.hiddenInput = document.getElementById('cropSelect');
                this.suggestions = document.getElementById('cropSuggestions');

                if (this.input) {
                    this.input.addEventListener('input', (e) => this.handleInput(e));
                    this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
                    this.input.addEventListener('blur', (e) => this.handleBlur(e));
                    this.input.addEventListener('focus', (e) => this.handleFocus(e));
                }
            }

            handleInput(e) {
                const query = e.target.value.toLowerCase().trim();
                this.selectedIndex = -1;

                if (query.length === 0) {
                    this.hideSuggestions();
                    return;
                }

                const filtered = this.crops.filter(crop =>
                    crop.name.toLowerCase().includes(query) ||
                    crop.value.toLowerCase().includes(query) ||
                    crop.category.toLowerCase().includes(query)
                );

                this.showSuggestions(filtered, query);
            }

            handleKeydown(e) {
                const suggestionItems = this.suggestions.querySelectorAll('.crop-suggestion-item');

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.selectedIndex = Math.min(this.selectedIndex + 1, suggestionItems.length - 1);
                        this.updateSelection(suggestionItems);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                        this.updateSelection(suggestionItems);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.selectedIndex >= 0 && suggestionItems[this.selectedIndex]) {
                            this.selectCrop(suggestionItems[this.selectedIndex].dataset);
                        }
                        break;
                    case 'Escape':
                        this.hideSuggestions();
                        this.input.blur();
                        break;
                }
            }

            handleBlur(e) {
                // Delay hiding to allow for click events on suggestions
                setTimeout(() => {
                    this.hideSuggestions();
                }, 300);  // Increased delay to 300ms
            }

            handleFocus(e) {
                if (e.target.value.trim()) {
                    this.handleInput(e);
                }
            }

            showSuggestions(crops, query) {
                console.log(`Showing ${crops.length} crop suggestions`);  // Debug

                if (crops.length === 0) {
                    this.suggestions.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No crops found</div>';
                } else {
                    this.suggestions.innerHTML = crops.map((crop, index) => `
                        <div class="crop-suggestion-item px-4 py-3 cursor-pointer hover:bg-green-50 active:bg-green-100 flex justify-between items-center transition-colors border-b border-gray-100 last:border-0" 
                             data-value="${crop.value}" 
                             data-name="${crop.name}"
                             data-category="${crop.category}"
                             style="user-select: none; -webkit-tap-highlight-color: transparent;">
                            <div class="pointer-events-none">
                                <div class="font-medium text-gray-800">${this.highlightMatch(crop.name, query)}</div>
                                <div class="text-xs text-gray-500">${crop.category}</div>
                            </div>
                            <span class="material-icons text-gray-400 text-sm pointer-events-none">agriculture</span>
                        </div>
                    `).join('');

                    // Add click events with mousedown (fires before blur)
                    const suggestionItems = this.suggestions.querySelectorAll('.crop-suggestion-item');
                    console.log(`Added ${suggestionItems.length} suggestion items`);  // Debug

                    suggestionItems.forEach((item, index) => {
                        console.log(`Setting up item ${index}:`, item.dataset.name);  // Debug

                        // Use mousedown instead of click to fire before blur event
                        item.addEventListener('mousedown', (e) => {
                            console.log('Mousedown on:', item.dataset.name);  // Debug
                            e.preventDefault();  // Prevent blur from firing
                            e.stopPropagation();
                            this.selectCrop(item.dataset);
                        });

                        // Also keep click as backup
                        item.addEventListener('click', (e) => {
                            console.log('Click on:', item.dataset.name);  // Debug
                            e.preventDefault();
                            e.stopPropagation();
                            this.selectCrop(item.dataset);
                        });

                        // Add touch event for mobile
                        item.addEventListener('touchstart', (e) => {
                            console.log('Touch on:', item.dataset.name);  // Debug
                            e.preventDefault();
                            this.selectCrop(item.dataset);
                        });
                    });
                }

                this.suggestions.classList.remove('hidden');
                console.log('Dropdown is now visible');  // Debug
            }

            hideSuggestions() {
                this.suggestions.classList.add('hidden');
                this.selectedIndex = -1;
            }

            updateSelection(items) {
                items.forEach((item, index) => {
                    if (index === this.selectedIndex) {
                        item.classList.add('bg-green-100');
                    } else {
                        item.classList.remove('bg-green-100');
                    }
                });
            }

            selectCrop(data) {
                console.log('Selecting crop:', data);  // Debug log

                this.input.value = data.name;
                this.hiddenInput.value = data.value;
                this.hideSuggestions();

                // Visual feedback - briefly highlight input
                this.input.classList.add('ring-2', 'ring-green-500');
                setTimeout(() => {
                    this.input.classList.remove('ring-2', 'ring-green-500');
                }, 500);

                // Update the crop name display
                const cropNameElement = document.getElementById('cropName');
                if (cropNameElement) {
                    cropNameElement.textContent = data.name;
                }

                // Trigger change event for existing functionality
                const changeEvent = new Event('change', { bubbles: true });
                this.hiddenInput.dispatchEvent(changeEvent);

                debugLog(`‚úÖ Selected crop: ${data.name} (${data.value})`, 'success');

                // Trigger price update immediately
                if (window.updatePriceChart) {
                    window.updatePriceChart(data.value);
                }
            }

            highlightMatch(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<strong class="text-green-600">$1</strong>');
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            debugLog('Initializing SmartSheti Market Demand page', 'info');

            // Setup smooth navigation
            setupSmoothNavigation();

            try {
                // Initialize components with new simplified fetcher
                priceFetcher = new SimplePriceFetcher();
                chartRenderer = new ChartRenderer();

                // Initialize crop autocomplete
                const cropAutocomplete = new CropAutocomplete();
                debugLog('Crop autocomplete initialized', 'success');

                // Set up event listeners
                document.getElementById('cropSelect').addEventListener('change', updateChart);
                document.getElementById('stateSelect').addEventListener('change', updateChart);
                document.getElementById('marketSelect').addEventListener('change', updateChart);

                // Initial chart load - AWAIT to ensure data loads before hiding transition
                await updateChart();

                debugLog('Application initialized successfully', 'success');

                // Hide page transition and show content AFTER data loads
                setTimeout(() => {
                    const transition = document.getElementById('pageTransition');
                    const header = document.querySelector('header');

                    document.body.classList.remove('page-loading');

                    if (header) {
                        header.classList.add('loaded');
                    }

                    if (transition) {
                        transition.classList.remove('active');
                    }
                }, 300);

            } catch (error) {
                debugLog(`Initialization error: ${error.message}`, 'error');
            }
        });
    </script>

    <!-- Translation initialized in head; removed duplicate script -->

</body>

</html>