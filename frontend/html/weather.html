<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Weather Information - SmartSheti</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/plant-logo.svg" />
    <link rel="shortcut icon" type="image/svg+xml" href="../assets/images/plant-logo.svg" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet" href="../css/weather.css" />
    <link rel="stylesheet" href="../css/mobile-improvements.css" />
    <link rel="manifest" href="/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js');
            });
        }
    </script>
    <script src="../js/translations.js"></script>
    <script src="../js/install-app.js" defer></script>
    <!-- Maharashtra Weather Intelligence Modules -->
    <script src="../js/maharashtra-locations.js"></script>
    <script src="../js/maharashtra_weather_context.js"></script>
    <script src="../js/agroclimatic_advisor.js"></script>
    <script src="../js/seasonal_calendar.js"></script>
    <script src="../js/maharashtra_alerts.js"></script>
    <script src="../js/crop_weather_advisor.js"></script>
    <script src="../js/farm_operations_planner.js"></script>
    <script src="../js/water_management.js"></script>

</head>

<body class="font-sans page-loading" style="background-color: #EBE4DB !important;" data-page-name="weather">
    <!-- Page Transition Overlay -->
    <div class="page-transition" id="pageTransition">
        <div class="loader">
            <span class="material-icons">wb_sunny</span>
            <div class="text">Loading Weather...</div>
        </div>
    </div>

    <header class="shadow-sm" style="position: relative;">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../../index.html" class="brand-section" style="text-decoration: none;">
                <img src="../assets/images/plant-logo.svg" alt="SmartSheti Logo" class="w-12 h-12 mr-1.5" />
                <span class="text-2xl font-bold brand-text" data-no-translate="true">SmartSheti</span>
            </a>
            <nav class="hidden md:flex items-center space-x-4">
                <a class="nav-link text-gray-600 hover:text-green-600" href="../../index.html" data-page="home"
                    data-translate="home">Home</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="crop-suggestion.html"
                    data-page="crop-suggestion" data-translate="cropSuggestion">Crop Suggestion</a>
                <a class="nav-link text-green-600 font-bold" href="weather.html" data-page="weather"
                    data-translate="weather">Weather</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="marketplace.html" data-page="marketplace"
                    data-translate="marketplace">Marketplace</a>
                <a class="nav-link text-gray-600 hover:text-green-600" href="market-demand.html"
                    data-page="market-demand" data-translate="marketDemand">Market Demand</a>
            </nav>
            <div class="hidden md:flex items-center space-x-2 action-buttons">
                <!-- Download App Button -->
                <button id="installAppBtn"
                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-full text-sm font-medium transition-colors flex items-center shadow-sm">
                    <span class="material-icons text-sm mr-1">download</span>
                    <span data-translate="downloadApp">Download App</span>
                </button>
                <div class="relative">
                    <button id="translateBtn" class="flex items-center text-gray-600 hover:text-green-600"
                        title="Translate">
                        <span class="material-icons mr-1">translate</span>
                        <span id="currentLang" data-no-translate="true">EN</span>
                    </button>
                    <div id="languageDropdown"
                        class="hidden absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="en">English</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="hi">à¤¹à¤¿à¤‚à¤¦à¥€</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="mr">à¤®à¤°à¤¾à¤ à¥€</a>
                    </div>
                </div>
                <button class="text-gray-600 hover:text-green-600">
                    <span class="material-icons">notifications</span>
                </button>
                <div class="relative">
                    <button id="profileBtn" class="text-gray-600 hover:text-green-600">
                        <img alt="User avatar" class="h-8 w-8 rounded-full profile-img"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7" />
                    </button>
                    <div id="profileDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="profile">Profile</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="settings">Settings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="dashboard">Dashboard</a>
                        <hr class="my-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-translate="logout">Logout</a>
                    </div>
                </div>
            </div>
            <button id="mobileMenuBtn" class="md:hidden text-gray-600 hover:text-green-600">
                <span class="material-icons">menu</span>
            </button>
        </div>
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t shadow-lg absolute w-full left-0 z-50"
            style="top: 100%;">
            <nav class="container mx-auto px-6 py-4 flex flex-col">
                <a class="mobile-nav-link" href="../../index.html" data-page="home">
                    <span class="material-icons text-gray-400 mr-3">home</span>
                    <span data-translate="home">Home</span>
                </a>
                <a class="mobile-nav-link" href="crop-suggestion.html" data-page="crop-suggestion">
                    <span class="material-icons text-gray-400 mr-3">grass</span>
                    <span data-translate="cropSuggestion">Crop Suggestion</span>
                </a>
                <a class="mobile-nav-link active" href="weather.html" data-page="weather">
                    <span class="material-icons text-green-600 mr-3">wb_sunny</span>
                    <span data-translate="weather">Weather</span>
                </a>
                <a class="mobile-nav-link" href="marketplace.html" data-page="marketplace">
                    <span class="material-icons text-gray-400 mr-3">storefront</span>
                    <span data-translate="marketplace">Marketplace</span>
                </a>
                <a class="mobile-nav-link" href="market-demand.html" data-page="market-demand">
                    <span class="material-icons text-gray-400 mr-3">trending_up</span>
                    <span data-translate="marketDemand">Market Demand</span>
                </a>
                <!-- Download App Button (Mobile) -->
                <div class="px-2 pb-2">
                    <button id="installAppBtnMobile"
                        class="w-full bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-lg font-medium hover:bg-green-200 transition-colors flex items-center justify-center">
                        <span class="material-icons mr-2">download</span>
                        <span data-translate="downloadApp">Download App</span>
                    </button>
                </div>
                <div class="border-t border-gray-100 my-2 pt-2"></div>
                <div class="flex items-center justify-between px-2 py-2">
                    <button id="translateBtnMobile"
                        class="flex items-center text-gray-600 hover:text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors"
                        title="Translate">
                        <span class="material-icons mr-2">translate</span>
                        <span id="currentLangMobile" data-no-translate="true" class="font-medium">EN</span>
                    </button>
                    <button
                        class="text-gray-600 hover:text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors">
                        <span class="material-icons">notifications</span>
                    </button>
                    <button id="profileBtnMobile"
                        class="text-gray-600 hover:text-green-600 p-1 rounded-full hover:bg-green-50 transition-colors border border-transparent hover:border-green-200">
                        <img alt="User avatar" class="h-8 w-8 rounded-full"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7" />
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 page-content">
        <h1 class="text-3xl font-bold text-gray-800 mb-6" data-translate="weatherInformation">Weather Information</h1>
        <div class="relative mb-8 max-w-2xl mx-auto">
            <div class="flex">
                <span class="material-icons absolute left-3 top-3 text-gray-400">search</span>
                <input id="locationInput"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="Search..." type="text" data-translate="searchPlaceholder" />
                <button id="searchBtn"
                    class="bg-green-600 text-white px-4 py-2 rounded-r-md hover:bg-green-700 transition-colors"
                    data-translate="search">Search</button>
            </div>
            <div id="locationError" class="text-red-500 text-sm mt-1 hidden" data-translate="locationError">Please enter
                a location</div>
        </div>
        <div id="currentLocation" class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800" id="locationName">Search for a location</h2>
                    <p class="text-gray-500" id="currentDate">Loading date...</p>
                    <div class="mt-4">
                        <div class="flex items-center">
                            <img id="weatherIcon" src="" alt="Weather icon" class="w-16 h-16">
                            <span id="currentTemp" class="text-4xl font-bold text-gray-800 ml-2">--Â°C</span>
                        </div>
                        <p id="weatherDescription" class="text-lg text-gray-600 capitalize">--</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-gray-700"><span data-translate="feelsLike">Feels like</span>: <span
                            id="feelsLike">--Â°C</span></p>
                    <p class="text-gray-700"><span data-translate="humidity">Humidity</span>: <span
                            id="humidity">--%</span></p>
                    <p class="text-gray-700"><span data-translate="wind">Wind</span>: <span id="windSpeed">--
                            km/h</span></p>
                    <p class="text-gray-700"><span data-translate="pressure">Pressure</span>: <span id="pressure">--
                            hPa</span></p>
                    <p class="text-gray-700"><span data-translate="sunrise">Sunrise</span>: <span
                            id="sunrise">--:--</span></p>
                    <p class="text-gray-700"><span data-translate="sunset">Sunset</span>: <span id="sunset">--:--</span>
                    </p>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <!-- Weather Alerts -->
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <span class="material-icons text-red-500">warning</span>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800" data-translate="weatherAlerts">Weather Alerts</h3>
                        <div id="weatherAlerts" class="mt-2 text-sm text-red-700">
                            <p data-translate="noAlerts">No active weather alerts</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agricultural Advice -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <span class="material-icons text-blue-500">eco</span>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800" data-translate="agriculturalAdvice">Agricultural
                            Advice</h3>
                        <div id="agriAdvice" class="mt-2 text-sm text-blue-700">
                            <p data-translate="searchForAgriAdvice">Search for a location to get agricultural advice</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="forecastTitle">7-Day Forecast</h2>
        <div id="forecastContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-7 gap-4 mb-10">
            <!-- Forecast items will be dynamically inserted here -->
            <div class="text-center p-4">
                <p class="text-gray-500" data-translate="searchForForecast">Search for a location to see forecast</p>
            </div>
        </div>
        <div id="weatherAlertsContainer" class="mb-10 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Weather Alerts</h2>
            <div id="weatherAlertsList" class="space-y-4">
                <!-- Alerts will be dynamically inserted here -->
            </div>
        </div>
        <div id="pestRiskContainer" class="mt-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="pestRiskAnalysis">Pest Risk Analysis</h2>
            <div id="pestRiskContent" class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r">
                <p class="text-gray-700" data-translate="pestRiskInfo">Pest risk information will be displayed here
                    based on current weather conditions.</p>
            </div>
        </div>

        <div class="mt-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="irrigationAdvice">Irrigation Advice</h2>
            <div id="irrigationAdvice" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r">
                <p class="text-gray-700" data-translate="irrigationAdviceInfo">Irrigation advice will be displayed here
                    based on current weather conditions.</p>
            </div>
        </div>

        <!-- Maharashtra Weather Intelligence Sections -->
        
        <!-- Location Context -->
        <div id="locationContextSection" class="mt-10 hidden">
            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <span class="material-icons text-green-600 text-3xl mr-3">place</span>
                    <h2 class="text-2xl font-bold text-gray-800" data-translate="locationContext">Location Context</h2>
                </div>
                <div id="locationContextContent" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Monsoon & Seasonal Calendar -->
        <div id="seasonalSection" class="mt-10 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Monsoon Tracker -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-blue-600 text-3xl mr-3">wb_cloudy</span>
                        <h2 class="text-2xl font-bold text-gray-800" data-translate="monsoonTracker">Monsoon Tracker</h2>
                    </div>
                    <div id="monsoonTrackerContent">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>

                <!-- Seasonal Calendar -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-green-600 text-3xl mr-3">event</span>
                        <h2 class="text-2xl font-bold text-gray-800" data-translate="seasonalCalendar">Seasonal Calendar</h2>
                    </div>
                    <div id="seasonalCalendarContent">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Regional Alerts -->
        <div id="regionalAlertsSection" class="mt-10 hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <span class="material-icons text-red-600 text-3xl mr-3">error_outline</span>
                    <h2 class="text-2xl font-bold text-gray-800" data-translate="regionalAlerts">Regional Alerts</h2>
                </div>
                <div id="regionalAlertsContent" class="space-y-4">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Crop Advisories -->
        <div id="cropAdvisoriesSection" class="mt-10 hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <span class="material-icons text-amber-600 text-3xl mr-3">agriculture</span>
                    <h2 class="text-2xl font-bold text-gray-800" data-translate="cropAdvisory">Crop Advisory</h2>
                </div>
                <div id="cropAdvisoriesContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Farm Operations Planner -->
        <div id="farmOperationsSection" class="mt-10 hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <span class="material-icons text-purple-600 text-3xl mr-3">agriculture</span>
                    <h2 class="text-2xl font-bold text-gray-800" data-translate="sevenDayPlanner">7-Day Operations Planner</h2>
                </div>
                <div id="farmOperationsContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Water Management -->
        <div id="waterManagementSection" class="mt-10 hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <span class="material-icons text-cyan-600 text-3xl mr-3">water_drop</span>
                    <h2 class="text-2xl font-bold text-gray-800" data-translate="waterManagement">Water Management</h2>
                </div>
                <div id="waterManagementContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // Header functionality
        document.addEventListener('DOMContentLoaded', function () {
            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mobileMenu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            }

            // Profile dropdown
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }

            // Mobile profile dropdown
            const profileBtnMobile = document.getElementById('profileBtnMobile');
            if (profileBtnMobile && profileDropdown) {
                profileBtnMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });
            }
        });
    </script>
    <script src="../js/pest_risk_analyzer.js"></script>
    <script src="../js/pest_utils.js"></script>
    <script>
        // Maharashtra Weather Intelligence - Global Variables
        let maharashtraContext = null;
        let agroclimaticAdvisor = null;
        let seasonalCalendar = null;
        let maharashtraAlerts = null;
        let cropWeatherAdvisor = null;
        let farmOpsPlanner = null;
        let waterManager = null;
        let currentLocationContext = null;
        let currentForecastData = null; // Store forecast data globally

        // Initialize translation when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('DOM loaded, initializing weather page...');

            // Initialize DOM elements
            initializeDOMElements();

            // Setup event listeners
            setupEventListeners();

            // Initialize Maharashtra Weather Intelligence
            await initializeMaharashtraIntelligence();

            // Test API key and load default weather
            initializeWeatherData();
        });

        // Initialize Maharashtra Weather Intelligence modules
        async function initializeMaharashtraIntelligence() {
            console.log('Initializing Maharashtra Weather Intelligence...');
            
            try {
                // Initialize context manager
                maharashtraContext = new MaharashtraWeatherContext();
                await maharashtraContext.initialize();
                
                // Initialize other modules
                agroclimaticAdvisor = new AgroclimaticAdvisor(maharashtraContext);
                seasonalCalendar = new SeasonalCalendar(maharashtraContext);
                maharashtraAlerts = new MaharashtraAlerts(maharashtraContext);
                cropWeatherAdvisor = new CropWeatherAdvisor(maharashtraContext);
                farmOpsPlanner = new FarmOperationsPlanner();
                waterManager = new WaterManagement(maharashtraContext);
                
                console.log('âœ… Maharashtra Weather Intelligence initialized successfully');
            } catch (error) {
                console.error('Error initializing Maharashtra Intelligence:', error);
            }
        }

        // Use translation functions from global system
        function getCurrentLanguage() {
            return window.getCurrentLanguage ? window.getCurrentLanguage() : 'en';
        }

        function getTranslatedPestRisks(risksArray, language) {
            if (typeof window.getTranslatedPestRisks === 'function') {
                return window.getTranslatedPestRisks(temperature, humidity);
            }
            return risksArray; // Return original risks if translation not available
        }

        function getTranslatedIrrigationAdvice(temperature, humidity, rainfall) {
            if (typeof window.getTranslatedIrrigationAdvice === 'function') {
                return window.getTranslatedIrrigationAdvice(temperature, humidity, rainfall);
            }
            return "Maintain normal irrigation schedule";
        }

        // API Configuration
        const API_KEY = 'd32cf5dc3d4bf15c2a7588dad7fad802';
        let currentLocation = {};

        // DOM Elements - will be initialized after DOM loads
        let locationInput, searchBtn, locationError;
        let locationName, currentDate, weatherIcon, currentTemp, weatherDescription;
        let feelsLike, humidity, windSpeed, pressure, sunrise, sunset;
        let forecastContainer, weatherAlerts, agriAdvice;
        let profileBtn, profileDropdown;

        // Initialize DOM elements
        function initializeDOMElements() {
            console.log('Initializing DOM elements...');

            // Search elements
            locationInput = document.getElementById('locationInput');
            searchBtn = document.getElementById('searchBtn');
            locationError = document.getElementById('locationError');

            // Current Weather Elements
            locationName = document.getElementById('locationName');
            currentDate = document.getElementById('currentDate');
            weatherIcon = document.getElementById('weatherIcon');
            currentTemp = document.getElementById('currentTemp');
            weatherDescription = document.getElementById('weatherDescription');
            feelsLike = document.getElementById('feelsLike');
            humidity = document.getElementById('humidity');
            windSpeed = document.getElementById('windSpeed');
            pressure = document.getElementById('pressure');
            sunrise = document.getElementById('sunrise');
            sunset = document.getElementById('sunset');

            // Forecast Elements
            forecastContainer = document.getElementById('forecastContainer');
            weatherAlerts = document.getElementById('weatherAlerts');
            agriAdvice = document.getElementById('agriAdvice');

            // Profile dropdown functionality
            profileBtn = document.getElementById('profileBtn');
            profileDropdown = document.getElementById('profileDropdown');

            console.log('DOM elements initialized');
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');

            if (searchBtn && locationInput) {
                searchBtn.addEventListener('click', handleSearch);

                locationInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                });
            }

            console.log('Event listeners set up');
        }

        // Initialize weather data
        async function initializeWeatherData() {
            console.log('Initializing weather data...');

            // Test API key
            const isApiValid = await testAPIKey();
            if (!isApiValid) {
                console.error('API key test failed. Weather functionality may not work.');
                showError('Weather API is not accessible. Please check your internet connection.');
                return;
            }

            console.log('API key test passed. Loading default weather...');

            // Try to get user's location or load default weather for Mumbai
            const defaultLocation = 'Mumbai';
            try {
                await loadWeatherData(defaultLocation);
            } catch (error) {
                console.error('Failed to load default weather data:', error);
                showError('Failed to load weather data. Please try searching for a specific location.');
            }
        }

        // Show error message
        function showError(message) {
            if (locationName) {
                locationName.textContent = 'Error Loading Weather';
            }
            if (weatherDescription) {
                weatherDescription.textContent = message;
            }
            if (currentTemp) {
                currentTemp.textContent = '--Â°C';
            }
        }
        async function testAPIKey() {
            try {
                const testUrl = `https://api.openweathermap.org/data/2.5/weather?q=London&units=metric&appid=${API_KEY}`;
                console.log('Testing API with URL:', testUrl);
                const response = await fetch(testUrl);
                console.log('API test response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('API test successful:', data);
                    return true;
                } else {
                    console.error('API test failed:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('API test error:', error);
                return false;
            }
        }

        // Initialize date
        function updateCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            if (currentDate) {
                currentDate.textContent = new Date().toLocaleDateString('en-US', options);
            }
        }

        // Format time from timestamp
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        // Get weather icon URL
        function getWeatherIconUrl(iconCode) {
            return `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
        }

        // Fetch weather data from OpenWeatherMap API
        async function fetchWeatherData(location) {
            try {
                console.log('Fetching weather data for location:', location);

                // Fetch current weather
                const currentWeatherUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(location)}&units=metric&appid=${API_KEY}`;
                console.log('Current weather URL:', currentWeatherUrl);
                const currentResponse = await fetch(currentWeatherUrl);

                if (!currentResponse.ok) {
                    console.error('Error fetching current weather:', currentResponse.status, currentResponse.statusText);
                    throw new Error('Location not found');
                }

                const currentData = await currentResponse.json();
                console.log('Current weather data:', currentData);

                // Fetch forecast
                const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(location)}&units=metric&appid=${API_KEY}`;
                console.log('Forecast URL:', forecastUrl);
                const forecastResponse = await fetch(forecastUrl);

                if (!forecastResponse.ok) {
                    console.error('Error fetching forecast:', forecastResponse.status, forecastResponse.statusText);
                    throw new Error('Forecast data not available');
                }

                const forecastData = await forecastResponse.json();
                console.log('Forecast data:', forecastData);

                return { current: currentData, forecast: forecastData };
            } catch (error) {
                console.error('Error in fetchWeatherData:', error);
                throw error;
            }
        }

        // Update UI with weather data
        function updateWeatherUI(data) {
            console.log('Updating weather UI with data:', data);

            if (!data) {
                console.error('No weather data provided to updateWeatherUI');
                return;
            }

            try {
                // Update location info
                if (locationName) {
                    locationName.textContent = data.name;
                }

                // Update weather icon
                if (weatherIcon && data.weather && data.weather[0]) {
                    weatherIcon.src = getWeatherIconUrl(data.weather[0].icon);
                    weatherIcon.alt = data.weather[0].description;
                }

                // Update temperature
                if (currentTemp && data.main) {
                    currentTemp.textContent = `${Math.round(data.main.temp)}Â°C`;
                }

                // Update weather description
                if (weatherDescription && data.weather && data.weather[0]) {
                    weatherDescription.textContent = data.weather[0].description;
                }

                // Update additional weather info
                if (feelsLike && data.main) {
                    feelsLike.textContent = `${Math.round(data.main.feels_like)}Â°C`;
                }
                if (humidity && data.main) {
                    humidity.textContent = `${data.main.humidity}%`;
                }
                if (windSpeed && data.wind) {
                    windSpeed.textContent = `${Math.round(data.wind.speed * 3.6)} km/h`;
                }
                if (pressure && data.main) {
                    pressure.textContent = `${data.main.pressure} hPa`;
                }

                // Update sunrise/sunset times
                if (data.sys) {
                    if (sunrise && data.sys.sunrise) {
                        sunrise.textContent = formatTime(data.sys.sunrise);
                    }
                    if (sunset && data.sys.sunset) {
                        sunset.textContent = formatTime(data.sys.sunset);
                    }
                }

                // Update date
                updateCurrentDate();

                // Update pest risk
                calculatePestRisk(data);

                // Update irrigation advice
                updateAgriculturalAdvice(data);

                // Update Maharashtra Weather Intelligence sections
                if (maharashtraContext && data.name) {
                    updateMaharashtraIntelligenceSections(data);
                }

                console.log('Weather UI updated successfully');
            } catch (error) {
                console.error('Error updating weather UI:', error);
            }
        }

        // Update weather alerts based on API data
        function updateWeatherAlerts(alerts) {
            const alertsContainer = document.getElementById('weatherAlertsContainer');
            const alertsList = document.getElementById('weatherAlertsList');

            // Clear any existing alerts
            alertsList.innerHTML = '';

            // If no alerts, hide the container and return
            if (!alerts || alerts.length === 0) {
                alertsContainer.classList.add('hidden');
                return;
            }

            // Show the container
            alertsContainer.classList.remove('hidden');

            // Add each alert to the list
            alerts.forEach(alert => {
                // Determine alert type and corresponding styling
                let alertType = 'blue';
                let icon = 'warning';

                // Map OpenWeather alert event types to our alert types
                const alertEvent = alert.event.toLowerCase();
                if (alertEvent.includes('rain') || alertEvent.includes('storm') || alertEvent.includes('thunder')) {
                    alertType = 'red';
                    icon = 'thunderstorm';
                } else if (alertEvent.includes('flood') || alertEvent.includes('tsunami')) {
                    alertType = 'red';
                    icon = 'flood';
                } else if (alertEvent.includes('wind') || alertEvent.includes('gale') || alertEvent.includes('storm')) {
                    alertType = 'yellow';
                    icon = 'air';
                } else if (alertEvent.includes('fog') || alertEvent.includes('mist') || alertEvent.includes('haze')) {
                    alertType = 'blue';
                    icon = 'foggy';
                } else if (alertEvent.includes('snow') || alertEvent.includes('blizzard') || alertEvent.includes('sleet')) {
                    alertType = 'blue';
                    icon = 'ac_unit';
                } else if (alertEvent.includes('heat') || alertEvent.includes('hot')) {
                    alertType = 'orange';
                    icon = 'wb_sunny';
                } else if (alertEvent.includes('cold') || alertEvent.includes('freez') || alertEvent.includes('frost')) {
                    alertType = 'blue';
                    icon = 'ac_unit';
                }

                // Format the dates
                const startDate = new Date(alert.start * 1000).toLocaleString();
                const endDate = new Date(alert.end * 1000).toLocaleString();

                // Create alert HTML
                const alertHTML = `
            <div class="bg-${alertType}-50 border-l-4 border-${alertType}-500 p-4 rounded-r">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <span class="material-icons text-${alertType}-600">${icon}</span>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-medium text-${alertType}-800">${alert.event}</h3>
                        <p class="text-sm text-${alertType}-700">${alert.description}</p>
                        <div class="mt-2 text-xs text-${alertType}-600">
                            <p>From: ${startDate}</p>
                            <p>To: ${endDate}</p>
                            <p class="mt-1">Source: ${alert.sender_name}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

                alertsList.insertAdjacentHTML('beforeend', alertHTML);
            });
        }

        // Update forecast UI
        function updateForecastUI(forecastData) {
            console.log('Forecast data received:', forecastData);

            // Group forecast by day
            const dailyForecast = [];
            const currentDate = new Date();

            // First, group all forecast items by day
            const forecastByDay = {};

            // Process each forecast item
            // First, log all forecast timestamps
            console.log('All forecast timestamps:');
            forecastData.list.forEach((item, index) => {
                const date = new Date(item.dt * 1000);
                console.log(`  [${index}] ${date.toString()} - ${date.toLocaleDateString('en-US', { weekday: 'long' })}`);
            });

            forecastData.list.forEach(item => {
                const date = new Date(item.dt * 1000);
                const dayKey = date.toDateString(); // Full date string to group by day
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                console.log(`Processing: ${dayKey} (${dayName})`);

                if (!forecastByDay[dayKey]) {
                    forecastByDay[dayKey] = {
                        date: date,
                        temp_max: -Infinity,
                        temp_min: Infinity,
                        weather: item.weather[0],
                        dt: item.dt,
                        items: []
                    };
                }

                forecastByDay[dayKey].items.push(item);

                // Update max/min temps
                if (item.main.temp_max > forecastByDay[dayKey].temp_max) {
                    forecastByDay[dayKey].temp_max = item.main.temp_max;
                }

                if (item.main.temp_min < forecastByDay[dayKey].temp_min) {
                    forecastByDay[dayKey].temp_min = item.main.temp_min;
                    forecastByDay[dayKey].weather = item.weather[0];
                }
            });

            // Convert to array and sort by date
            const sortedForecast = Object.values(forecastByDay).sort((a, b) => a.dt - b.dt);

            // Debug: Log all forecast days we found
            console.log('Processed forecast days:');
            sortedForecast.forEach((forecast, idx) => {
                const date = new Date(forecast.dt * 1000);
                console.log(`  [${idx}] ${date.toDateString()} (${date.toLocaleDateString('en-US', { weekday: 'long' })})`);
            });

            // Generate forecast HTML for the next 7 days
            let forecastHTML = '';
            const today = new Date();

            // Debug: Log the structure of the first forecast item
            if (sortedForecast.length > 0) {
                console.log('First forecast item structure:', JSON.stringify(sortedForecast[0], null, 2));
            }

            // Create an array of the next 7 days
            const next7Days = Array.from({ length: 7 }, (_, i) => {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                return date;
            });

            // Debug: Log the next 7 days we want to show
            console.log('Next 7 days to show:');
            next7Days.forEach((d, i) => {
                console.log(`  [${i}] ${d.toDateString()} (${d.toLocaleDateString('en-US', { weekday: 'long' })})`);
            });

            // For each of the next 7 days, calculate max/min temp from all 3-hour entries for that day
            next7Days.forEach((date, index) => {
                const dateString = date.toDateString();
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const isToday = index === 0;
                const borderClass = isToday ? 'border-2 border-green-500' : 'border border-gray-200';

                // Find all forecast entries for this day
                const dayEntries = forecastData.list.filter(item => {
                    const itemDate = new Date(item.dt * 1000);
                    return itemDate.toDateString() === dateString;
                });

                let tempMax = null;
                let tempMin = null;
                let icon = '01d';
                let desc = 'N/A';

                if (dayEntries.length > 0) {
                    tempMax = Math.max(...dayEntries.map(e => e.main.temp_max));
                    tempMin = Math.min(...dayEntries.map(e => e.main.temp_min));
                    // Use the icon/desc from the midday entry if possible
                    const midday = dayEntries[Math.floor(dayEntries.length / 2)];
                    icon = midday.weather[0].icon;
                    desc = midday.weather[0].description;
                }
                if (dayEntries.length > 0) {
                    tempMax = Math.max(...dayEntries.map(e => e.main.temp_max));
                    tempMin = Math.min(...dayEntries.map(e => e.main.temp_min));
                    // Use the icon/desc from the midday entry if possible
                    const midday = dayEntries[Math.floor(dayEntries.length / 2)];
                    icon = midday.weather[0].icon;
                    desc = midday.weather[0].description;
                }

                const displayMax = tempMax !== null ? Math.round(tempMax) : 'N/A';
                const displayMin = tempMin !== null ? Math.round(tempMin) : 'N/A';

                // Ensure we have valid data for attributes, use fallback values if null
                const safeTempMax = tempMax !== null && !isNaN(tempMax) ? tempMax : 25;
                const safeTempMin = tempMin !== null && !isNaN(tempMin) ? tempMin : 20;
                const safeHumidity = dayEntries.length > 0 ? Math.round(dayEntries.reduce((sum, e) => sum + e.main.humidity, 0) / dayEntries.length) : 50;
                const safeRain = dayEntries.length > 0 ? (dayEntries.reduce((sum, e) => sum + (e.rain?.['3h'] || 0), 0) / 3) : 0;
                const safeClouds = dayEntries.length > 0 ? Math.round(dayEntries.reduce((sum, e) => sum + e.clouds.all, 0) / dayEntries.length) : 30;
                const safeWind = dayEntries.length > 0 ? Math.round(dayEntries.reduce((sum, e) => sum + e.wind.speed, 0) / dayEntries.length) : 5;

                forecastHTML += `
            <div class="bg-white rounded-lg p-4 text-center hover:shadow-lg transition-all cursor-pointer forecast-day" 
                 id="day-${index}"
                 data-date="${dateString}" 
                 data-temp-max="${safeTempMax}" 
                 data-temp-min="${safeTempMin}" 
                 data-humidity="${safeHumidity}"
                 data-rain="${safeRain}"
                 data-clouds="${safeClouds}"
                 data-wind="${safeWind}"
                 data-day-name="${dayName}"
                 onclick="selectDay(this, ${index})">
                <p class="font-semibold text-gray-800">${isToday ? 'Today' : dayName}</p>
                <img src="${getWeatherIconUrl(icon)}" alt="${desc}" class="w-16 h-16 mx-auto my-2">
                <p class="text-sm text-gray-600">Max: ${displayMax}Â°C</p>
                <p class="text-sm text-gray-600">Min: ${displayMin}Â°C</p>
                <p class="text-sm text-gray-600 capitalize">${desc}</p>
                <p class="text-xs text-blue-600 mt-2">Click to analyze</p>
            </div>
        `;
            });

            forecastContainer.innerHTML = forecastHTML || '<p class="text-gray-600">No forecast data available</p>';
        }

        // Update pest risk based on weather conditions
        function calculatePestRisk(weatherData) {
            console.log('Calculating pest risk with data:', weatherData);

            // Use the new pest analysis system if available
            if (typeof updatePestRiskUI === 'function') {
                // Pass location context if available for location-aware pest filtering
                const locationContext = window.currentLocationContext || null;
                updatePestRiskUI('pestRiskContent', weatherData, getCurrentLanguage(), locationContext);
                return;
            }

            // Fallback to original system if new system not available
            console.log('Using fallback pest risk analysis');

            // Default values if data is missing
            const temp = weatherData.main?.temp || 25;
            const humidity = weatherData.main?.humidity || 50;
            const rain_mm = weatherData.rain?.['1h'] || 0; // rain in last hour in mm
            const cloud_cover = weatherData.clouds?.all || 0; // cloud cover percentage
            const wind_speed = weatherData.wind?.speed || 0; // wind speed in m/s

            console.log(`Weather conditions: temp=${temp}, humidity=${humidity}, rain=${rain_mm}, clouds=${cloud_cover}, wind=${wind_speed}`);

            const risks = [];

            // More relaxed conditions for testing
            // Aphids (High humidity + warm + cloudy)
            if (temp >= 18 && temp <= 35 && humidity > 50 && cloud_cover > 30) {
                risks.push("ðŸ› Aphid risk - Warm + Humid + Cloudy");
            }

            // Whiteflies (Moderate humidity, warm)
            if (temp >= 20 && temp <= 32 && humidity >= 35) {
                risks.push("â˜ï¸ Whitefly risk - Ideal growth range");
            }

            // Red Spider Mites (Hot + Dry)
            if (temp > 25 && humidity < 60) {
                risks.push("ðŸ•·ï¸ Red Spider Mite risk - Hot & Dry");
            }

            // Stem Borers (Warm + calm wind + cloudy)
            if (temp > 20 && wind_speed < 8 && cloud_cover > 40) {
                risks.push("ðŸŒ¾ Stem Borer risk - Still & cloudy");
            }

            // Fungal Infections (Rainy + Humid)
            if (rain_mm > 0.5 && humidity > 70) {
                risks.push("ðŸ„ Fungal risk - Wet leaf conditions");
            }

            // Thrips (Hot + Dry + Windy)
            if (temp > 24 && humidity < 65 && wind_speed > 5) {
                risks.push("ðŸŒ¬ï¸ Thrips risk - Hot + dry + windy");
            }

            // Leafhoppers (Moderate temps + rain)
            if (temp >= 22 && temp <= 35 && rain_mm > 0.1) {
                risks.push("ðŸƒ Leafhopper risk - Moderate temps with rain");
            }

            // Shoot Flies (Dry + Moderate rain)
            if (temp >= 24 && temp <= 40 && rain_mm >= 0.1 && rain_mm <= 8 && humidity < 70) {
                risks.push("ðŸž Shoot fly risk - Moderate rainfall");
            }

            // Bollworms (Warm nights + humidity)
            if (temp > 20 && humidity > 45) {
                risks.push("ðŸ§¨ Bollworm risk - Night warmth + moisture");
            }

            // Armyworms (High humidity + rainfall + moderate temp)
            if (humidity > 60 && rain_mm > 0.1 && temp >= 18 && temp <= 35) {
                risks.push("ðŸª– Armyworm risk - Stormy weather pest");
            }

            console.log('Detected risks:', risks);

            // Update the UI with the pest risk information
            const pestRiskContent = document.getElementById('pestRiskContent');

            if (risks.length > 0) {
                const currentLang = getCurrentLanguage();
                const translatedRisks = translatePestRisks(risks, currentLang);

                console.log('Translated risks:', translatedRisks);

                pestRiskContent.innerHTML = `
            <div class="space-y-2">
                <p class="font-semibold text-red-600">ðŸš¨ Potential Pest Risks Detected:</p>
                <ul class="list-disc list-inside space-y-1">
                    ${translatedRisks.map(risk => `<li>${risk}</li>`).join('')}
                </ul>
                <p class="text-sm text-gray-600 mt-2">Please monitor your fields and take preventive measures if necessary.</p>
            </div>
        `;
                pestRiskContent.className = 'bg-red-50 border-l-4 border-red-500 p-4 rounded-r';
            } else {
                console.log('No risks detected, showing low risk message');
                pestRiskContent.innerHTML = `
            <div class="flex items-center">
                <span class="text-green-600 mr-2">âœ…</span>
                <p class="text-gray-700">No significant pest risks detected for current weather conditions.</p>
            </div>
            <p class="text-sm text-gray-600 mt-2">Weather conditions: ${temp}Â°C, ${humidity}% humidity, ${rain_mm}mm rain. Continue with regular monitoring of your crops.</p>
        `;
                pestRiskContent.className = 'bg-green-50 border-l-4 border-green-500 p-4 rounded-r';
            }
        }

        // Get irrigation advice based on weather conditions and crop type
        function getIrrigationAdvice(weatherData, cropType = "general") {
            const temp = weatherData.main?.temp || 25;
            const humidity = weatherData.main?.humidity || 50;
            const rain_mm = weatherData.rain?.['1h'] || 0; // rain in last hour in mm
            const wind_speed = (weatherData.wind?.speed || 0) * 3.6; // convert m/s to km/h
            const cloud_cover = weatherData.clouds?.all || 0; // cloud cover percentage

            // Rainfall based advice
            if (rain_mm > 10) {
                return {
                    icon: "ðŸŒ§ï¸",
                    advice: "Heavy rainfall detected. Skip irrigation today to prevent overwatering."
                };
            } else if (rain_mm >= 3 && rain_mm <= 10) {
                return {
                    icon: "â˜ï¸",
                    advice: "Light rainfall recorded. Irrigation can be skipped or reduced depending on soil moisture."
                };
            }

            // Hot and dry
            if (temp > 32 && humidity < 40) {
                return {
                    icon: "ðŸ”¥",
                    advice: "High heat and low humidity. Increase irrigation frequency. Water early morning or late evening."
                };
            }

            // Fungal disease weather
            if (humidity > 80 && cloud_cover > 60 && wind_speed < 5) {
                return {
                    icon: "ðŸ„",
                    advice: "Very humid and cloudy. Avoid unnecessary watering to prevent fungal infections."
                };
            }

            // Windy weather
            if (wind_speed > 15) {
                return {
                    icon: "ðŸ’¨",
                    advice: "Windy conditions detected. Water more deeply but less frequently, as surface moisture will evaporate quickly."
                };
            }

            // Cool and dry
            if (temp < 18 && rain_mm === 0) {
                return {
                    icon: "ðŸŒ¥ï¸",
                    advice: "Cool weather and no rain. Reduce irrigation â€” plant growth is slow and water need is low."
                };
            }

            // Crop-specific advice
            const cropAdvice = {
                "rice": "ðŸŒ¾ Rice needs frequent irrigation. If no rainfall, maintain standing water in fields.",
                "wheat": "ðŸŒ¾ Wheat requires irrigation every 8â€“10 days in winter. Adjust based on soil dryness.",
                "sugarcane": "ðŸ¬ Sugarcane prefers irrigation every 6â€“7 days in hot weather.",
                "vegetables": "ðŸ¥¬ Most vegetables need water every 2â€“3 days. Avoid wetting leaves in evening.",
                "cotton": "ðŸ§µ Cotton prefers deep irrigation every 6â€“8 days. Don't flood the field.",
                "general": "âœ… Weather is normal. Follow your standard irrigation schedule based on crop and soil."
            };

            // Get the appropriate advice based on crop type
            const advice = cropAdvice[cropType.toLowerCase()] || cropAdvice.general;

            return {
                icon: cropType === "general" ? "âœ…" : advice.match(/^[^a-zA-Z0-9]*/)[0],
                advice: cropType === "general" ? advice : advice.replace(/^[^a-zA-Z0-9]*/, '')
            };
        }

        // Update agricultural advice based on weather
        function updateAgriculturalAdvice(weatherData) {
            // Get irrigation advice (default to general advice)
            const { icon, advice } = getIrrigationAdvice(weatherData, "general");

            // Update the UI
            const irrigationAdviceElement = document.getElementById('irrigationAdvice') || document.querySelector('.irrigation-advice');
            if (irrigationAdviceElement) {
                irrigationAdviceElement.innerHTML = `
            <div class="flex items-start">
                <span class="text-2xl mr-3 mt-1">${icon}</span>
                <div>
                    <h3 class="font-semibold text-gray-800">Irrigation Advice</h3>
                    <p class="text-gray-600">${advice}</p>
                </div>
            </div>
        `;
            }
        }

        // Select a day and update pest risk and irrigation advice
        function selectDay(dayElement, dayIndex) {
            console.log('selectDay called with:', dayElement, dayIndex);

            // Remove highlight from all days
            document.querySelectorAll('.forecast-day').forEach(day => {
                day.classList.remove('border-4', 'border-blue-500', 'bg-blue-50');
                day.classList.add('bg-white');
            });

            // Highlight selected day
            dayElement.classList.add('border-4', 'border-blue-500', 'bg-blue-50');
            dayElement.classList.remove('bg-white');

            const date = dayElement.getAttribute('data-date');
            const tempMax = parseFloat(dayElement.getAttribute('data-temp-max'));
            const tempMin = parseFloat(dayElement.getAttribute('data-temp-min'));
            const humidity = parseInt(dayElement.getAttribute('data-humidity'));
            const rain = parseFloat(dayElement.getAttribute('data-rain'));
            const clouds = parseInt(dayElement.getAttribute('data-clouds'));
            const windSpeed = parseFloat(dayElement.getAttribute('data-wind'));
            const dayName = dayElement.getAttribute('data-day-name');

            console.log('Day data:', { date, tempMax, tempMin, humidity, rain, clouds, windSpeed, dayName });

            // Average temperature for calculations
            const avgTemp = (tempMax + tempMin) / 2;

            // Create weather data object for this day
            const dayWeatherData = {
                main: {
                    temp: avgTemp,
                    temp_max: tempMax,
                    temp_min: tempMin,
                    humidity: humidity
                },
                rain: {
                    '1h': rain
                },
                clouds: {
                    all: clouds
                },
                wind: {
                    speed: windSpeed
                }
            };

            console.log('Created weather data for day:', dayWeatherData);

            try {
                // Update pest risk section
                console.log('Updating pest risk for day...');
                updatePestRiskForDay(dayWeatherData, dayName, date);

                // Update irrigation advice section
                console.log('Updating irrigation advice for day...');
                updateIrrigationAdviceForDay(dayWeatherData, dayName, date);

                console.log('Day analysis complete');
            } catch (error) {
                console.error('Error in selectDay:', error);
            }
        }

        // Update pest risk section for selected day
        function updatePestRiskForDay(weatherData, dayName, date) {
            console.log('updatePestRiskForDay called with:', weatherData, dayName, date);

            const pestRiskContent = document.getElementById('pestRiskContent');
            if (!pestRiskContent) {
                console.error('pestRiskContent element not found!');
                return;
            }

            const risks = calculateDayPestRisk(weatherData);
            console.log('Calculated risks:', risks);

            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

            // Update pest risk container title
            const pestRiskTitle = document.querySelector('#pestRiskContainer h2');
            if (pestRiskTitle) {
                pestRiskTitle.textContent = `Pest Risk Analysis - ${formattedDate}`;
            }

            if (risks.length > 0) {
                pestRiskContent.innerHTML = `
            <div class="space-y-2">
                <div class="flex items-center mb-3">
                    <span class="material-icons text-red-500 mr-2">warning</span>
                    <p class="font-semibold text-red-600">ðŸš¨ Potential Pest Risks Detected</p>
                </div>
                <ul class="list-disc list-inside space-y-1">
                    ${risks.map(risk => `<li class="text-gray-700">${risk}</li>`).join('')}
                </ul>
                <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r">
                    <p class="text-sm text-yellow-800 font-medium mb-3">Recommendations</p>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li>Monitor crops regularly for early detection</li>
                        <li>Maintain proper field hygiene</li>
                        <li>Use integrated pest management approaches</li>
                        <li>Consult local agricultural extension services if needed</li>
                    </ul>
                </div>
            </div>
        `;
                pestRiskContent.className = 'bg-red-50 border-l-4 border-red-500 p-4 rounded-r';
            } else {
                pestRiskContent.innerHTML = `
            <div class="flex items-center">
                <span class="material-icons text-green-600 mr-2">check_circle</span>
                <div>
                    <p class="text-gray-700 font-medium">âœ… Low pest risk detected</p>
                    <p class="text-sm text-gray-600 mt-1">Weather conditions: ${Math.round(weatherData.main.temp)}Â°C, ${weatherData.main.humidity}% humidity</p>
                </div>
            </div>
        `;
                pestRiskContent.className = 'bg-green-50 border-l-4 border-green-500 p-4 rounded-r';
            }

            console.log('Pest risk content updated for', dayName);
        }

        // Simple pest risk translation function
        function translatePestRisks(risks, language) {
            console.log('Translating risks:', risks, 'to language:', language);

            if (!window.translations || !window.translations[language]) {
                console.log('No translations found, returning original risks');
                return risks; // Return original if no translations
            }

            const t = window.translations[language];
            const riskMappings = {
                "Aphid risk": t.aphidRisk || "Aphid risk detected",
                "Whitefly risk": t.whiteflyRisk || "Whitefly risk detected",
                "Red Spider Mite risk": t.spiderMiteRisk || "Spider mite risk detected",
                "Stem Borer risk": t.stemBorerRisk || "Stem borer risk detected",
                "Fungal risk": t.fungalRisk || "Fungal disease risk detected",
                "Thrips risk": t.thripsRisk || "Thrips risk detected",
                "Leafhopper risk": t.leafhopperRisk || "Leafhopper risk detected",
                "Shoot fly risk": t.shootFlyRisk || "Shoot fly risk detected",
                "Bollworm risk": t.bollwormRisk || "Bollworm risk detected",
                "Armyworm risk": t.armywormRisk || "Armyworm risk detected"
            };

            const translatedRisks = risks.map(risk => {
                // Extract the pest type from the risk string
                for (const [key, value] of Object.entries(riskMappings)) {
                    if (risk.includes(key.split(' ')[0])) {
                        console.log(`Translated "${risk}" to "${value}"`);
                        return value;
                    }
                }
                console.log(`No translation found for "${risk}", returning original`);
                return risk; // Return original if no mapping found
            });

            console.log('Final translated risks:', translatedRisks);
            return translatedRisks;
        }

        // Generate pest-specific recommendations based on detected risks
        function generatePestSpecificRecommendations(risks, language = 'en') {
            console.log('generatePestSpecificRecommendations called with:', risks, language);

            // Check if translations are available
            if (!window.translations) {
                console.warn('No translations available, returning basic recommendations');
                return `<ul class="list-disc list-inside space-y-1 text-sm">
            <li>Monitor crops regularly for early detection</li>
            <li>Maintain proper field hygiene</li>
            <li>Use appropriate control measures if needed</li>
            <li>Consult local agricultural extension services</li>
        </ul>`;
            }

            const t = window.translations[language] || window.translations['en'] || {};
            const recommendations = new Set(); // Use Set to avoid duplicates

            risks.forEach(risk => {
                if (risk.includes('Aphid')) {
                    recommendations.add(`ðŸ” <strong>Check undersides of leaves for aphid colonies</strong>`);
                    recommendations.add(`ðŸŒ¿ Encourage beneficial insects like ladybirds and lacewings`);
                    recommendations.add(`ðŸ’§ Avoid excessive nitrogen fertilization`);
                    recommendations.add(`ðŸš¿ Use water spray to dislodge aphids`);
                }

                if (risk.includes('Whitefly')) {
                    recommendations.add(`ðŸŸ¡ <strong>Use yellow sticky traps</strong>`);
                    recommendations.add(`ðŸƒ Apply reflective mulch around plants`);
                    recommendations.add(`ðŸŒ± Plant marigold as companion crop`);
                    recommendations.add(`ðŸ§´ Use neem oil or insecticidal soap`);
                }

                if (risk.includes('Spider Mite')) {
                    recommendations.add(`ðŸ’¨ <strong>Increase humidity with misting</strong>`);
                    recommendations.add(`ðŸ”¬ Check for fine webbing on leaves`);
                    recommendations.add(`ðŸŒ¿ Release predatory mites`);
                    recommendations.add(`ðŸ§½ Wash leaves with water regularly`);
                    recommendations.add(`ðŸš« Remove heavily infested plant parts`);
                }

                if (risk.includes('Stem Borer')) {
                    recommendations.add(`ðŸŒ¾ <strong>Remove and destroy affected plant parts</strong>`);
                    recommendations.add(`ðŸª¤ Use pheromone traps for monitoring`);
                    recommendations.add(`ðŸ¦‹ Release egg parasitoid wasps`);
                    recommendations.add(`ðŸ’Š Apply Bt (Bacillus thuringiensis) spray`);
                    recommendations.add(`ðŸŒ± Practice crop rotation`);
                }

                if (risk.includes('Fungal')) {
                    recommendations.add(`ðŸ„ <strong>Improve air circulation around plants</strong>`);
                    recommendations.add(`â˜€ï¸ Ensure adequate sunlight exposure`);
                    recommendations.add(`ðŸ’§ Water at soil level, avoid wetting leaves`);
                    recommendations.add(`ðŸ§ª Apply preventive fungicide spray`);
                    recommendations.add(`ðŸ—‘ï¸ Remove and destroy infected plant debris`);
                }

                if (risk.includes('Thrips')) {
                    recommendations.add(`ðŸ”µ <strong>Use blue sticky traps</strong>`);
                    recommendations.add(`ðŸŒ¿ Apply diatomaceous earth around plants`);
                    recommendations.add(`ðŸ•·ï¸ Encourage predatory mites and minute pirate bugs`);
                    recommendations.add(`ðŸŒ± Maintain adequate soil moisture`);
                    recommendations.add(`ðŸ§´ Apply neem oil spray`);
                }

                if (risk.includes('Leafhopper')) {
                    recommendations.add(`ðŸƒ <strong>Use row covers during peak activity</strong>`);
                    recommendations.add(`ðŸŒ¾ Remove weeds that harbor leafhoppers`);
                    recommendations.add(`ðŸ•¸ï¸ Apply kaolin clay to confuse pests`);
                    recommendations.add(`ðŸ¦— Encourage beneficial predators`);
                    recommendations.add(`âš¡ Use reflective tape around plants`);
                }

                if (risk.includes('Shoot fly')) {
                    recommendations.add(`ðŸž <strong>Sow early to avoid peak infestation</strong>`);
                    recommendations.add(`ðŸŒ± Use resistant varieties`);
                    recommendations.add(`ðŸ’§ Apply carbofuran granules if severe`);
                    recommendations.add(`ðŸª¤ Use yellow sticky traps`);
                    recommendations.add(`ðŸŒ¾ Practice deep summer plowing`);
                }

                if (risk.includes('Bollworm')) {
                    recommendations.add(`ðŸ§¨ <strong>Monitor for egg masses on leaves</strong>`);
                    recommendations.add(`ðŸŒ™ Use light traps during night hours`);
                    recommendations.add(`ðŸ¦‹ Release Trichogramma wasps`);
                    recommendations.add(`ðŸ§ª Apply Bt spray during larval stage`);
                    recommendations.add(`ðŸŒ» Plant trap crops like marigold`);
                }

                if (risk.includes('Armyworm')) {
                    recommendations.add(`ðŸª– <strong>Dig trenches around fields</strong>`);
                    recommendations.add(`ðŸŒ™ Use light traps to catch adults`);
                    recommendations.add(`ðŸ”¥ Burn egg masses and larvae`);
                    recommendations.add(`ðŸ¦… Encourage insectivorous birds`);
                    recommendations.add(`ðŸ’Š Apply NPV (Nuclear Polyhedrosis Virus)`);
                    recommendations.add(`âš ï¸ Act quickly - armyworms spread rapidly`);
                }
            });

            // Add general recommendations if specific pests detected
            if (recommendations.size > 0) {
                recommendations.add(`ðŸ“… <strong>Schedule regular crop monitoring</strong>`);
                recommendations.add(`ðŸ“Š Keep records of pest occurrences and treatments`);
                recommendations.add(`â˜Žï¸ Contact local agricultural extension officer if needed`);
                recommendations.add(`ðŸŒ¡ï¸ Monitor weather conditions for pest management`);
            }

            // Convert to array and create HTML
            const recommendationArray = Array.from(recommendations);

            if (recommendationArray.length === 0) {
                return `<p class="text-sm text-yellow-700">Continue regular crop inspection and monitoring</p>`;
            }

            return `
        <div class="space-y-2">
            ${recommendationArray.map(rec => `
                <div class="text-sm text-yellow-700 p-2 bg-yellow-100 rounded border-l-2 border-yellow-500">
                    ${rec}
                </div>
            `).join('')}
        </div>
    `;
        }

        // Get translated pest risks based on current language
        function getTranslatedPestRisks(englishRisks, language) {
            // This function is not currently used, but keeping for compatibility
            if (!window.translations || !window.translations[language]) {
                return englishRisks; // Return original if no translations
            }

            const t = window.translations[language];

            const riskMappings = {
                "ðŸ› Aphid risk - Warm + Humid + Cloudy conditions favor aphid reproduction": t.aphidRisk || "Aphid risk detected",
                "â˜ï¸ Whitefly risk - Ideal temperature and humidity range for whitefly development": t.whiteflyRisk || "Whitefly risk detected",
                "ðŸ•·ï¸ Red Spider Mite risk - Hot and dry conditions promote spider mite infestation": t.spiderMiteRisk || "Spider mite risk detected",
                "ðŸŒ¾ Stem Borer risk - Still and cloudy weather increases stem borer activity": t.stemBorerRisk || "Stem borer risk detected",
                "ðŸ„ Fungal disease risk - Wet and humid conditions promote fungal growth": t.fungalRisk || "Fungal disease risk detected",
                "ðŸŒ¬ï¸ Thrips risk - Hot, dry and windy conditions favor thrips infestation": t.thripsRisk || "Thrips risk detected",
                "ðŸƒ Leafhopper risk - Moderate temperature with rainfall increases leafhopper activity": t.leafhopperRisk || "Leafhopper risk detected",
                "ðŸž Shoot fly risk - Moderate rainfall with dry conditions favor shoot fly breeding": t.shootFlyRisk || "Shoot fly risk detected",
                "ðŸ§¨ Bollworm risk - Warm temperature with high humidity increases bollworm activity": t.bollwormRisk || "Bollworm risk detected",
                "ðŸª– Armyworm risk - Humid and rainy conditions with moderate temperature favor armyworm outbreaks": t.armywormRisk || "Armyworm risk detected"
            };

            return englishRisks.map(risk => riskMappings[risk] || risk);
        }

        // Update irrigation advice section for selected day
        function updateIrrigationAdviceForDay(weatherData, dayName, date) {
            console.log('updateIrrigationAdviceForDay called with:', weatherData, dayName, date);

            const irrigationAdviceElement = document.getElementById('irrigationAdvice');
            if (!irrigationAdviceElement) {
                console.error('irrigationAdvice element not found!');
                return;
            }

            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

            // Update irrigation advice container title
            const irrigationTitle = document.querySelector('#irrigationAdvice').parentElement.querySelector('h2');
            if (irrigationTitle) {
                irrigationTitle.textContent = `Irrigation Advice - ${formattedDate}`;
            }

            // Get basic irrigation advice based on weather
            const temp = weatherData.main.temp;
            const humidity = weatherData.main.humidity;
            const rain = weatherData.rain?.['1h'] || 0;

            let advice = "Follow standard irrigation schedule based on crop and soil.";
            let icon = "ðŸ’§";

            if (rain > 5) {
                advice = "Heavy rainfall detected. Skip irrigation today to prevent overwatering.";
                icon = "ðŸŒ§ï¸";
            } else if (rain > 1) {
                advice = "Light rainfall recorded. Reduce irrigation or skip depending on soil moisture.";
                icon = "ðŸŒ¦ï¸";
            } else if (temp > 30 && humidity < 50) {
                advice = "High heat and low humidity. Increase irrigation frequency. Water early morning or late evening.";
                icon = "ðŸ”¥";
            } else if (humidity > 80) {
                advice = "Very humid conditions. Avoid unnecessary watering to prevent fungal infections.";
                icon = "ðŸ’¨";
            } else if (temp < 15) {
                advice = "Cool weather. Reduce irrigation as plant growth is slow and water need is low.";
                icon = "â„ï¸";
            }

            irrigationAdviceElement.innerHTML = `
        <div class="flex items-start">
            <span class="text-2xl mr-3 mt-1">${icon}</span>
            <div>
                <h3 class="font-semibold text-gray-800">Irrigation Recommendation</h3>
                <p class="text-gray-600 mt-1">${advice}</p>
                <div class="mt-3 text-sm text-gray-500">
                    <p><strong>Weather Conditions:</strong> ${Math.round(temp)}Â°C, ${humidity}% humidity</p>
                    ${rain > 0 ? `<p><strong>Rainfall:</strong> ${rain.toFixed(1)}mm</p>` : ''}
                </div>
            </div>
        </div>
    `;

            console.log('Irrigation advice content updated for', dayName);
        }

        // Calculate pest risk for a specific day
        function calculateDayPestRisk(weatherData) {
            console.log('calculateDayPestRisk called with:', weatherData);

            const temp = weatherData.main?.temp || 25;
            const humidity = weatherData.main?.humidity || 50;
            const rain_mm = weatherData.rain?.['1h'] || 0;
            const cloud_cover = weatherData.clouds?.all || 30;
            const wind_speed = weatherData.wind?.speed || 5;

            console.log(`Weather conditions: temp=${temp}Â°C, humidity=${humidity}%, rain=${rain_mm}mm, clouds=${cloud_cover}%, wind=${wind_speed}m/s`);

            const risks = [];

            // More lenient conditions for testing - Aphids
            if (temp >= 18 && temp <= 32 && humidity > 45) {
                risks.push("ðŸ› Aphid risk - Favorable temperature and humidity conditions");
            }

            // Whiteflies (broader range for testing)
            if (temp >= 20 && temp <= 30 && humidity >= 35) {
                risks.push("â˜ï¸ Whitefly risk - Suitable temperature and humidity range");
            }

            // Red Spider Mites (hot and dry conditions)
            if (temp > 25 && humidity < 60) {
                risks.push("ðŸ•·ï¸ Red Spider Mite risk - Hot and relatively dry conditions");
            }

            // Stem Borers (warm and still conditions)
            if (temp > 22 && wind_speed < 8) {
                risks.push("ðŸŒ¾ Stem Borer risk - Warm temperature with calm winds");
            }

            // Fungal Infections (humid conditions)
            if (humidity > 70 || rain_mm > 1) {
                risks.push("ðŸ„ Fungal disease risk - High humidity or rainfall conditions");
            }

            // Thrips (warm and windy)
            if (temp > 24 && wind_speed > 3) {
                risks.push("ðŸŒ¬ï¸ Thrips risk - Warm and breezy conditions");
            }

            // Leafhoppers (moderate temps)
            if (temp >= 22 && temp <= 30) {
                risks.push("ðŸƒ Leafhopper risk - Moderate temperature range");
            }

            // Bollworms (warm conditions)
            if (temp > 23 && humidity > 40) {
                risks.push("ðŸ§¨ Bollworm risk - Warm conditions with adequate humidity");
            }

            console.log('Detected risks:', risks);
            return risks;
        }

        // Load weather data for a location
        async function loadWeatherData(location) {
            console.log('Loading weather data for:', location);

            try {
                const weatherData = await fetchWeatherData(location);
                console.log('Weather data received:', weatherData);

                currentLocation = weatherData.current;
                currentForecastData = weatherData.forecast; // Store forecast globally
                updateWeatherUI(weatherData.current);
                updateForecastUI(weatherData.forecast);

                return weatherData;
            } catch (error) {
                console.error('Error loading weather data:', error);
                throw error;
            }
        }

        // Handle search
        async function handleSearch() {
            if (!locationInput) {
                console.error('Location input not found');
                return;
            }

            const location = locationInput.value.trim();

            if (!location) {
                if (locationError) {
                    locationError.classList.remove('hidden');
                }
                return;
            }

            if (locationError) {
                locationError.classList.add('hidden');
            }

            try {
                // Show loading state
                if (locationName) {
                    locationName.textContent = 'Loading...';
                }
                if (currentTemp) {
                    currentTemp.textContent = '--Â°C';
                }
                if (weatherDescription) {
                    weatherDescription.textContent = 'Fetching weather data...';
                }

                await loadWeatherData(location);

            } catch (error) {
                console.error('Search error:', error);

                const errorMessage = error.message || 'Could not fetch weather data. Please check the location and try again.';
                alert(`Error: ${errorMessage}`);

                // Reset to default state
                if (locationName) {
                    locationName.textContent = 'Search for a location';
                }
                if (currentTemp) {
                    currentTemp.textContent = '--Â°C';
                }
                if (weatherDescription) {
                    weatherDescription.textContent = 'Enter a location to see weather';
                }
            }
        }

        // ==================== Maharashtra Weather Intelligence Update Functions ====================

        async function updateMaharashtraIntelligenceSections(weatherData) {
            if (!maharashtraContext) {
                console.warn('Maharashtra context not initialized');
                return;
            }

            try {
                // Get location context
                currentLocationContext = maharashtraContext.getLocationContext(weatherData.name);
                window.currentLocationContext = currentLocationContext; // Make globally accessible
                
                // Show sections only if location is in Maharashtra
                if (currentLocationContext && currentLocationContext.district !== 'Unknown') {
                    // Update all sections
                    updateLocationContextUI(currentLocationContext);
                    updateSeasonalSectionUI(weatherData, currentLocationContext);
                    updateRegionalAlertsUI(weatherData, currentLocationContext);
                    updateCropAdvisoriesUI(weatherData, currentLocationContext);
                    updateWaterManagementUI(weatherData, currentLocationContext);
                    
                    // Update farm operations with forecast data if available
                    if (currentForecastData) {
                        updateFarmOperationsSectionUI(weatherData, currentForecastData, currentLocationContext);
                    }
                    
                    console.log(' Maharashtra sections updated for:', weatherData.name);
                } else {
                    // Hide Maharashtra-specific sections for non-Maharashtra locations
                    hideMarahaashtraSections();
                    console.log('Location outside Maharashtra - sections hidden');
                }
            } catch (error) {
                console.error('Error updating Maharashtra sections:', error);
            }
        }

        function updateLocationContextUI(context) {
            const section = document.getElementById('locationContextSection');
            const content = document.getElementById('locationContextContent');
            
            if (!section || !content ||  !context) return;
            
            section.classList.remove('hidden');
            
            const zoneInfo = context.zone_info || {};
            const commonCropsText = context.common_crops && context.common_crops.length > 0 
                ? context.common_crops.slice(0, 5).map(c => c.name).join(', ')
                : 'Not specified';
            
            content.innerHTML = `
                <div class="bg-white rounded-lg p-4 border border-green-200">
                    <div class="flex items-center mb-2">
                        <span class="material-icons text-green-600 mr-2">location_city</span>
                        <h3 class="font-bold text-gray-800" data-translate="district">District</h3>
                    </div>
                    <p class="text-lg text-gray-700">${context.district}</p>
                </div>
                <div class="bg-white rounded-lg p-4 border border-blue-200">
                    <div class="flex items-center mb-2">
                        <span class="material-icons text-blue-600 mr-2">terrain</span>
                        <h3 class="font-bold text-gray-800" data-translate="agroclimaticZone">Agroclimatic Zone</h3>
                    </div>
                    <p class="text-lg text-gray-700">${context.agroclimatic_zone}</p>
                    ${zoneInfo description ? `<p class="text-sm text-gray-600 mt-1">${zoneInfo.description}</p>` : ''}
                </div>
                <div class="bg-white rounded-lg p-4 border border-amber-200">
                    <div class="flex items-center mb-2">
                        <span class="material-icons text-amber-600 mr-2">spa</span>
                        <h3 class="font-bold text-gray-800" data-translate="commonCrops">Common Crops</h3>
                    </div>
                    <p class="text-sm text-gray-700">${commonCropsText}</p>
                </div>
            `;
        }

        function updateSeasonalSectionUI(weatherData, context) {
            const section = document.getElementById('seasonalSection');
            if (!section || !seasonalCalendar) return;
            
            section.classList.remove('hidden');
            
            // Get current season and monsoon status
            const currentSeason = maharashtraContext.getCurrentSeason();
            const monsoonStatus = seasonalCalendar.getMonsoonStatus();
            const seasonal = maharashtraContext.getSeasonalContext(new Date(), context.agroclimatic_zone);
            
            // Update monsoon tracker
            const monsoonContent = document.getElementById('monsoonTrackerContent');
            if (monsoonContent && currentSeason) {
                let monsoonHTML = '';
                
                if (monsoonStatus.is_monsoon_season) {
                    monsoonHTML = `
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl">${monsoonStatus.icon}</span>
                                <span class="text-sm font-semibold px-3 py-1 rounded-full ${
                                    monsoonStatus.phase === 'active' ? 'bg-blue-100 text-blue-800' :
                                    monsoonStatus.phase === 'onset' ? 'bg-green-100 text-green-800' : 
                                    'bg-gray-100 text-gray-800'
                                }">${monsoonStatus.phase_name}</span>
                            </div>
                            <p class="text-gray-700 mb-2">${monsoonStatus.phase_description}</p>
                            ${monsoonStatus.rainfall_status ? `
                                <div class="mt-3 p-3 rounded-lg ${
                                    monsoonStatus.rainfall_status.status === 'adequate' ? 'bg-green-50' :
                                    monsoonStatus.rainfall_status.status === 'deficient' ? 'bg-yellow-50' :
                                    monsoonStatus.rainfall_status.status === 'excess' ? 'bg-blue-50' :
                                    'bg-red-50'
                                }">
                                    <p class="text-sm font-medium">${monsoonStatus.rainfall_status.icon} ${monsoonStatus.rainfall_status.message}</p>
                                    <p class="text-xs text-gray-600 mt-1">${monsoonStatus.rainfall_status.concern}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    if (monsoonStatus.alerts && monsoonStatus.alerts.length > 0) {
                        monsoonHTML += `<div class="space-y-2 mt-4">`;
                        monsoonStatus.alerts.forEach(alert => {
                            monsoonHTML += `
                                <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                                    <p class="text-sm font-medium text-blue-900">${alert.icon} ${alert.message}</p>
                                </div>
                            `;
                        });
                        monsoonHTML += `</div>`;
                    }
                } else {
                    monsoonHTML = `
                        <div class="text-gray-600">
                            <p class="mb-2">â˜€ï¸ Outside monsoon season</p>
                            <p class="text-sm">Monsoon expected: June-October</p>
                        </div>
                    `;
                }
                
                monsoonContent.innerHTML = monsoonHTML;
            }
            
            // Update seasonal calendar
            const calendarContent = document.getElementById('seasonalCalendarContent');
            if (calendarContent && seasonal && seasonal.season) {
                let calendarHTML = `
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${seasonal.season.name} Season</h3>
                        <p class="text-sm text-gray-600">${seasonal.season.description}</p>
                        <div class="grid grid-cols-2 gap-2 mt-3 text-sm">
                            <div>
                                <span class="font-medium">Sowing:</span> ${seasonal.season.sowing_period}
                            </div>
                            <div>
                                <span class="font-medium">Harvest:</span> ${seasonal.season.harvest_period}
                            </div>
                        </div>
                    </div>
                `;
                
                if (seasonal.activities && seasonal.activities.length > 0) {
                    calendarHTML += `<div class="space-y-2">`;
                    calendarHTML += `<h4 class="font-medium text-gray-800 text-sm">Current Activities:</h4>`;
                    seasonal.activities.forEach(activity => {
                        calendarHTML += `
                            <div class="bg-green-50 p-2 rounded text-sm">
                                <p class="font-medium text-green-900">${activity.description}</p>
                            </div>
                        `;
                    });
                    calendarHTML += `</div>`;
                }
                
                calendarContent.innerHTML = calendarHTML;
            }
        }

        function updateRegionalAlertsUI(weatherData, context) {
            const section = document.getElementById('regionalAlertsSection');
            const content = document.getElementById('regionalAlertsContent');
            
            if (!section || !content || !maharashtraAlerts) return;
            
            const weather = {
                temp: weatherData.main.temp,
                humidity: weatherData.main.humidity,
                wind_speed: weatherData.wind ? weatherData.wind.speed : 0,
                rain: weatherData.rain
            };
            
            const alerts = maharashtraAlerts.generateAlerts(weather, context);
            
            if (alerts && alerts.length > 0) {
                section.classList.remove('hidden');
                
                let alertsHTML = '';
                alerts.forEach(alert => {
                    const severityColor = 
                        alert.severity === 'critical' ? 'red' :
                        alert.severity === 'high' ? 'orange' :
                        alert.severity === 'moderate' ? 'yellow' :
                        'blue';
                    
                    alertsHTML += `
                        <div class="bg-${severityColor}-50 border-l-4 border-${severityColor}-500 p-4 rounded-r">
                            <div class="flex items-start">
                                <span class="text-2xl mr-3">${alert.icon}</span>
                                <div class="flex-1">
                                    <h3 class="font-bold text-${severityColor}-900 mb-1">${alert.title}</h3>
                                    <p class="text-sm text-${severityColor}-800 mb-2">${alert.message}</p>
                                    ${alert.recommendations && alert.recommendations.length > 0 ? `
                                        <ul class="text-sm text-${severityColor}-700 space-y-1 list-disc list-inside">
                                            ${alert.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                        </ul>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                content.innerHTML = alertsHTML;
            } else {
                section.classList.add('hidden');
            }
        }

        function updateCropAdvisoriesUI(weatherData, context) {
            const section = document.getElementById('cropAdvisoriesSection');
            const content = document.getElementById('cropAdvisoriesContent');
            
            if (!section || !content || !cropWeatherAdvisor) return;
            
            const weather = {
                temp: weatherData.main.temp,
                humidity: weatherData.main.humidity,
                rain: weatherData.rain
            };
            
            const advisories = cropWeatherAdvisor.getCropAdvisories(weather, context);
            
            if (advisories && advisories.advisories && advisories.advisories.length > 0) {
                section.classList.remove('hidden');
                
                let advisoriesHTML = '';
                advisories.advisories.slice(0, 6).forEach(advisory => {
                    const statusColor = 
                        advisory.overall_status === 'suitable' ? 'green' :
                        advisory.overall_status === 'caution' ? 'yellow' :
                        'red';
                    
                    advisoriesHTML += `
                        <div class="bg-white border-2 border-${statusColor}-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-gray-800">${advisory.crop_name}</h3>
                                <span class="text-2xl">${advisory.status_icon}</span>
                            </div>
                            ${advisory.issues && advisory.issues.length > 0 ? `
                                <div class="text-sm text-gray-700 mb-2">
                                    ${advisory.issues.map(issue => `<p>âš ï¸ ${issue}</p>`).join('')}
                                </div>
                            ` : ''}
                            ${advisory.recommendations && advisory.recommendations.length > 0 ? `
                                <div class="text-xs text-gray-600 space-y-1">
                                    ${advisory.recommendations.slice(0, 2).map(rec => `<p>â€¢ ${rec}</p>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                content.innerHTML = advisoriesHTML;
            } else {
                section.classList.add('hidden');
            }
        }

        function updateWaterManagementUI(weatherData, context) {
            const section = document.getElementById('waterManagementSection');
            const content = document.getElementById('waterManagementContent');
            
            if (!section || !content || !waterManager) return;
            
            section.classList.remove('hidden');
            
            const weather = {
                temp: weatherData.main.temp,
                humidity: weatherData.main.humidity,
                wind_speed: weatherData.wind ? weatherData.wind.speed : 0,
                rain: weatherData.rain
            };
            
            const irrigation = waterManager.getIrrigationRecommendation(weather, context);
            const waterStress = waterManager.assessWaterStress(weather, context.agroclimatic_zone);
            
            let waterHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-gray-800 mb-2">ðŸ’§ Irrigation Status</h3>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-medium">ET0:</span> ${irrigation.et0} mm/day</p>
                            <p><span class="font-medium">Crop Water Need:</span> ${irrigation.crop_et} mm/day</p>
                            <p class="text-xs text-gray-600">Rainfall: ${irrigation.rainfall} mm</p>
                        </div>
                        ${irrigation.irrigation_needed === 'yes' ? `
                            <div class="mt-3 p-2 rounded ${
                                irrigation.urgency === 'critical' ? 'bg-red-100 text-red-800' :
                                irrigation.urgency === 'high' ? 'bg-orange-100 text-orange-800' :
                                'bg-yellow-100 text-yellow-800'
                            }">
                                <p class="font-medium text-sm">Irrigation Needed: ${irrigation.recommended_amount_mm} mm</p>
                                <p class="text-xs mt-1">Best time: ${irrigation.best_time}</p>
                            </div>
                        ` : `
                            <div class="mt-3 p-2 rounded bg-green-100 text-green-800">
                                <p class="font-medium text-sm">âœ“ No irrigation needed</p>
                            </div>
                        `}
                    </div>
                    <div class="bg-cyan-50 p-4 rounded-lg">
                        <h3 class="font-bold text-gray-800 mb-2">${waterStress.icon} Water Stress Level</h3>
                        <p class="text-sm mb-2">${waterStress.message}</p>
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>ET0: ${waterStress.et0} mm</span>
                            <span>Rain: ${waterStress.rainfall} mm</span>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-800 mb-2">ðŸ’¡ Recommendations</h4>
                    <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
                        ${irrigation.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            content.innerHTML = waterHTML;
        }

        async function updateFarmOperationsSectionUI(weatherData, forecastData, context) {
            const section = document.getElementById('farmOperationsSection');
            const content = document.getElementById('farmOperationsContent');
            
            if (!section || !content || !farmOpsPlanner) return;
            
            section.classList.remove('hidden');
            
            // Prepare forecast data for the planner
            if (!forecastData || !forecastData.list || forecastData.list.length === 0) {
                content.innerHTML = '<p class="text-gray-600">Forecast data not available</p>';
                return;
            }
            
            const analysis = farmOpsPlanner.analyzeForecast(forecastData.list, context);
            
            let operationsHTML = `
                <div class="space-y-4">
                    ${analysis.map((day, index) => `
                        <div class="border-l-4 ${
                            day.overall === 'excellent' ? 'border-green-500 bg-green-50' :
                            day.overall === 'good' ? 'border-blue-500 bg-blue-50' :
                            day.overall === 'moderate' ? 'border-yellow-500 bg-yellow-50' :
                            'border-red-500 bg-red-50'
                        } p-4 rounded-r-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-gray-800">${day.date}</h3>
                                    <p class="text-xs text-gray-600">${day.summary}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${
                                    day.overall === 'excellent' ? 'bg-green-200 text-green-800' :
                                    day.overall === 'good' ? 'bg-blue-200 text-blue-800' :
                                    day.overall === 'moderate' ? 'bg-yellow-200 text-yellow-800' :
                                    'bg-red-200 text-red-800'
                                }">
                                    ${day.overall.toUpperCase()}
                                </span>
                            </div>
                            
                            ${day.recommended.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-xs font-semibold text-green-700 mb-1">âœ“ Recommended:</p>
                                    <div class="text-xs text-gray-700 space-y-1">
                                        ${day.recommended.slice(0, 3).map(act => 
                                            `<span class="inline-block bg-white px-2 py-1 rounded mr-1 mb-1">${act.activity} (${act.score}/10)</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${day.avoid.length > 0 ? `
                                <div>
                                    <p class="text-xs font-semibold text-red-700 mb-1">âœ— Avoid:</p>
                                    <div class="text-xs text-gray-700 space-y-1">
                                        ${day.avoid.slice(0, 2).map(act => 
                                            `<span class="inline-block bg-white px-2 py-1 rounded mr-1">${act.activity}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            content.innerHTML = operationsHTML;
        }

        function hideMarahaashtraSections() {
            document.getElementById('locationContextSection')?.classList.add('hidden');
            document.getElementById('seasonalSection')?.classList.add('hidden');
            document.getElementById('regionalAlertsSection')?.classList.add('hidden');
            document.getElementById('cropAdvisoriesSection')?.classList.add('hidden');
            document.getElementById('farmOperationsSection')?.classList.add('hidden');
            document.getElementById('waterManagementSection')?.classList.add('hidden');
        }

        // Language handling is now managed by the global translation system

        // Page Transition Functions - Sliding Effect
        function showPageTransition() {
            const transition = document.getElementById('pageTransition');
            document.body.classList.add('page-loading');

            // Start exit animation for current page
            document.body.classList.add('page-exiting');

            // Show transition overlay after a brief delay
            setTimeout(() => {
                transition.classList.add('active');
            }, 100);
        }

        function hidePageTransition() {
            console.log('hidePageTransition called');
            const transition = document.getElementById('pageTransition');
            const header = document.querySelector('header');
            const content = document.querySelector('.page-content');

            console.log('Elements found:', { transition: !!transition, header: !!header, content: !!content });

            // Remove loading and exiting classes
            document.body.classList.remove('page-loading', 'page-exiting');

            // Start slide-in animations
            setTimeout(() => {
                if (header) {
                    header.classList.add('loaded');
                    console.log('Header loaded class added');
                }
                if (content) {
                    content.classList.add('loaded');
                    console.log('Content loaded class added');
                }

                // Hide transition overlay after content starts sliding in
                setTimeout(() => {
                    if (transition) {
                        transition.classList.remove('active');
                        console.log('Transition hidden');
                    }
                }, 300);
            }, 100);
        }

        // Enhanced navigation with smooth slide transitions
        function navigateToPage(url, pageName) {
            showPageTransition();

            // Update loader text
            const loaderText = document.querySelector('.page-transition .text');
            loaderText.textContent = `Loading ${pageName}...`;

            // Navigate after transition animation starts
            setTimeout(() => {
                window.location.href = url;
            }, 600); // Wait for slide animation to complete
        }

        // Add smooth transition to navigation links
        function setupSmoothNavigation() {
            const navLinks = document.querySelectorAll('nav a, .page-nav-link');

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    const pageName = this.textContent.trim();

                    // Don't transition for hash links or external links
                    if (href.startsWith('#') || href.startsWith('http') || href === window.location.pathname) {
                        return;
                    }

                    navigateToPage(href, pageName);
                });
            });
        }

        // Setup smooth navigation
        setupSmoothNavigation();

        // Hide page transition and show content when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            // Ensure transition is hidden and content shows
            setTimeout(() => {
                hidePageTransition();
            }, 100);
        });

    </script>
</body>

</html>