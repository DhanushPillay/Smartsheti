<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSheti - Market Demand & Price Insights</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="../js/translations.js"></script>
    
    <link rel="stylesheet" href="../css/market_demand.css"/>
    <link rel="stylesheet" href="../css/real_time_chart.css"/>
</head>
<body class="page-transition font-sans"
      style="background-color: #EBE4DB;"
      data-page-name="market-demand">
    <!-- Enhanced Header - Same as Home Page -->
    <header class="shadow-sm" style="position: relative;">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="brand-section">
                <img src="../assets/images/plant-logo.svg" alt="SmartSheti Logo" class="w-8 h-8 mr-2"/>
                <span class="text-xl font-bold brand-text">SmartSheti</span>
            </div>
            <nav class="hidden md:flex items-center space-x-4">
                <a class="text-gray-600 hover:text-green-600" href="Home page.html">Home</a>
                <a class="text-gray-600 hover:text-green-600" href="Weather_page(3).html">Weather</a>
                <a class="text-gray-600 hover:text-green-600" href="#">Marketplace</a>
                <a class="font-semibold" href="market_demand.html">Market Demand</a>
            </nav>
            <div class="flex items-center space-x-2 action-buttons">
                <div class="relative">
                    <button id="translateBtn" class="flex items-center text-gray-600 hover:text-green-600" title="Translate">
                        <span class="material-icons mr-1">translate</span>
                        <span id="currentLang">EN</span>
                    </button>
                    <div id="languageDropdown" class="hidden absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="en">English</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="hi">हिंदी</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="mr">मराठी</a>
                    </div>
                </div>
                <button class="text-gray-600 hover:text-green-600">
                    <span class="material-icons">notifications</span>
                </button>
                <div class="relative">
                    <button id="profileBtn" class="text-gray-600 hover:text-green-600">
                        <img alt="User avatar" class="h-8 w-8 rounded-full profile-img" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDfgKVTuoarJ30-OoWjwDrS6uclk5wMjg6jm8_dPaiYCxzJj7a-PRFyYqv-S4wyHqDCxAySMcyi4UfZ2UHFEGN_IUnb5FeGGPcUUDx7agdzfpWQz0v8Wh5WGfIyL7cW4T2tvktCFoWeDu-fxvgw4-feS9R543jxMdvJ4H8aSzWsxDVwob9liEuY9frVJUyFg2RXKIPj7c0U9ddf9W8q3YnblznaFfnvwsfZYSTW0Ay7TqDO9yRPg45dK32yzjuGKKxOALMLJ9Y5Zju7"/>
                    </button>
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Dashboard</a>
                        <hr class="my-1">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Content Starts Here -->
    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <main>
            <h1 class="text-3xl font-bold text-gray-800 mb-6" data-translate="marketDemandTitle">Market Demand & Price Insights</h1>
            
            <!-- Filter Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Crop</label>
                    <select id="cropSelect" class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4 appearance-none text-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option data-translate="selectCrop">Select Crop</option>
                        <option value="wheat" selected data-translate="wheat">Wheat</option>
                        <option value="rice" data-translate="rice">Rice</option>
                        <option value="cotton" data-translate="cotton">Cotton</option>
                        <option value="sugarcane" data-translate="sugarcane">Sugarcane</option>
                        <option value="tomato" data-translate="tomato">Tomato</option>
                        <option value="onion" data-translate="onion">Onion</option>
                        <option value="potato" data-translate="potato">Potato</option>
                        <option value="mango" data-translate="mango">Mango</option>
                        <option value="banana" data-translate="banana">Banana</option>
                        <option value="apple" data-translate="apple">Apple</option>
                    </select>
                    <span class="material-icons absolute right-3 top-9 text-gray-400 pointer-events-none">search</span>
                </div>
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                    <select id="stateSelect" class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4 appearance-none text-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option data-translate="selectState">Select State</option>
                        <option value="Maharashtra" selected>Maharashtra</option>
                        <option value="Gujarat">Gujarat</option>
                        <option value="Punjab">Punjab</option>
                        <option value="Haryana">Haryana</option>
                    </select>
                    <span class="material-icons absolute right-3 top-9 text-gray-400">expand_more</span>
                </div>
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Market</label>
                    <select id="marketSelect" class="w-full bg-white border border-gray-300 rounded-lg py-3 px-4 appearance-none text-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option data-translate="selectMarket">Select Market</option>
                        <option value="Mumbai APMC">Mumbai APMC</option>
                        <option value="Pune APMC" selected>Pune APMC</option>
                        <option value="Nashik APMC">Nashik APMC</option>
                        <option value="Nagpur APMC">Nagpur APMC</option>
                        <option value="Aurangabad APMC">Aurangabad APMC</option>
                    </select>
                    <span class="material-icons absolute right-3 top-3 text-gray-400">expand_more</span>
                </div>
            </div>

            <!-- Price Trend Card -->
            <div class="market-card price-chart border border-green-200 p-6 mb-8">
                <div class="text-center mb-6">
                    <p class="text-gray-600 mb-1" data-translate="priceTrendFor">Price Trend for</p>
                    <span class="text-gray-800 font-semibold text-lg" data-translate="wheat">Wheat</span>
                </div>
                <div class="text-center mb-6">
                    <div class="flex items-baseline justify-center space-x-2 mb-2">
                        <span class="text-4xl font-bold text-gray-800">₹25/<span data-translate="kg">kg</span></span>
                        <span class="text-sm text-green-600 font-semibold">+5%</span>
                    </div>
                    <p class="text-sm text-gray-500" data-translate="last60Days">Last 60 Days</p>
                </div>
                <!-- Line Graph Container -->
                <div id="priceChart" class="relative h-40 mb-4">
                    <!-- Y-axis labels -->
                    <div class="absolute left-0 top-0 h-full flex flex-col justify-between text-xs text-gray-500 pr-2">
                        <span id="maxPrice">₹27.00</span>
                        <span id="highPrice">₹26.00</span>
                        <span id="midPrice">₹25.00</span>
                        <span id="lowPrice">₹24.00</span>
                        <span id="minPrice">₹23.00</span>
                    </div>
                    
                    <!-- Graph area -->
                    <div class="ml-12 relative h-full">
                        <!-- Grid lines -->
                        <div class="absolute inset-0">
                            <div class="h-full flex flex-col justify-between">
                                <div class="border-t border-gray-200"></div>
                                <div class="border-t border-gray-200"></div>
                                <div class="border-t border-gray-200"></div>
                                <div class="border-t border-gray-200"></div>
                                <div class="border-t border-gray-200"></div>
                            </div>
                        </div>
                        
                        <!-- SVG Line Graph -->
                        <svg id="chartSvg" class="w-full h-full" viewBox="0 0 400 160" preserveAspectRatio="none">
                            <!-- Price line -->
                            <polyline
                                id="priceLine"
                                fill="none"
                                stroke="#10B981"
                                stroke-width="3"
                                points="0,120 57,100 114,110 171,120 228,60 285,110 342,80 400,80"
                            />
                            
                            <!-- Data points will be dynamically generated -->
                            <g id="dataPoints">
                                <!-- Week 1 - Low point -->
                                <circle cx="0" cy="120" r="4" fill="#EF4444" stroke="white" stroke-width="2"/>
                                <!-- Week 2 -->
                                <circle cx="57" cy="100" r="3" fill="#10B981" stroke="white" stroke-width="2"/>
                                <!-- Week 3 -->
                                <circle cx="114" cy="110" r="3" fill="#10B981" stroke="white" stroke-width="2"/>
                                <!-- Week 4 -->
                                <circle cx="171" cy="120" r="3" fill="#10B981" stroke="white" stroke-width="2"/>
                                <!-- Week 5 - High point -->
                                <circle cx="228" cy="60" r="4" fill="#F59E0B" stroke="white" stroke-width="2"/>
                                <!-- Week 6 -->
                                <circle cx="285" cy="110" r="3" fill="#10B981" stroke="white" stroke-width="2"/>
                                <!-- Week 7 -->
                                <circle cx="342" cy="80" r="3" fill="#10B981" stroke="white" stroke-width="2"/>
                                <!-- Current Week - Current price -->
                                <circle cx="400" cy="80" r="5" fill="#3B82F6" stroke="white" stroke-width="3"/>
                            </g>
                        </svg>
                        
                        <!-- Price tooltips for key points -->
                        <div id="lowestTooltip" class="absolute" style="left: -2%; top: 70%;">
                            <div class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded shadow-lg">
                                <div class="font-semibold" id="lowestPrice">₹23.20</div>
                                <div class="text-xs">Lowest</div>
                            </div>
                        </div>
                        
                        <div id="highestTooltip" class="absolute" style="left: 55%; top: 30%;">
                            <div class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded shadow-lg">
                                <div class="font-semibold" id="highestPrice">₹26.80</div>
                                <div class="text-xs">Highest</div>
                            </div>
                        </div>
                        
                        <div id="currentTooltip" class="absolute" style="left: 95%; top: 45%;">
                            <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded shadow-lg">
                                <div class="font-semibold" id="currentPriceTooltip">₹25.00</div>
                                <div class="text-xs">Current</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- X-axis labels -->
                <div class="flex justify-between text-xs text-gray-500 ml-12">
                    <span>7W ago</span>
                    <span>6W ago</span>
                    <span>5W ago</span>
                    <span>4W ago</span>
                    <span>3W ago</span>
                    <span>2W ago</span>
                    <span>1W ago</span>
                    <span class="font-semibold text-blue-600">Now</span>
                </div>
                
                <!-- Loading indicator -->
                <div id="chartLoading" class="hidden text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                    <p class="mt-2 text-sm text-gray-500">Updating price data...</p>
                </div>
                
                <!-- Legend -->
                <div class="flex justify-center items-center space-x-6 mt-4 text-xs">
                    <div class="flex items-center space-x-1">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span class="text-gray-600">Lowest Price</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                        <span class="text-gray-600">Highest Price</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        <span class="text-gray-600">Current Price</span>
                    </div>
                </div>
            </div>

            <!-- Demand Indicator -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="demandIndicator">Demand Indicator</h2>
            <div class="demand-card rounded-lg p-6 mb-8">
                <p class="text-gray-600" data-translate="currentDemand">Current Demand</p>
                <p class="text-2xl font-bold text-green-700" data-translate="highDemand">High Demand</p>
            </div>

            <!-- Market comparison grid/table -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="mandiComparison">Mandi Comparison</h2>
            <div class="market-card p-6 mb-8">
                <div class="grid grid-cols-3 text-sm font-semibold text-gray-500 mb-4 px-4">
                    <span data-translate="market">Market</span>
                    <span class="text-center" data-translate="currentPrice">Current Price</span>
                    <span class="text-right" data-translate="changeLastWeek">Change (Last Week)</span>
                </div>
                <div id="marketComparison" class="space-y-2">
                    <div class="grid grid-cols-3 items-center bg-gray-50 rounded-lg p-4">
                        <span class="text-gray-800">Mumbai APMC</span>
                        <span class="text-center text-gray-800">₹24.50/<span data-translate="kg">kg</span></span>
                        <span class="text-right text-green-600">+2%</span>
                    </div>
                    <div class="grid grid-cols-3 items-center bg-gray-50 rounded-lg p-4">
                        <span class="text-gray-800">Pune APMC</span>
                        <span class="text-center text-gray-800">₹25.00/<span data-translate="kg">kg</span></span>
                        <span class="text-right text-green-600">+2%</span>
                    </div>
                    <div class="grid grid-cols-3 items-center bg-gray-50 rounded-lg p-4">
                        <span class="text-gray-800">Nashik APMC</span>
                        <span class="text-center text-gray-800">₹24.00/<span data-translate="kg">kg</span></span>
                        <span class="text-right text-red-600">-1%</span>
                    </div>
                    <div class="grid grid-cols-3 items-center bg-gray-50 rounded-lg p-4">
                        <span class="text-gray-800">Nagpur APMC</span>
                        <span class="text-center text-gray-800">₹25.50/<span data-translate="kg">kg</span></span>
                        <span class="text-right text-green-600">+4%</span>
                    </div>
                    <div class="grid grid-cols-3 items-center bg-gray-50 rounded-lg p-4">
                        <span class="text-gray-800">Aurangabad APMC</span>
                        <span class="text-center text-gray-800">₹26.00/<span data-translate="kg">kg</span></span>
                        <span class="text-right text-green-600">+5%</span>
                    </div>
                </div>
            </div>

            <!-- SmartSheti Insight -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="smartShetiInsight">SmartSheti Insight</h2>
            <div class="relative rounded-lg overflow-hidden mb-8 market-card">
                <img alt="Wheat field" class="w-full h-48 object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCPCPMureRsPuXoSWPnr7RJ8WGEYcZOmFfQe_S1AP1s5zeITOtSHibowsg5L9zXzZKdZb0TTYhilH6NwPRfWCYO1uL68AphaYIqwpN1XneFp7d1L8VOw-QfZd7bfOj2R4G89QDHDXQ3q8YWBaPaKFWwsAA4Q0aZEUcvSW0ptZll53dGTFdRnFYQxe-XalnqRnlKl16VoTuFE53Dy7bMC-j3ZsduzWjQ67V2lCo_AQUTpoJYXZe3J9cvfOFcXwX2mxEcORi-GP0LoAo"/>
                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-end p-6">
                    <p class="text-white text-lg" data-translate="marketInsightText">
                        Market conditions for wheat are currently favorable, with high demand and increasing prices across most markets. Consider selling within the next 2-3 weeks to maximize returns.
                    </p>
                </div>
            </div>

            <!-- Top 5 Demanded Veggies/Fruits -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4" data-translate="topDemandedVeggies">Top 5 Demanded Veggies/Fruits</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                <div class="market-card p-4 text-center">
                    <img alt="Tomatoes" class="h-16 w-16 mx-auto mb-2" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDni8F8z71BS-ZPRlkLFTprccr2eKhJkzRqRjn8RvHr0573hj8PN1BhxvzKcf-3SzuQhgTVMrM6q4kpKlWYKdlu8waxJG71uOuV4MAde74NUqaZyDMkervVvDJX-yi67rgUwrLaCKmUFQN4cSFYat7Yviao1WODmKEkb7A87HsVQqVdJ7ob7cN0XEBXS7_zSYEDbWHa0WFSCEb-O1khJaTWhrU6Ll4shZkcLsBiJMP79NPqGUK4hK0CGbGl6fjM2QubBohOY0g3PGw"/>
                    <p class="font-semibold text-gray-800" data-translate="tomatoes">Tomatoes</p>
                    <p class="text-sm text-gray-500" data-translate="veryHigh">Very High</p>
                </div>
                <div class="market-card p-4 text-center">
                    <img alt="Onions" class="h-16 w-16 mx-auto mb-2" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDI3USKAYbS93_aGrO7dFVL3sNSWxyTaNCTCMZdALu4JUITeA2sUAEjo4zA2miQ4WhH3h4M6zWKpxrXGdckpHLnLtkdW4isrGCnvL5cJye6a0OGVtrQ0Tnhy0S2lXwZDzeqbWMcyb7L8Lba6vGeKcZjarOugsJfDu3AZRbvBKqQqvfzhukZWTVzsaKEdgQsxl1mLXMgJO95ghp2NIzXREnD7W4luKr1AlcjKyOxMJP9MynsOk05M8WrK16coQQEldTs_yIH15JBfWQ"/>
                    <p class="font-semibold text-gray-800" data-translate="onions">Onions</p>
                    <p class="text-sm text-gray-500" data-translate="high">High</p>
                </div>
                <div class="market-card p-4 text-center">
                    <img alt="Potatoes" class="h-16 w-16 mx-auto mb-2" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAXjih5Ho2D7dXH0YUytI8RWUTUeGrd33wttUSuS4DIF0s9uGMJwTC7Z_Z770qpPMWP9dYbUZGVIeHC5eSVUFetCl3vDFPR96NkD2GvxK2FiUDrCq-fkJ_LSiZlUjkt2E48MZMIdBdAJxL4SMTUTjuYQSWk_nBSdOOM3Fxk20p7hTfgC-n5iw9icdLlZI5O3npp2j5CV_S70zq1oIOL6flHket-P6cOHKK4qeekAjDQQr3nULB438DhY7T5355kQsKHjuoACA5bbtI"/>
                    <p class="font-semibold text-gray-800" data-translate="potatoes">Potatoes</p>
                    <p class="text-sm text-gray-500" data-translate="high">High</p>
                </div>
                <div class="market-card p-4 text-center">
                    <img alt="Apples" class="h-16 w-16 mx-auto mb-2" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBUGcm0WR99Txqq0vVbqqwSFcGm1Cg0r8IWzj4sm_eyadus-e64eJochQQO-bSYP-42HXjQHFE8Am732BwSWiSSQVqjInRr8K_SK_kSrBReYpNhV4FjUSoyXA3Edsmq_uc9ODysgmHc4Ys6LoxkBLJsY3bRmSBJNcy-yvOpHSJVtzQ2Y7dk5SPS2OfGbj2-HEli42F4qxGWwsLSIs1DXcrlWr6Y2lmn-1idUMfeIUAvz1zLex7tKUuNaTkaYYbnFWNAtt29mZ2yPzU"/>
                    <p class="font-semibold text-gray-800" data-translate="apples">Apples</p>
                    <p class="text-sm text-gray-500" data-translate="medium">Medium</p>
                </div>
                <div class="market-card p-4 text-center">
                    <img alt="Bananas" class="h-16 w-16 mx-auto mb-2" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAxABvwOd-gMZ1IYV40EztCkGFp6_Vz-Ynu2aujmnsUP4MXWe6T4egWl4PPwMVSc2IFWoVvqCs35sNahqDqxuvArnkHkkHsMwdRw4s-Y-GLKDWZyZMAe1RFtOIY2cLrv36VRylJHfNXGeNrmEHsSuduM_2y7T4MHoD3JIhu7iBtk3O0edqVPy-ixMw64N1SEFn2yImAlX3pBDaTEJZiF4x1EcezF9o1j55GOmW9dGbXPpCWsDLME5DjgBNSn8PlM3Dt8lWgBwr28NY"/>
                    <p class="font-semibold text-gray-800" data-translate="bananas">Bananas</p>
                    <p class="text-sm text-gray-500" data-translate="medium">Medium</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Enhanced Python-inspired Price Generator
        class PythonStylePriceGenerator {
            constructor() {
                // Base prices for different crops (in INR per quintal)
                this.basePrices = {
                    'wheat': 2500, 'rice': 3200, 'cotton': 5800, 
                    'sugarcane': 280, 'tomato': 2800, 'onion': 1800, 
                    'potato': 1200, 'mango': 4500, 'banana': 1500, 'apple': 8000
                };

                // Market multipliers for different APMCs
                this.marketMultipliers = {
                    'Mumbai APMC': 1.1,    // Higher prices in Mumbai
                    'Pune APMC': 1.0,      // Base price
                    'Nashik APMC': 0.95,   // Slightly lower
                    'Nagpur APMC': 1.05,   // Moderate
                    'Aurangabad APMC': 1.08 // Higher
                };

                // Crop volatility factors
                this.volatilityMap = {
                    'tomato': 0.25, 'onion': 0.20, 'potato': 0.15, 
                    'rice': 0.10, 'wheat': 0.08, 'cotton': 0.12,
                    'sugarcane': 0.06, 'mango': 0.18, 'banana': 0.12, 'apple': 0.14
                };

                // Trend factors
                this.trendMap = {
                    'tomato': 0.05, 'onion': -0.03, 'potato': 0.02, 
                    'rice': 0.04, 'wheat': 0.06, 'cotton': -0.02,
                    'sugarcane': 0.03, 'mango': 0.08, 'banana': 0.01, 'apple': 0.025
                };
            }

            // Generate realistic price data
            generatePriceData(crop, state, market) {
                try {
                    // Calculate base price
                    const basePrice = this.basePrices[crop.toLowerCase()] || 2500;
                    const marketMultiplier = this.marketMultipliers[market] || 1.0;
                    const volatility = this.volatilityMap[crop.toLowerCase()] || 0.12;
                    const trend = this.trendMap[crop.toLowerCase()] || 0.02;

                    // Add realistic market variation
                    const variation = (Math.random() - 0.5) * volatility * 2;
                    const currentPriceQuintal = Math.round(basePrice * marketMultiplier * (1 + variation));
                    
                    // Convert from quintal to kg (1 quintal = 100 kg)
                    const currentPrice = Math.round((currentPriceQuintal / 100) * 100) / 100; // Round to 2 decimal places

                    // Generate 8 weeks of historical data
                    const historicalPrices = this.generateHistoricalPrices(currentPrice, volatility, trend, 8);

                    // Calculate change percentage
                    const previousPrice = historicalPrices[historicalPrices.length - 2];
                    const changePercent = ((currentPrice - previousPrice) / previousPrice) * 100;
                    const changeStr = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%`;

                    // Generate market comparison
                    const marketComparison = this.generateMarketComparison(crop, state, basePrice);

                    const result = {
                        success: true,
                        crop: crop,
                        state: state,
                        market: market,
                        current_price: currentPrice,
                        change_percentage: changeStr,
                        historical_prices: historicalPrices,
                        market_comparison: marketComparison,
                        timestamp: new Date().toISOString(),
                        source: 'PYTHON_SIMULATION'
                    };

                    return result;

                } catch (error) {
                    throw error;
                }
            }

            // Generate historical prices using Python-style algorithm
            generateHistoricalPrices(currentPrice, volatility, trend, weeks) {
                const prices = [];
                
                for (let i = weeks - 1; i >= 0; i--) {
                    if (i === 0) {
                        prices.push(currentPrice);
                    } else {
                        // Apply reverse trend (convert to per kg basis)
                        const trendEffect = trend * i * (currentPrice * 100) / 100; // Keep trend proportional
                        
                        // Box-Muller transform for normal distribution
                        const u1 = Math.random();
                        const u2 = Math.random();
                        const randomNormal = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                        const volatilityEffect = randomNormal * volatility * (currentPrice * 100) * 0.5 / 100;
                        
                        // Seasonal patterns
                        const seasonalEffect = Math.sin(i * 0.5) * (volatility * 0.3 * (currentPrice * 100)) / 100;
                        
                        let historicalPrice = currentPrice - trendEffect + volatilityEffect + seasonalEffect;
                        
                        // Ensure reasonable bounds (for per kg prices)
                        const minBound = currentPrice * 0.6;
                        const maxBound = currentPrice * 1.4;
                        historicalPrice = Math.max(minBound, Math.min(maxBound, historicalPrice));
                        
                        prices.push(Math.round(historicalPrice * 100) / 100); // Round to 2 decimal places
                    }
                }
                
                return prices;
            }

            // Generate market comparison data
            generateMarketComparison(crop, state, basePrice) {
                const markets = ['Mumbai APMC', 'Pune APMC', 'Nashik APMC', 'Nagpur APMC', 'Aurangabad APMC'];
                return markets.map(market => {
                    const multiplier = this.marketMultipliers[market] || 1.0;
                    const variation = (Math.random() - 0.5) * 0.1;
                    const priceQuintal = Math.round(basePrice * multiplier * (1 + variation));
                    const price = Math.round((priceQuintal / 100) * 100) / 100; // Convert to per kg and round to 2 decimal places
                    
                    const changePercent = (Math.random() - 0.4) * 10;
                    const changeStr = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(0)}%`;
                    
                    return {
                        market: market,
                        price: price,
                        change: changeStr
                    };
                });
            }
        }

        // Chart renderer
        class ChartRenderer {
            constructor() {
                this.chartContainer = document.getElementById('priceChart');
                this.priceLine = document.getElementById('priceLine');
                this.dataPoints = document.getElementById('dataPoints');
                this.loading = document.getElementById('chartLoading');
            }

            renderChart(priceData) {
                try {
                    const prices = priceData.historical_prices;
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const range = maxPrice - minPrice;
                    const padding = range * 0.1;
                    
                    const chartMin = Math.floor(minPrice - padding);
                    const chartMax = Math.ceil(maxPrice + padding);
                    const chartRange = chartMax - chartMin;

                    // Update Y-axis labels
                    document.getElementById('maxPrice').textContent = `₹${chartMax.toFixed(2)}`;
                    document.getElementById('highPrice').textContent = `₹${(chartMax - chartRange * 0.25).toFixed(2)}`;
                    document.getElementById('midPrice').textContent = `₹${(chartMax - chartRange * 0.5).toFixed(2)}`;
                    document.getElementById('lowPrice').textContent = `₹${(chartMax - chartRange * 0.75).toFixed(2)}`;
                    document.getElementById('minPrice').textContent = `₹${chartMin.toFixed(2)}`;

                    // Generate SVG points
                    const svgPoints = prices.map((price, index) => {
                        const x = (index / (prices.length - 1)) * 400;
                        const y = 160 - ((price - chartMin) / chartRange) * 160;
                        return `${x},${y}`;
                    }).join(' ');

                    // Update price line
                    this.priceLine.setAttribute('points', svgPoints);

                    // Clear and regenerate data points
                    this.dataPoints.innerHTML = '';
                    
                    prices.forEach((price, index) => {
                        const x = (index / (prices.length - 1)) * 400;
                        const y = 160 - ((price - chartMin) / chartRange) * 160;
                        
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', y);
                        circle.setAttribute('stroke', 'white');
                        circle.setAttribute('stroke-width', '2');
                        
                        if (price === minPrice) {
                            circle.setAttribute('r', '4');
                            circle.setAttribute('fill', '#EF4444');
                        } else if (price === maxPrice) {
                            circle.setAttribute('r', '4');
                            circle.setAttribute('fill', '#F59E0B');
                        } else if (index === prices.length - 1) {
                            circle.setAttribute('r', '5');
                            circle.setAttribute('fill', '#3B82F6');
                            circle.setAttribute('stroke-width', '3');
                        } else {
                            circle.setAttribute('r', '3');
                            circle.setAttribute('fill', '#10B981');
                        }
                        
                        this.dataPoints.appendChild(circle);
                    });

                    // Update tooltips
                    document.getElementById('lowestPrice').textContent = `₹${minPrice.toFixed(2)}`;
                    document.getElementById('highestPrice').textContent = `₹${maxPrice.toFixed(2)}`;
                    document.getElementById('currentPriceTooltip').textContent = `₹${prices[prices.length - 1].toFixed(2)}`;

                    // Show tooltips
                    document.getElementById('lowestTooltip').classList.remove('hidden');
                    document.getElementById('highestTooltip').classList.remove('hidden');
                    document.getElementById('currentTooltip').classList.remove('hidden');
                    
                } catch (error) {
                }
            }

            updateMainPriceDisplay(price, change) {
                const priceElement = document.querySelector('.text-4xl.font-bold.text-gray-800');
                if (priceElement) {
                    priceElement.innerHTML = `₹${price.toFixed(2)}/<span data-translate="kg">kg</span>`;
                }
                
                const changeElement = document.querySelector('.text-sm.font-semibold');
                if (changeElement) {
                    const isPositive = change.includes('+');
                    changeElement.className = `text-sm font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}`;
                    changeElement.textContent = change;
                }
            }

            updateMarketComparison(marketData) {
                const container = document.getElementById('marketComparison');
                if (!container) return;
                
                container.innerHTML = '';
                
                marketData.forEach(market => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-3 items-center bg-gray-50 rounded-lg p-4';
                    
                    const isPositive = market.change.includes('+');
                    row.innerHTML = `
                        <span class="text-gray-800">${market.market}</span>
                        <span class="text-center text-gray-800">₹${market.price.toFixed(2)}/<span data-translate="kg">kg</span></span>
                        <span class="text-right font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}">${market.change}</span>
                    `;
                    
                    container.appendChild(row);
                });
            }

            showLoading() {
                if (this.loading) {
                    this.loading.classList.remove('hidden');
                }
                if (this.chartContainer) {
                    this.chartContainer.style.opacity = '0.5';
                }
            }

            hideLoading() {
                if (this.loading) {
                    this.loading.classList.add('hidden');
                }
                if (this.chartContainer) {
                    this.chartContainer.style.opacity = '1';
                }
            }
        }

        // Initialize application
        let priceGenerator;
        let chartRenderer;

        function updateChart() {
            const crop = document.getElementById('cropSelect').value;
            const state = document.getElementById('stateSelect').value;
            const market = document.getElementById('marketSelect').value;
            
            try {
                chartRenderer.showLoading();
                
                // Update crop name display
                const cropNameElement = document.querySelector('[data-translate="wheat"]');
                if (cropNameElement) {
                    cropNameElement.textContent = crop.charAt(0).toUpperCase() + crop.slice(1);
                }
                
                // Generate price data
                const priceData = priceGenerator.generatePriceData(crop, state, market);
                
                // Update displays
                chartRenderer.updateMainPriceDisplay(priceData.current_price, priceData.change_percentage);
                chartRenderer.renderChart(priceData);
                chartRenderer.updateMarketComparison(priceData.market_comparison);
                
                setTimeout(() => chartRenderer.hideLoading(), 500);
                
            } catch (error) {
                chartRenderer.hideLoading();
            }
        }

        // Translation functionality
        function translatePage() {
            const currentLang = localStorage.getItem('language') || 'en';
            document.getElementById('currentLang').textContent = currentLang.toUpperCase();
            
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLang] && translations[currentLang][key]) {
                    element.textContent = translations[currentLang][key];
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Initialize components
                priceGenerator = new PythonStylePriceGenerator();
                chartRenderer = new ChartRenderer();
                
                // Set up event listeners
                document.getElementById('cropSelect').addEventListener('change', updateChart);
                document.getElementById('stateSelect').addEventListener('change', updateChart);
                document.getElementById('marketSelect').addEventListener('change', updateChart);
                
                // Set up translation functionality
                const translateBtn = document.getElementById('translateBtn');
                const languageDropdown = document.getElementById('languageDropdown');
                
                if (translateBtn && languageDropdown) {
                    translateBtn.addEventListener('click', () => {
                        languageDropdown.classList.toggle('hidden');
                    });
                    
                    languageDropdown.addEventListener('click', (e) => {
                        if (e.target.getAttribute('data-lang')) {
                            const lang = e.target.getAttribute('data-lang');
                            localStorage.setItem('language', lang);
                            translatePage();
                            languageDropdown.classList.add('hidden');
                        }
                    });
                    
                    // Initial translation
                    translatePage();
                }
                
                // Set up profile dropdown
                const profileBtn = document.getElementById('profileBtn');
                const profileDropdown = document.getElementById('profileDropdown');
                
                if (profileBtn && profileDropdown) {
                    profileBtn.addEventListener('click', () => {
                        profileDropdown.classList.toggle('hidden');
                    });
                }
                
                // Initial chart load
                updateChart();
                
            } catch (error) {
                console.error('Initialization error:', error.message);
            }
        });
    </script>
</body>
</html>
