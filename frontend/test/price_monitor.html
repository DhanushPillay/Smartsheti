<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSheti - Dynamic Price Monitor</title>
    
    <link rel="stylesheet" href="../css/price_monitor.css"/>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¾ SmartSheti Dynamic Price Monitor</h1>
            <p>Real-time Agricultural Market Intelligence</p>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>ğŸ“Š Current Wheat Price</h3>
                <div id="wheatPrice" class="price-display">Loading...</div>
                <div id="wheatChange" class="price-change">Calculating...</div>
                <p><strong>Source:</strong> <span id="dataSource">AGMARKNET</span></p>
                <p><strong>Last Updated:</strong> <span id="lastUpdated">Loading...</span></p>
            </div>

            <div class="status-card">
                <h3>ğŸŒ¾ Market Status</h3>
                <div id="marketStatus">Checking...</div>
                <p><strong>API Status:</strong> <span id="apiStatus">Connecting...</span></p>
                <p><strong>Auto-Update:</strong> <span id="autoUpdate">Checking...</span></p>
            </div>

            <div class="status-card">
                <h3>ğŸ“ˆ Recent Changes</h3>
                <div id="recentChanges">Loading data...</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-success" onclick="updatePrices()">ğŸ”„ Update Prices Now</button>
            <button class="btn" onclick="openMainGraph()">ğŸ“Š Open Main Graph</button>
            <button class="btn" onclick="toggleAutoRefresh()">âš¡ Toggle Auto-Refresh</button>
        </div>

        <div class="log">
            <h3>ğŸ“ Activity Log</h3>
            <div id="activityLog"></div>
        </div>
    </div>

    <script>
        let previousPrices = {};
        let autoRefreshInterval = null;
        let autoRefreshEnabled = false;

        // Activity logging
        function addLogEntry(message) {
            const log = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 20 entries
            while (log.children.length > 20) {
                log.removeChild(log.lastChild);
            }
        }

        // Check API status
        async function checkAPIStatus() {
            try {
                const response = await fetch('http://localhost:5001/api/status');
                const data = await response.json();
                
                document.getElementById('apiStatus').textContent = 'Connected âœ…';
                document.getElementById('autoUpdate').textContent = data.auto_update_running ? 'Running âœ…' : 'Stopped â¸ï¸';
                
                addLogEntry('âœ… API connection successful');
                return true;
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Disconnected âŒ';
                document.getElementById('autoUpdate').textContent = 'Unknown â“';
                addLogEntry('âŒ API connection failed');
                return false;
            }
        }

        // Load current prices
        async function loadPrices() {
            try {
                const response = await fetch('prices.json');
                const data = await response.json();
                
                const wheat = data.wheat;
                const currentPrice = wheat.data[wheat.data.length - 1];
                const previousPrice = wheat.data[wheat.data.length - 2] || currentPrice;
                
                // Update wheat price display
                document.getElementById('wheatPrice').textContent = `â‚¹${currentPrice.toFixed(2)}`;
                document.getElementById('dataSource').textContent = data.source || 'AGMARKNET';
                document.getElementById('lastUpdated').textContent = new Date(data.lastUpdated).toLocaleString();
                
                // Calculate and display price change
                const change = currentPrice - previousPrice;
                const changePercent = ((change / previousPrice) * 100).toFixed(2);
                const changeElement = document.getElementById('wheatChange');
                
                if (change > 0) {
                    changeElement.className = 'price-change price-up';
                    changeElement.textContent = `â†—ï¸ +â‚¹${change.toFixed(2)} (+${changePercent}%)`;
                } else if (change < 0) {
                    changeElement.className = 'price-change price-down';
                    changeElement.textContent = `â†˜ï¸ â‚¹${change.toFixed(2)} (${changePercent}%)`;
                } else {
                    changeElement.className = 'price-change price-stable';
                    changeElement.textContent = `â¡ï¸ No change (${changePercent}%)`;
                }

                // Check if price actually changed
                if (previousPrices.wheat && previousPrices.wheat !== currentPrice) {
                    addLogEntry(`ğŸ“ˆ Wheat price updated: â‚¹${previousPrices.wheat.toFixed(2)} â†’ â‚¹${currentPrice.toFixed(2)}`);
                    
                    // Flash the price to show it changed
                    document.getElementById('wheatPrice').classList.add('updating');
                    setTimeout(() => {
                        document.getElementById('wheatPrice').classList.remove('updating');
                    }, 2000);
                }
                
                previousPrices.wheat = currentPrice;
                
                // Update market status
                document.getElementById('marketStatus').innerHTML = `
                    <p>ğŸ“Š ${Object.keys(data).length - 3} crops tracked</p>
                    <p>ğŸ•’ Updates every minute</p>
                    <p>ğŸ“¡ AGMARKNET integration active</p>
                `;
                
                // Show recent changes for all crops
                let recentChangesHtml = '';
                for (const [crop, info] of Object.entries(data)) {
                    if (typeof info === 'object' && info.data) {
                        const current = info.data[info.data.length - 1];
                        const previous = info.data[info.data.length - 2] || current;
                        const change = current - previous;
                        const symbol = change > 0 ? 'ğŸ“ˆ' : change < 0 ? 'ğŸ“‰' : 'â¡ï¸';
                        recentChangesHtml += `<p>${symbol} ${crop}: â‚¹${current.toFixed(2)}</p>`;
                    }
                }
                document.getElementById('recentChanges').innerHTML = recentChangesHtml;
                
            } catch (error) {
                addLogEntry('âŒ Failed to load price data');
                console.error('Error loading prices:', error);
            }
        }

        // Update prices via API
        async function updatePrices() {
            addLogEntry('ğŸ”„ Triggering price update...');
            document.getElementById('wheatPrice').classList.add('updating');
            
            try {
                const response = await fetch('http://localhost:5001/api/update-prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                if (result.success) {
                    addLogEntry('âœ… Price update successful');
                    setTimeout(() => loadPrices(), 1000); // Wait a bit then reload
                } else {
                    addLogEntry('âŒ Price update failed');
                }
            } catch (error) {
                addLogEntry('âŒ Price update error');
            }
            
            setTimeout(() => {
                document.getElementById('wheatPrice').classList.remove('updating');
            }, 2000);
        }

        // Open main graph
        function openMainGraph() {
            window.open('crop_price_trends.html', '_blank');
            addLogEntry('ğŸ“Š Opened main graph interface');
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            if (autoRefreshEnabled) {
                clearInterval(autoRefreshInterval);
                autoRefreshEnabled = false;
                addLogEntry('â¸ï¸ Auto-refresh disabled');
            } else {
                autoRefreshInterval = setInterval(loadPrices, 10000); // Every 10 seconds for demo
                autoRefreshEnabled = true;
                addLogEntry('â–¶ï¸ Auto-refresh enabled (10s intervals)');
            }
        }

        // Initialize
        async function initialize() {
            addLogEntry('ğŸš€ Initializing SmartSheti Price Monitor...');
            
            await checkAPIStatus();
            await loadPrices();
            
            // Start auto-refresh by default
            toggleAutoRefresh();
            
            addLogEntry('âœ… Initialization complete');
        }

        // Start the application
        initialize();
    </script>
</body>
</html>
